<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACERTIVE • Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --gold: #D4AF37;
            --gold-dark: #AA8C2C;
            --dark: #0d0d0d;
            --dark-card: #141414;
            --dark-lighter: #1c1c1c;
            --dark-border: #2a2a2a;
            --text: #ffffff;
            --text-muted: #888;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --cyan: #06b6d4;
            --purple: #a855f7;
        }
        body { font-family: 'Inter', sans-serif; background: var(--dark); min-height: 100vh; color: var(--text); }
        
        /* SIDEBAR */
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: var(--dark-card); border-right: 1px solid var(--dark-border); display: flex; flex-direction: column; z-index: 1000; }
        .logo { padding: 20px; display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; background: var(--gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; color: var(--dark); }
        .logo-text { font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; }
        .logo-text span:first-child { color: var(--text); }
        .logo-text span:last-child { color: var(--gold); }
        
        .nav-container { flex: 1; overflow-y: auto; padding: 10px 0; }
        .nav-section { padding: 0 12px; margin-bottom: 5px; }
        .nav-section-title { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); padding: 15px 15px 8px; font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 15px; color: var(--text-muted); text-decoration: none; border-radius: 8px; margin: 2px 0; transition: all 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: var(--dark-lighter); color: var(--text); }
        .nav-item.active { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: var(--dark); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; font-size: 0.95rem; }
        
        .user-section { padding: 15px; border-top: 1px solid var(--dark-border); display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; background: var(--gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: var(--dark); }
        .user-info { flex: 1; }
        .user-name { font-size: 0.85rem; font-weight: 600; color: var(--text); }
        .user-role { font-size: 0.75rem; color: var(--text-muted); }
        .user-logout { color: var(--text-muted); cursor: pointer; padding: 5px; }
        .user-logout:hover { color: var(--danger); }
        
        /* MAIN */
        .main-content { margin-left: 250px; padding: 25px 30px; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 1.3rem; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .page-title i { color: var(--gold); }
        .header-actions { display: flex; gap: 10px; }
        
        /* STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
        .stat-card.highlight { border-color: var(--gold); }
        .stat-card .icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-bottom: 12px; }
        .stat-card .icon.green { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .stat-card .icon.red { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .stat-card .icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .stat-card .icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .stat-card .icon.purple { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .stat-card .icon.cyan { background: rgba(6, 182, 212, 0.15); color: var(--cyan); }
        .stat-card .icon.gold { background: rgba(212, 175, 55, 0.15); color: var(--gold); }
        .stat-card .label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; color: var(--text); }
        .stat-card .value.green { color: var(--success); }
        .stat-card .value.red { color: var(--danger); }
        .stat-card .subtext { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; }
        .stat-card .trend { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; font-weight: 600; }
        .stat-card .trend.up { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .stat-card .trend.down { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        
        /* FILTERS */
        .filters-bar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 0.8rem; color: var(--text-muted); }
        .filter-select, .filter-input { padding: 10px 14px; background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 8px; color: var(--text); font-size: 0.85rem; }
        .filter-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23888' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 18px; padding-right: 35px; }
        .filter-select:focus, .filter-input:focus { outline: none; border-color: var(--gold); }
        .filter-select option { background: var(--dark-card); }
        
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: var(--dark); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--dark-border); }
        .btn-secondary:hover { border-color: var(--gold); color: var(--gold); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* TABS */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: var(--dark-card); padding: 5px; border-radius: 10px; border: 1px solid var(--dark-border); width: fit-content; }
        .tab { padding: 10px 20px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--text-muted); }
        .tab:hover { color: var(--text); }
        .tab.active { background: var(--gold); color: var(--dark); font-weight: 600; }
        
        /* TABLE */
        .table-container { background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 12px; overflow: hidden; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--dark-border); }
        .table-title { font-size: 0.95rem; font-weight: 600; }
        .table-count { font-size: 0.8rem; color: var(--text-muted); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--dark-lighter); }
        th { padding: 12px 15px; text-align: left; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--dark-border); font-size: 0.85rem; vertical-align: middle; }
        tr:hover { background: rgba(255,255,255,0.02); }
        tr:last-child td { border-bottom: none; }
        
        .client-cell { display: flex; align-items: center; gap: 10px; }
        .client-avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; background: rgba(212, 175, 55, 0.2); color: var(--gold); }
        .client-info .name { font-weight: 600; color: var(--text); font-size: 0.85rem; }
        .client-info .doc { font-size: 0.7rem; color: var(--text-muted); }
        
        .value-positive { color: var(--success); font-weight: 600; }
        .value-negative { color: var(--danger); font-weight: 600; }
        .value-pending { color: var(--warning); font-weight: 600; }
        
        .badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge-success::before { content: ''; width: 6px; height: 6px; background: var(--success); border-radius: 50%; }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge-warning::before { content: ''; width: 6px; height: 6px; background: var(--warning); border-radius: 50%; }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-danger::before { content: ''; width: 6px; height: 6px; background: var(--danger); border-radius: 50%; }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .badge-info::before { content: ''; width: 6px; height: 6px; background: var(--info); border-radius: 50%; }
        
        .actions { display: flex; gap: 6px; }
        .btn-icon { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.8rem; background: var(--dark-lighter); color: var(--text-muted); }
        .btn-icon:hover { color: var(--text); }
        .btn-icon.success:hover { color: var(--success); }
        .btn-icon.danger:hover { color: var(--danger); }
        
        /* CARDS GRID */
        .cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
        .info-card { background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 12px; padding: 20px; }
        .info-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .info-card-title { font-size: 0.9rem; font-weight: 600; color: var(--text); }
        .info-card-action { font-size: 0.8rem; color: var(--gold); cursor: pointer; }
        .info-card-action:hover { text-decoration: underline; }
        
        .transaction-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--dark-border); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .transaction-icon.income { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .transaction-icon.expense { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .transaction-info { flex: 1; }
        .transaction-desc { font-size: 0.85rem; color: var(--text); margin-bottom: 2px; }
        .transaction-date { font-size: 0.75rem; color: var(--text-muted); }
        .transaction-value { font-weight: 600; font-size: 0.9rem; }
        .transaction-value.positive { color: var(--success); }
        .transaction-value.negative { color: var(--danger); }
        
        /* EMPTY & LOADING */
        .empty-state { text-align: center; padding: 50px 20px; }
        .empty-state i { font-size: 2.5rem; color: var(--dark-border); margin-bottom: 12px; }
        .empty-state h3 { color: var(--text); margin-bottom: 6px; font-size: 1rem; }
        .empty-state p { color: var(--text-muted); font-size: 0.85rem; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--gold); }
        .loading i { font-size: 1.8rem; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* TOAST */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast { background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 8px; padding: 12px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; min-width: 260px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast i { font-size: 1rem; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        
        /* RESPONSIVE */
        @media (max-width: 1400px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1024px) { .sidebar { display: none; } .main-content { margin-left: 0; } .cards-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .filters-bar { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">A</div>
            <div class="logo-text"><span>ACERT</span><span>IVE</span></div>
        </div>
        <div class="nav-container">
            <nav class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a href="/dashboard" class="nav-item"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
                <a href="/fila-cobranca" class="nav-item"><i class="fas fa-layer-group"></i><span>Fila de Cobrança</span></a>
                <a href="/atendimento" class="nav-item"><i class="fas fa-headset"></i><span>Atendimento</span></a>
            </nav>
            <nav class="nav-section">
                <div class="nav-section-title">Cadastros</div>
                <a href="/credores" class="nav-item"><i class="fas fa-building"></i><span>Credores</span></a>
                <a href="/clientes" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
                <a href="/cobrancas" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>Cobranças</span></a>
            </nav>
            <nav class="nav-section">
                <div class="nav-section-title">Negociação</div>
                <a href="/acordos" class="nav-item"><i class="fas fa-handshake"></i><span>Acordos</span></a>
                <a href="/parcelas" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Parcelas</span></a>
                <a href="/simulador" class="nav-item"><i class="fas fa-calculator"></i><span>Simulador</span></a>
            </nav>
            <nav class="nav-section">
                <div class="nav-section-title">Financeiro</div>
                <a href="/financeiro" class="nav-item active"><i class="fas fa-wallet"></i><span>Financeiro</span></a>
                <a href="/comissoes" class="nav-item"><i class="fas fa-percentage"></i><span>Comissões</span></a>
                <a href="/repasses" class="nav-item"><i class="fas fa-exchange-alt"></i><span>Repasses</span></a>
            </nav>
            <nav class="nav-section">
                <div class="nav-section-title">Sistema</div>
                <a href="/configuracoes" class="nav-item"><i class="fas fa-cog"></i><span>Configurações</span></a>
                <a href="/usuarios" class="nav-item"><i class="fas fa-user-cog"></i><span>Usuários</span></a>
            </nav>
        </div>
        <div class="user-section">
            <div class="user-avatar">A</div>
            <div class="user-info">
                <div class="user-name">Administrador</div>
                <div class="user-role">Administrador</div>
            </div>
            <i class="fas fa-sign-out-alt user-logout" onclick="logout()" title="Sair"></i>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-wallet"></i> Financeiro</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportarRelatorio()"><i class="fas fa-download"></i> Exportar</button>
                <button class="btn btn-primary" onclick="novaTransacao()"><i class="fas fa-plus"></i> Nova Entrada</button>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <span class="trend up">↑ 12%</span>
                <div class="icon green"><i class="fas fa-arrow-down"></i></div>
                <div class="label">Recebido (Mês)</div>
                <div class="value green" id="recebidoMes">R$ 0,00</div>
                <div class="subtext" id="qtdRecebido">0 pagamentos</div>
            </div>
            <div class="stat-card">
                <div class="icon orange"><i class="fas fa-clock"></i></div>
                <div class="label">A Receber</div>
                <div class="value" id="aReceber">R$ 0,00</div>
                <div class="subtext" id="qtdAReceber">0 cobranças pendentes</div>
            </div>
            <div class="stat-card">
                <div class="icon red"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="label">Vencido</div>
                <div class="value red" id="vencido">R$ 0,00</div>
                <div class="subtext" id="qtdVencido">0 cobranças vencidas</div>
            </div>
            <div class="stat-card">
                <div class="icon purple"><i class="fas fa-hand-holding-usd"></i></div>
                <div class="label">Comissões (Mês)</div>
                <div class="value" id="comissoesMes">R$ 0,00</div>
                <div class="subtext" id="qtdComissoes">0 credores</div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="filters-bar">
            <div class="filter-group">
                <label>Período:</label>
                <select class="filter-select" id="filterPeriodo">
                    <option value="mes">Este Mês</option>
                    <option value="semana">Esta Semana</option>
                    <option value="hoje">Hoje</option>
                    <option value="trimestre">Trimestre</option>
                    <option value="ano">Este Ano</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            <div class="filter-group" id="customDateGroup" style="display: none;">
                <input type="date" class="filter-input" id="dataInicio">
                <span style="color: var(--text-muted);">até</span>
                <input type="date" class="filter-input" id="dataFim">
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select class="filter-select" id="filterStatus">
                    <option value="">Todos</option>
                    <option value="pago">Pagos</option>
                    <option value="pendente">Pendentes</option>
                    <option value="vencido">Vencidos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Credor:</label>
                <select class="filter-select" id="filterCredor">
                    <option value="">Todos os Credores</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Filtrar</button>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" data-tab="pagamentos">Pagamentos</div>
            <div class="tab" data-tab="pendentes">Pendentes</div>
            <div class="tab" data-tab="vencidos">Vencidos</div>
        </div>

        <!-- TABLE -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">Movimentações Financeiras</div>
                <div class="table-count" id="tableCount">0 registros</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Descrição</th>
                        <th>Vencimento</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Forma Pgto</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="financeiroTable">
                    <tr><td colspan="7"><div class="loading"><i class="fas fa-spinner"></i></div></td></tr>
                </tbody>
            </table>
        </div>

        <!-- CARDS RESUMO -->
        <div class="cards-grid" style="margin-top: 25px;">
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-card-title"><i class="fas fa-history"></i> Últimos Pagamentos</div>
                    <div class="info-card-action" onclick="verTodosPagamentos()">Ver todos →</div>
                </div>
                <div id="ultimosPagamentos">
                    <div class="empty-state" style="padding: 20px;">
                        <p>Nenhum pagamento recente</p>
                    </div>
                </div>
            </div>
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-card-title"><i class="fas fa-chart-line"></i> Resumo por Credor</div>
                    <div class="info-card-action" onclick="verRelatorioCredores()">Ver relatório →</div>
                </div>
                <div id="resumoCredores">
                    <div class="empty-state" style="padding: 20px;">
                        <p>Nenhum dado disponível</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_URL = '';
        let currentTab = 'pagamentos';

        function getToken() { return localStorage.getItem('token'); }
        function verificarAuth() { if (!getToken()) { window.location.href = '/login'; return false; } return true; }
        function logout() { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/login'; }

        function showToast(msg, type = 'success') {
            const c = document.getElementById('toastContainer'), t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check' : 'times') + '-circle"></i><span>' + msg + '</span>';
            c.appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('pt-BR') : '-'; }
        function getInitials(name) { if (!name) return '??'; const parts = name.trim().split(' '); return parts.length > 1 ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase(); }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                carregarDados();
            });
        });

        // Período custom
        document.getElementById('filterPeriodo').addEventListener('change', (e) => {
            document.getElementById('customDateGroup').style.display = e.target.value === 'custom' ? 'flex' : 'none';
        });

        async function carregarDados() {
            if (!verificarAuth()) return;
            await Promise.all([carregarEstatisticas(), carregarMovimentacoes(), carregarCredores(), carregarUltimosPagamentos()]);
        }

        async function carregarEstatisticas() {
            try {
                const res = await fetch(API_URL + '/api/financeiro/estatisticas', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (!res.ok) return;
                const data = await res.json();
                if (data.success && data.data) {
                    const s = data.data;
                    document.getElementById('recebidoMes').textContent = formatCurrency(s.recebido_mes || 0);
                    document.getElementById('qtdRecebido').textContent = (s.qtd_recebido || 0) + ' pagamentos';
                    document.getElementById('aReceber').textContent = formatCurrency(s.a_receber || 0);
                    document.getElementById('qtdAReceber').textContent = (s.qtd_a_receber || 0) + ' cobranças pendentes';
                    document.getElementById('vencido').textContent = formatCurrency(s.vencido || 0);
                    document.getElementById('qtdVencido').textContent = (s.qtd_vencido || 0) + ' cobranças vencidas';
                    document.getElementById('comissoesMes').textContent = formatCurrency(s.comissoes_mes || 0);
                    document.getElementById('qtdComissoes').textContent = (s.qtd_credores || 0) + ' credores';
                }
            } catch (e) { console.error('Erro estatísticas:', e); }
        }

        async function carregarMovimentacoes() {
            try {
                const status = currentTab === 'pagamentos' ? 'pago' : currentTab === 'pendentes' ? 'pendente' : 'vencido';
                const periodo = document.getElementById('filterPeriodo').value;
                const filterStatus = document.getElementById('filterStatus').value;
                const credor = document.getElementById('filterCredor').value;
                
                let url = API_URL + '/api/financeiro/movimentacoes?status=' + (filterStatus || status);
                if (credor) url += '&credor_id=' + credor;
                
                const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                const data = await res.json();
                
                const lista = data.data || data || [];
                renderMovimentacoes(lista);
                document.getElementById('tableCount').textContent = lista.length + ' registros';
            } catch (e) { 
                console.error('Erro movimentações:', e);
                renderMovimentacoes([]);
            }
        }

        function renderMovimentacoes(lista) {
            const tbody = document.getElementById('financeiroTable');
            if (!lista || !lista.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-inbox"></i><h3>Nenhuma movimentação encontrada</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = lista.map(m => {
                const statusClass = { 'pago': 'badge-success', 'pendente': 'badge-warning', 'vencido': 'badge-danger' }[m.status] || 'badge-info';
                const statusLabel = { 'pago': 'Pago', 'pendente': 'Pendente', 'vencido': 'Vencido' }[m.status] || m.status;
                const valorClass = m.status === 'pago' ? 'value-positive' : m.status === 'vencido' ? 'value-negative' : 'value-pending';
                return `<tr>
                    <td><div class="client-cell"><div class="client-avatar">${getInitials(m.cliente_nome)}</div><div class="client-info"><div class="name">${m.cliente_nome || '-'}</div><div class="doc">${m.cliente_cpf || ''}</div></div></div></td>
                    <td>${m.descricao || 'Cobrança'}</td>
                    <td>${formatDate(m.data_vencimento)}</td>
                    <td class="${valorClass}">${formatCurrency(m.valor || m.valor_atualizado)}</td>
                    <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                    <td>${m.forma_pagamento || '-'}</td>
                    <td><div class="actions">
                        <button class="btn-icon" onclick="verDetalhes('${m.id}')" title="Ver"><i class="fas fa-eye"></i></button>
                        ${m.status !== 'pago' ? `<button class="btn-icon success" onclick="registrarPagamento('${m.id}')" title="Registrar Pagamento"><i class="fas fa-check"></i></button>` : ''}
                    </div></td>
                </tr>`;
            }).join('');
        }

        async function carregarCredores() {
            try {
                const res = await fetch(API_URL + '/api/credores', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (!res.ok) return;
                const data = await res.json();
                const arr = data.data || data || [];
                const sel = document.getElementById('filterCredor');
                sel.innerHTML = '<option value="">Todos os Credores</option>';
                arr.forEach(c => {
                    const o = document.createElement('option');
                    o.value = c.id;
                    o.textContent = c.nome || c.razao_social;
                    sel.appendChild(o);
                });
            } catch (e) { console.error('Erro credores:', e); }
        }

        async function carregarUltimosPagamentos() {
            try {
                const res = await fetch(API_URL + '/api/financeiro/ultimos-pagamentos?limit=5', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (!res.ok) return;
                const data = await res.json();
                const lista = data.data || [];
                
                if (lista.length === 0) return;
                
                document.getElementById('ultimosPagamentos').innerHTML = lista.map(p => `
                    <div class="transaction-item">
                        <div class="transaction-icon income"><i class="fas fa-arrow-down"></i></div>
                        <div class="transaction-info">
                            <div class="transaction-desc">${p.cliente_nome || 'Cliente'}</div>
                            <div class="transaction-date">${formatDate(p.data_pagamento)}</div>
                        </div>
                        <div class="transaction-value positive">+${formatCurrency(p.valor_pago || p.valor)}</div>
                    </div>
                `).join('');
            } catch (e) { console.error('Erro últimos pagamentos:', e); }
        }

        function aplicarFiltros() { carregarMovimentacoes(); }
        function exportarRelatorio() { showToast('Exportação em desenvolvimento', 'error'); }
        function novaTransacao() { showToast('Funcionalidade em desenvolvimento', 'error'); }
        function verDetalhes(id) { window.location.href = '/cobrancas?id=' + id; }
        function verTodosPagamentos() { document.querySelector('[data-tab="pagamentos"]').click(); }
        function verRelatorioCredores() { window.location.href = '/relatorios'; }

        async function registrarPagamento(id) {
            if (!confirm('Confirmar pagamento desta cobrança?')) return;
            try {
                const res = await fetch(API_URL + '/api/cobrancas/' + id + '/pagar', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data_pagamento: new Date().toISOString().split('T')[0] })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Pagamento registrado!', 'success');
                    carregarDados();
                } else {
                    showToast(data.message || 'Erro ao registrar', 'error');
                }
            } catch (e) { showToast('Erro de conexão', 'error'); }
        }

        document.addEventListener('DOMContentLoaded', () => { if (verificarAuth()) carregarDados(); });
    </script>
</body>
</html>
