<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cobranças Recorrentes - ACERTIVE Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    :root {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: rgba(17, 17, 21, 0.95);
      --bg-sidebar: #0c0c0f; --text-primary: #fafafa; --text-secondary: #a1a1aa; --text-muted: #71717a;
      --gold: #F6C84C; --gold-light: #FFD56A; --gold-glow: rgba(246, 200, 76, 0.15);
      --gold-glow-strong: rgba(246, 200, 76, 0.3); --border: rgba(255, 255, 255, 0.08);
      --border-gold: rgba(246, 200, 76, 0.2); --green: #22c55e; --green-bg: rgba(34, 197, 94, 0.15);
      --red: #ef4444; --red-bg: rgba(239, 68, 68, 0.15); --blue: #3b82f6; --blue-bg: rgba(59, 130, 246, 0.15);
      --orange: #f59e0b; --orange-bg: rgba(245, 158, 11, 0.15); --purple: #a855f7; --purple-bg: rgba(168, 85, 247, 0.15);
      --sidebar-width: 280px; --sidebar-collapsed: 80px; --header-height: 70px;
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px;
      --shadow-gold: 0 8px 32px rgba(246, 200, 76, 0.2); --transition-fast: 0.15s ease; --transition-normal: 0.25s ease;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh; background: var(--bg-sidebar); border-right: 1px solid var(--border); z-index: 1000; display: flex; flex-direction: column; transition: width var(--transition-normal); }
    .sidebar.collapsed { width: var(--sidebar-collapsed); }
    .sidebar.collapsed .nav-text, .sidebar.collapsed .logo-text, .sidebar.collapsed .user-info, .sidebar.collapsed .nav-section-title { display: none; }
    .sidebar.collapsed .nav-link { justify-content: center; padding: 14px; }
    .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 14px; }
    .logo-icon { min-width: 46px; height: 46px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 22px; color: var(--bg-primary); box-shadow: var(--shadow-gold); }
    .logo-text { display: flex; flex-direction: column; }
    .logo-text span:first-child { font-size: 20px; font-weight: 800; }
    .logo-text span:last-child { font-size: 11px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .sidebar-nav { flex: 1; padding: 20px 12px; overflow-y: auto; }
    .nav-section { margin-bottom: 28px; }
    .nav-section-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 0 12px; margin-bottom: 10px; }
    .nav-links { display: flex; flex-direction: column; gap: 4px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: var(--radius-md); color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 14px; transition: all var(--transition-fast); position: relative; }
    .nav-link:hover { background: var(--gold-glow); color: var(--gold); }
    .nav-link.active { background: linear-gradient(135deg, var(--gold-glow-strong), var(--gold-glow)); color: var(--gold); }
    .nav-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 24px; background: var(--gold); border-radius: 0 3px 3px 0; }
    .nav-link i { width: 20px; text-align: center; font-size: 16px; }
    .nav-badge { margin-left: auto; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; background: var(--blue); color: white; }
    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    .user-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: var(--radius-md); }
    .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--bg-primary); }
    .user-info { flex: 1; }
    .user-name { font-weight: 600; font-size: 13px; }
    .user-role { font-size: 11px; color: var(--text-muted); }
    .user-menu-btn { width: 28px; height: 28px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: 6px; }

    .main-wrapper { margin-left: var(--sidebar-width); min-height: 100vh; transition: margin-left var(--transition-normal); }
    .sidebar.collapsed ~ .main-wrapper { margin-left: var(--sidebar-collapsed); }

    .header { height: var(--header-height); background: rgba(9, 9, 11, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .sidebar-toggle { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); }
    .sidebar-toggle:hover { background: var(--gold-glow); color: var(--gold); }
    .breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .breadcrumb-item { color: var(--text-muted); }
    .breadcrumb-item.active { color: var(--text-primary); font-weight: 600; }
    .header-right { display: flex; gap: 12px; }

    .page-content { padding: 32px; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 20px; }
    .page-title { font-size: 28px; font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .page-title-icon { width: 42px; height: 42px; background: var(--gold-glow-strong); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--gold); }
    .page-subtitle { color: var(--text-muted); font-size: 14px; }
    .page-header-right { display: flex; gap: 12px; flex-wrap: wrap; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border-radius: var(--radius-md); font-weight: 600; font-size: 14px; cursor: pointer; transition: all var(--transition-fast); border: none; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: var(--bg-primary); box-shadow: var(--shadow-gold); }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--gold-glow); border-color: var(--border-gold); color: var(--gold); }
    .btn-success { background: var(--green); color: white; }
    .btn-sm { padding: 8px 14px; font-size: 13px; }

    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; display: flex; align-items: center; gap: 16px; transition: all var(--transition-fast); }
    .stat-card:hover { border-color: var(--border-gold); transform: translateY(-2px); }
    .stat-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .stat-info { display: flex; flex-direction: column; }
    .stat-value { font-size: 24px; font-weight: 800; }
    .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 600; }

    .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    thead th { background: rgba(0,0,0,0.3); padding: 16px 20px; text-align: left; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
    tbody td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-secondary); }
    tbody tr { transition: all var(--transition-fast); }
    tbody tr:hover { background: var(--gold-glow); }

    .client-cell { display: flex; align-items: center; gap: 12px; }
    .client-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: var(--bg-primary); font-size: 14px; }
    .client-name { font-weight: 700; color: var(--text-primary); }
    .valor-cell { font-weight: 800; color: var(--gold); font-size: 16px; }
    
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-ativo { background: var(--green-bg); color: var(--green); }
    .badge-inativo { background: rgba(100,100,100,0.2); color: #888; }
    .badge-mensal { background: var(--blue-bg); color: var(--blue); }
    .badge-semanal { background: var(--purple-bg); color: var(--purple); }
    .badge-quinzenal { background: var(--orange-bg); color: var(--orange); }
    .badge-bimestral, .badge-trimestral, .badge-semestral, .badge-anual { background: var(--green-bg); color: var(--green); }

    .actions-cell { display: flex; gap: 6px; }
    .action-btn { width: 36px; height: 36px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); }
    .action-btn:hover { transform: scale(1.1); }
    .action-btn.view { color: var(--blue); border-color: var(--blue-bg); }
    .action-btn.view:hover { background: var(--blue-bg); }
    .action-btn.generate { color: var(--green); border-color: var(--green-bg); }
    .action-btn.generate:hover { background: var(--green-bg); }
    .action-btn.toggle { color: var(--orange); border-color: var(--orange-bg); }
    .action-btn.toggle:hover { background: var(--orange-bg); }

    .table-footer { padding: 16px 20px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-muted); }
    .loading-cell { text-align: center; padding: 60px 20px !important; color: var(--text-muted); }
    .loading-spinner { font-size: 32px; color: var(--gold); margin-bottom: 16px; }
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state i { font-size: 48px; color: var(--gold); opacity: 0.5; margin-bottom: 16px; }
    .empty-state h3 { color: var(--text-secondary); margin-bottom: 12px; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-card); border: 1px solid var(--border-gold); border-radius: var(--radius-xl); padding: 28px; width: 90%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .modal-title { font-size: 20px; font-weight: 800; color: var(--gold); display: flex; align-items: center; gap: 10px; }
    .modal-close { width: 36px; height: 36px; border-radius: var(--radius-sm); border: none; background: rgba(255,255,255,0.05); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: var(--red-bg); color: var(--red); }
    .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: var(--text-muted); font-size: 13px; }
    .detail-value { color: var(--text-primary); font-weight: 600; }
    .modal-footer { display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end; }

    @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .main-wrapper { margin-left: 0; } }
    @media (max-width: 768px) { .stats-row { grid-template-columns: 1fr; } .page-header { flex-direction: column; } }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header"><div class="logo-icon">A</div><div class="logo-text"><span>ACERTIVE</span><span>Enterprise</span></div></div>
    <nav class="sidebar-nav">
      <div class="nav-section"><div class="nav-section-title">Principal</div><div class="nav-links">
        <a href="/dashboard" class="nav-link"><i class="fa-solid fa-grid-2"></i><span class="nav-text">Dashboard</span></a>
        <a href="/cobrancas" class="nav-link"><i class="fa-solid fa-file-invoice-dollar"></i><span class="nav-text">Cobranças</span></a>
        <a href="/clientes-ativos" class="nav-link"><i class="fa-solid fa-users"></i><span class="nav-text">Clientes</span></a>
        <a href="/agendamentos" class="nav-link"><i class="fa-solid fa-calendar-check"></i><span class="nav-text">Agendamentos</span></a>
      </div></div>
      <div class="nav-section"><div class="nav-section-title">Financeiro</div><div class="nav-links">
        <a href="/nova-cobranca" class="nav-link"><i class="fa-solid fa-plus-circle"></i><span class="nav-text">Nova Cobrança</span></a>
        <a href="/cobrancas-recorrentes" class="nav-link active"><i class="fa-solid fa-repeat"></i><span class="nav-text">Recorrentes</span></a>
        <a href="/historico" class="nav-link"><i class="fa-solid fa-clock-rotate-left"></i><span class="nav-text">Histórico</span></a>
      </div></div>
      <div class="nav-section"><div class="nav-section-title">Administração</div><div class="nav-links">
        <a href="/usuarios" class="nav-link"><i class="fa-solid fa-user-shield"></i><span class="nav-text">Usuários</span><span class="nav-badge">ADM</span></a>
        <a href="/configuracoes" class="nav-link"><i class="fa-solid fa-gear"></i><span class="nav-text">Configurações</span></a>
      </div></div>
    </nav>
    <div class="sidebar-footer"><div class="user-card"><div class="user-avatar" id="userAvatar">U</div><div class="user-info"><div class="user-name" id="userName">Usuário</div><div class="user-role" id="userRole">Operador</div></div><button class="user-menu-btn" id="btnLogout" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></button></div></div>
  </aside>

  <div class="main-wrapper">
    <header class="header">
      <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
        <div class="breadcrumb"><span class="breadcrumb-item">Financeiro</span><span class="breadcrumb-item">/</span><span class="breadcrumb-item active">Recorrentes</span></div>
      </div>
      <div class="header-right">
        <button class="btn btn-secondary" id="btnProcessar"><i class="fa-solid fa-cogs"></i> Processar Agora</button>
      </div>
    </header>

    <main class="page-content">
      <div class="page-header">
        <div><h1 class="page-title"><div class="page-title-icon"><i class="fa-solid fa-repeat"></i></div>Cobranças Recorrentes</h1><p class="page-subtitle">Gerencie regras de cobranças automáticas</p></div>
        <div class="page-header-right"><a href="/nova-recorrente" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Nova Recorrente</a></div>
      </div>

      <div class="stats-row">
        <div class="stat-card"><div class="stat-icon" style="background:var(--purple-bg);color:var(--purple);"><i class="fa-solid fa-repeat"></i></div><div class="stat-info"><span class="stat-value" id="statTotal">0</span><span class="stat-label">Total</span></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:var(--green-bg);color:var(--green);"><i class="fa-solid fa-check-circle"></i></div><div class="stat-info"><span class="stat-value" id="statAtivas">0</span><span class="stat-label">Ativas</span></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:var(--gold-glow);color:var(--gold);"><i class="fa-solid fa-coins"></i></div><div class="stat-info"><span class="stat-value" id="statValorMensal">R$ 0</span><span class="stat-label">Receita Mensal</span></div></div>
        <div class="stat-card"><div class="stat-icon" style="background:var(--blue-bg);color:var(--blue);"><i class="fa-solid fa-file-invoice"></i></div><div class="stat-info"><span class="stat-value" id="statGeradas">0</span><span class="stat-label">Geradas</span></div></div>
      </div>

      <div class="table-card">
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Cliente</th><th>Valor</th><th>Frequência</th><th>Dia Venc.</th><th>Geradas</th><th>Status</th><th>Ações</th></tr></thead>
            <tbody id="tbody"><tr><td colspan="7" class="loading-cell"><div class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i></div><span>Carregando...</span></td></tr></tbody>
          </table>
        </div>
        <div class="table-footer"><span id="tableInfo">0 recorrentes</span></div>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="modalDetalhes">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title"><i class="fa-solid fa-info-circle"></i> Detalhes</h2><button class="modal-close" onclick="fecharModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="fecharModal()">Fechar</button><button class="btn btn-success" id="btnGerarModal"><i class="fa-solid fa-bolt"></i> Gerar Cobrança</button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.js"></script>
  <script>
    const API_BASE = '';
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';

    document.getElementById('sidebarToggle').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      if (window.innerWidth <= 1024) sidebar.classList.toggle('open');
      else sidebar.classList.toggle('collapsed');
    });
    document.getElementById('btnLogout').addEventListener('click', () => { localStorage.removeItem('token'); window.location.href = '/login'; });

    function showToast(msg, type = 'success') {
      Toastify({ text: msg, duration: 3000, gravity: 'top', position: 'right', style: { background: type === 'error' ? '#ef4444' : '#22c55e', borderRadius: '12px', fontWeight: '600' } }).showToast();
    }

    function formatMoney(val) { return Number(val || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    function formatDate(d) { if (!d) return '—'; return new Date(d).toLocaleDateString('pt-BR'); }

    const frequenciaLabels = { semanal: 'Semanal', quinzenal: 'Quinzenal', mensal: 'Mensal', bimestral: 'Bimestral', trimestral: 'Trimestral', semestral: 'Semestral', anual: 'Anual' };
    let recorrenteSelecionada = null;

    async function carregarStats() {
      try {
        const resp = await fetch(`${API_BASE}/api/cobrancas-recorrentes/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();
        if (data.success) {
          document.getElementById('statTotal').textContent = data.data.total;
          document.getElementById('statAtivas').textContent = data.data.ativas;
          document.getElementById('statValorMensal').textContent = formatMoney(data.data.valor_mensal_ativo);
          document.getElementById('statGeradas').textContent = data.data.total_cobrancas_geradas;
        }
      } catch (err) { console.error(err); }
    }

    async function carregarRecorrentes() {
      const tbody = document.getElementById('tbody');
      try {
        const resp = await fetch(`${API_BASE}/api/cobrancas-recorrentes`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();

        if (!data.success || !data.data.length) {
          tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fa-solid fa-repeat"></i><h3>Nenhuma recorrente cadastrada</h3><p>Crie uma nova cobrança recorrente</p></div></td></tr>`;
          return;
        }

        document.getElementById('tableInfo').textContent = `${data.data.length} recorrente(s)`;
        tbody.innerHTML = data.data.map(r => {
          const iniciais = (r.cliente_nome || 'C').substring(0, 2).toUpperCase();
          return `
            <tr>
              <td><div class="client-cell"><div class="client-avatar">${iniciais}</div><span class="client-name">${r.cliente_nome || '—'}</span></div></td>
              <td><span class="valor-cell">${formatMoney(r.valor)}</span></td>
              <td><span class="badge badge-${r.frequencia}">${frequenciaLabels[r.frequencia] || r.frequencia}</span></td>
              <td>Dia ${r.dia_vencimento}</td>
              <td>${r.total_geradas || 0}</td>
              <td><span class="badge badge-${r.ativo ? 'ativo' : 'inativo'}">${r.ativo ? '✓ Ativa' : '✗ Inativa'}</span></td>
              <td class="actions-cell">
                <button class="action-btn view" onclick="verDetalhes('${r.id}')" title="Detalhes"><i class="fa-solid fa-eye"></i></button>
                <button class="action-btn generate" onclick="gerarCobranca('${r.id}')" title="Gerar"><i class="fa-solid fa-bolt"></i></button>
                <button class="action-btn toggle" onclick="toggleStatus('${r.id}', ${r.ativo})" title="${r.ativo ? 'Pausar' : 'Ativar'}"><i class="fa-solid fa-${r.ativo ? 'pause' : 'play'}"></i></button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fa-solid fa-exclamation-triangle"></i><h3>Erro ao carregar</h3></div></td></tr>`;
      }
    }

    async function verDetalhes(id) {
      try {
        const resp = await fetch(`${API_BASE}/api/cobrancas-recorrentes/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();
        if (!data.success) { showToast(data.message || 'Erro', 'error'); return; }

        recorrenteSelecionada = data.data;
        const r = data.data;
        document.getElementById('modalBody').innerHTML = `
          <div class="detail-row"><span class="detail-label">Cliente</span><span class="detail-value">${r.cliente_nome || '—'}</span></div>
          <div class="detail-row"><span class="detail-label">Valor</span><span class="detail-value" style="color:var(--gold);">${formatMoney(r.valor)}</span></div>
          <div class="detail-row"><span class="detail-label">Descrição</span><span class="detail-value">${r.descricao || '—'}</span></div>
          <div class="detail-row"><span class="detail-label">Frequência</span><span class="detail-value">${frequenciaLabels[r.frequencia] || r.frequencia}</span></div>
          <div class="detail-row"><span class="detail-label">Dia Vencimento</span><span class="detail-value">Dia ${r.dia_vencimento}</span></div>
          <div class="detail-row"><span class="detail-label">Início</span><span class="detail-value">${formatDate(r.data_inicio)}</span></div>
          <div class="detail-row"><span class="detail-label">Última Geração</span><span class="detail-value">${r.ultima_geracao ? formatDate(r.ultima_geracao) : 'Nunca'}</span></div>
          <div class="detail-row"><span class="detail-label">Total Geradas</span><span class="detail-value">${r.total_geradas || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value"><span class="badge badge-${r.ativo ? 'ativo' : 'inativo'}">${r.ativo ? 'Ativa' : 'Inativa'}</span></span></div>
        `;
        document.getElementById('modalDetalhes').classList.add('active');
      } catch (err) { showToast('Erro ao buscar detalhes', 'error'); }
    }

    function fecharModal() { document.getElementById('modalDetalhes').classList.remove('active'); recorrenteSelecionada = null; }

    async function gerarCobranca(id) {
      if (!confirm('Gerar cobrança agora?')) return;
      try {
        const resp = await fetch(`${API_BASE}/api/cobrancas-recorrentes/${id}/gerar`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();
        if (data.success) { showToast(data.message || 'Cobrança gerada!'); carregarRecorrentes(); carregarStats(); fecharModal(); }
        else showToast(data.message || 'Erro', 'error');
      } catch (err) { showToast('Erro ao gerar', 'error'); }
    }

    async function toggleStatus(id, ativo) {
      const acao = ativo ? 'pausar' : 'ativar';
      if (!confirm(`Deseja ${acao} esta recorrente?`)) return;
      try {
        const resp = await fetch(`${API_BASE}/api/cobrancas-recorrentes/${id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ativo: !ativo }) });
        const data = await resp.json();
        if (data.success) { showToast(`Recorrente ${ativo ? 'pausada' : 'ativada'}!`); carregarRecorrentes(); carregarStats(); }
        else showToast(data.message || 'Erro', 'error');
      } catch (err) { showToast('Erro', 'error'); }
    }

    document.getElementById('btnProcessar').addEventListener('click', async () => {
      if (!confirm('Processar todas as recorrentes pendentes?')) return;
      const btn = document.getElementById('btnProcessar');
      btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processando...';
      try {
        const resp = await fetch(`${API_BASE}/api/cobrancas-recorrentes/processar`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();
        if (data.success) { showToast(data.message); carregarRecorrentes(); carregarStats(); }
        else showToast(data.message || 'Erro', 'error');
      } catch (err) { showToast('Erro', 'error'); }
      finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cogs"></i> Processar Agora'; }
    });

    document.getElementById('btnGerarModal').addEventListener('click', () => { if (recorrenteSelecionada) gerarCobranca(recorrenteSelecionada.id); });
    document.getElementById('modalDetalhes').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) fecharModal(); });

    async function carregarUsuario() {
      try {
        const resp = await fetch(`${API_BASE}/api/usuarios/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await resp.json();
        if (result.success && result.data) {
          document.getElementById('userName').textContent = result.data.nome || 'Usuário';
          document.getElementById('userRole').textContent = result.data.nivel === 'admin' ? 'Administrador' : 'Operador';
          document.getElementById('userAvatar').textContent = (result.data.nome || 'U').charAt(0).toUpperCase();
        }
      } catch (err) {}
    }

    carregarUsuario();
    carregarStats();
    carregarRecorrentes();
  </script>
</body>
</html>