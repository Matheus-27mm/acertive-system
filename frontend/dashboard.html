<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACERTIVE • Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    :root {
      --bg-primary: #09090b;
      --bg-secondary: #0f0f12;
      --bg-card: rgba(17, 17, 21, 0.95);
      --bg-sidebar: #0c0c0f;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --gold: #F6C84C;
      --gold-light: #FFD56A;
      --gold-glow: rgba(246, 200, 76, 0.15);
      --gold-glow-strong: rgba(246, 200, 76, 0.3);
      --border: rgba(255, 255, 255, 0.08);
      --border-gold: rgba(246, 200, 76, 0.2);
      --green: #22c55e;
      --green-bg: rgba(34, 197, 94, 0.15);
      --red: #ef4444;
      --red-bg: rgba(239, 68, 68, 0.15);
      --blue: #3b82f6;
      --blue-bg: rgba(59, 130, 246, 0.15);
      --orange: #f59e0b;
      --orange-bg: rgba(245, 158, 11, 0.15);
      --purple: #a855f7;
      --purple-bg: rgba(168, 85, 247, 0.15);
      --sidebar-width: 260px;
      --header-height: 70px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-gold: 0 8px 32px rgba(246, 200, 76, 0.2);
      --transition-fast: 0.15s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

    /* SIDEBAR PADRÃO */
    .sidebar {
      position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
      background: var(--bg-sidebar); border-right: 1px solid var(--border); z-index: 1000;
      display: flex; flex-direction: column;
    }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; color: var(--bg-primary); box-shadow: var(--shadow-gold); }
    .logo-text { font-size: 20px; font-weight: 800; }
    .logo-text span { color: var(--gold); }

    .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 0 12px; margin-bottom: 8px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 11px 14px; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); font-weight: 500; font-size: 14px; transition: all var(--transition-fast); margin-bottom: 2px; position: relative; }
    .nav-link:hover { background: var(--gold-glow); color: var(--gold); }
    .nav-link.active { background: linear-gradient(135deg, var(--gold-glow-strong), var(--gold-glow)); color: var(--gold); }
    .nav-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 20px; background: var(--gold); border-radius: 0 3px 3px 0; }
    .nav-link i { width: 20px; text-align: center; font-size: 15px; }
    .nav-badge { margin-left: auto; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; }
    .nav-badge.gold { background: var(--gold); color: var(--bg-primary); }
    .nav-badge.green { background: var(--green); color: white; }
    .nav-badge.blue { background: var(--blue); color: white; }
    .nav-badge.red { background: var(--red); color: white; }

    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    .user-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: var(--radius-md); }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: var(--bg-primary); }
    .user-info { flex: 1; }
    .user-name { font-weight: 600; font-size: 13px; }
    .user-role { font-size: 11px; color: var(--text-muted); }
    .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 6px; }
    .btn-logout:hover { background: var(--red-bg); color: var(--red); }

    /* MAIN */
    .main-wrapper { margin-left: var(--sidebar-width); min-height: 100vh; }
    .header { height: var(--header-height); background: rgba(9,9,11,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .sidebar-toggle { display: none; width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; align-items: center; justify-content: center; }
    .breadcrumb { font-size: 14px; color: var(--text-muted); }
    .breadcrumb .active { color: var(--text-primary); font-weight: 600; }

    .header-right { display: flex; align-items: center; gap: 12px; }
    .header-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); position: relative; }
    .header-btn:hover { background: var(--gold-glow); color: var(--gold); border-color: var(--border-gold); }
    .notification-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--red); border-radius: 50%; display: none; }

    .page-content { padding: 32px; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 28px; font-weight: 800; display: flex; align-items: center; gap: 12px; }
    .page-title-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--gold-glow-strong), var(--gold-glow)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--gold); }
    .page-subtitle { color: var(--text-muted); font-size: 14px; margin-top: 4px; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border-radius: var(--radius-md); font-weight: 600; font-size: 14px; cursor: pointer; transition: all var(--transition-fast); border: none; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: var(--bg-primary); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-gold); }
    .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--gold-glow); border-color: var(--border-gold); color: var(--gold); }

    /* KPIs */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
    .kpi-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; transition: all var(--transition-fast); }
    .kpi-card:hover { transform: translateY(-4px); border-color: var(--border-gold); }
    .kpi-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px; }
    .kpi-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
    .kpi-value { font-size: 24px; font-weight: 800; }

    /* Charts */
    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px; }
    .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .chart-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .chart-title i { color: var(--gold); }
    .chart-body { height: 280px; }
    .chart-body-donut { height: 200px; display: flex; align-items: center; justify-content: center; }
    .chart-legend { display: flex; justify-content: center; gap: 24px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* Bottom Grid */
    .bottom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .card-title i { color: var(--gold); }
    .card-link { font-size: 13px; font-weight: 600; color: var(--gold); text-decoration: none; display: flex; align-items: center; gap: 6px; }

    .actions-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .action-item { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 16px 12px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: var(--radius-md); text-decoration: none; color: var(--text-secondary); font-size: 12px; font-weight: 600; transition: all var(--transition-fast); }
    .action-item:hover { background: var(--gold-glow); border-color: var(--border-gold); color: var(--text-primary); transform: translateY(-2px); }
    .action-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 18px; }

    .activity-list { display: flex; flex-direction: column; gap: 12px; max-height: 280px; overflow-y: auto; }
    .activity-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); }
    .activity-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .activity-info { flex: 1; }
    .activity-title { font-size: 13px; font-weight: 600; }
    .activity-subtitle { font-size: 11px; color: var(--text-muted); }
    .activity-time { font-size: 11px; color: var(--text-muted); }
    .activity-empty { display: flex; flex-direction: column; align-items: center; padding: 40px; color: var(--text-muted); gap: 12px; }
    .activity-empty i { font-size: 32px; opacity: 0.5; }

    .debtors-list { display: flex; flex-direction: column; gap: 8px; }
    .debtor-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); }
    .debtor-rank { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; background: var(--gold-glow); color: var(--gold); }
    .debtor-rank.top { background: var(--gold); color: var(--bg-primary); }
    .debtor-info { flex: 1; }
    .debtor-name { font-size: 13px; font-weight: 600; }
    .debtor-details { font-size: 11px; color: var(--text-muted); }
    .debtor-value { font-size: 14px; font-weight: 700; color: var(--red); }

    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } .charts-grid, .bottom-grid { grid-template-columns: 1fr; } }
    @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); transition: transform 0.3s; } .sidebar.open { transform: translateX(0); } .main-wrapper { margin-left: 0; } .sidebar-toggle { display: flex; } }
    @media (max-width: 640px) { .kpi-grid { grid-template-columns: 1fr; } .page-header { flex-direction: column; } .actions-grid { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>
  <!-- SIDEBAR PADRÃO -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <nav class="sidebar-nav">
      <!-- PRINCIPAL -->
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a href="/dashboard" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="/cobrancas" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a>
        <a href="/clientes" class="nav-link"><i class="fas fa-users"></i> Clientes</a>
        <a href="/agendamentos" class="nav-link"><i class="fas fa-calendar-check"></i> Agendamentos</a>
      </div>
      <!-- AÇÕES -->
      <div class="nav-section">
        <div class="nav-section-title">Ações</div>
        <a href="/nova-cobranca" class="nav-link"><i class="fas fa-plus-circle"></i> Nova Cobrança</a>
        <a href="/novo-cliente" class="nav-link"><i class="fas fa-user-plus"></i> Novo Cliente</a>
        <a href="/importar-cobrancas" class="nav-link"><i class="fas fa-file-import"></i> Importar</a>
      </div>
      <!-- AUTOMAÇÃO -->
      <div class="nav-section">
        <div class="nav-section-title">Automação</div>
        <a href="/lembretes" class="nav-link"><i class="fas fa-envelope"></i> Lembretes E-mail</a>
      </div>
      <!-- ADMIN -->
      <div class="nav-section" id="adminSection">
        <div class="nav-section-title">Administração</div>
        <a href="/usuarios" class="nav-link"><i class="fas fa-user-shield"></i> Usuários</a>
        <a href="/configuracoes" class="nav-link"><i class="fas fa-gear"></i> Configurações</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-info">
          <div class="user-name" id="userName">Usuário</div>
          <div class="user-role" id="userRole">Operador</div>
        </div>
        <button class="btn-logout" onclick="logout()" title="Sair"><i class="fas fa-right-from-bracket"></i></button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-wrapper">
    <header class="header">
      <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
        <div class="breadcrumb">ACERTIVE / <span class="active">Dashboard</span></div>
      </div>
      <div class="header-right">
        <button class="header-btn" id="btnRefresh" title="Atualizar"><i class="fas fa-rotate"></i></button>
        <button class="header-btn" id="btnExportar" title="Exportar"><i class="fas fa-download"></i></button>
      </div>
    </header>

    <main class="page-content">
      <div class="page-header">
        <div>
          <h1 class="page-title"><div class="page-title-icon"><i class="fas fa-chart-line"></i></div> Dashboard</h1>
          <p class="page-subtitle">Visão geral do seu negócio</p>
        </div>
        <div style="display:flex;gap:12px;">
          <a href="/novo-cliente" class="btn btn-secondary"><i class="fas fa-user-plus"></i> Novo Cliente</a>
          <a href="/nova-cobranca" class="btn btn-primary"><i class="fas fa-plus"></i> Nova Cobrança</a>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-icon" style="background:var(--green-bg);color:var(--green);"><i class="fas fa-circle-dollar-to-slot"></i></div>
          <div class="kpi-label">Total Recebido</div>
          <div class="kpi-value" id="totalRecebido">R$ 0,00</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="background:var(--orange-bg);color:var(--orange);"><i class="fas fa-clock"></i></div>
          <div class="kpi-label">Pendentes</div>
          <div class="kpi-value" id="totalPendentes">R$ 0,00</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="background:var(--red-bg);color:var(--red);"><i class="fas fa-triangle-exclamation"></i></div>
          <div class="kpi-label">Vencidos</div>
          <div class="kpi-value" id="totalVencidos">R$ 0,00</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="background:var(--blue-bg);color:var(--blue);"><i class="fas fa-users"></i></div>
          <div class="kpi-label">Clientes Ativos</div>
          <div class="kpi-value" id="totalClientes">0</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title"><i class="fas fa-chart-area"></i> Faturamento Mensal</div>
          </div>
          <div class="chart-body"><canvas id="chartFaturamento"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title"><i class="fas fa-chart-pie"></i> Status das Cobranças</div>
          </div>
          <div class="chart-body chart-body-donut"><canvas id="chartStatus"></canvas></div>
          <div class="chart-legend">
            <div class="legend-item"><span class="legend-dot" style="background:var(--green);"></span> Pago <strong id="legendPago">0</strong></div>
            <div class="legend-item"><span class="legend-dot" style="background:var(--orange);"></span> Pendente <strong id="legendPendente">0</strong></div>
            <div class="legend-item"><span class="legend-dot" style="background:var(--red);"></span> Vencido <strong id="legendVencido">0</strong></div>
          </div>
        </div>
      </div>

      <!-- Bottom Grid -->
      <div class="bottom-grid">
        <div class="card">
          <div class="card-header"><h3 class="card-title"><i class="fas fa-bolt"></i> Ações Rápidas</h3></div>
          <div class="actions-grid">
            <a href="/nova-cobranca" class="action-item"><div class="action-icon" style="background:var(--gold-glow);color:var(--gold);"><i class="fas fa-plus"></i></div> Nova Cobrança</a>
            <a href="/novo-cliente" class="action-item"><div class="action-icon" style="background:var(--blue-bg);color:var(--blue);"><i class="fas fa-user-plus"></i></div> Novo Cliente</a>
            <a href="/clientes" class="action-item"><div class="action-icon" style="background:var(--green-bg);color:var(--green);"><i class="fas fa-search"></i></div> Buscar Cliente</a>
            <a href="/importar-cobrancas" class="action-item"><div class="action-icon" style="background:var(--purple-bg);color:var(--purple);"><i class="fas fa-file-import"></i></div> Importar</a>
            <a href="/cobrancas?status=vencido" class="action-item"><div class="action-icon" style="background:var(--red-bg);color:var(--red);"><i class="fas fa-triangle-exclamation"></i></div> Ver Vencidos</a>
            <a href="/configuracoes" class="action-item"><div class="action-icon" style="background:var(--orange-bg);color:var(--orange);"><i class="fas fa-gear"></i></div> Configurações</a>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3 class="card-title"><i class="fas fa-calendar-day"></i> Agendamentos Hoje</h3><a href="/agendamentos" class="card-link">Ver todos <i class="fas fa-arrow-right"></i></a></div>
          <div class="activity-list" id="listaAgendamentos">
            <div class="activity-empty"><i class="fas fa-calendar-check"></i><span>Nenhum agendamento hoje</span></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3 class="card-title"><i class="fas fa-ranking-star"></i> Maiores Devedores</h3><a href="/clientes" class="card-link">Ver todos <i class="fas fa-arrow-right"></i></a></div>
          <div class="debtors-list" id="listaDevedores">
            <div class="activity-empty"><i class="fas fa-check-circle"></i><span>Nenhum devedor</span></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.js"></script>
  <script>
    const API = window.location.origin;
    let token = localStorage.getItem('token');
    let chartFaturamento = null, chartStatus = null;
    if (!token) window.location.href = '/login';

    function getHeaders() { return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }; }
    function fmtMoney(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); }
    function fmtTime(d) { return new Date(d).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); }
    function logout() { localStorage.removeItem('token'); window.location.href = '/login'; }
    function showToast(msg, type) { Toastify({ text: msg, duration: 3000, gravity: 'top', position: 'right', style: { background: type === 'error' ? '#ef4444' : '#22c55e', borderRadius: '12px', fontWeight: '600' } }).showToast(); }

    document.getElementById('sidebarToggle').onclick = () => document.getElementById('sidebar').classList.toggle('open');

    async function carregarUsuario() {
      try {
        const res = await fetch(API + '/api/usuarios/me', { headers: getHeaders() });
        const data = await res.json();
        if (data.success && data.data) {
          document.getElementById('userName').textContent = data.data.nome || 'Usuário';
          document.getElementById('userRole').textContent = data.data.nivel === 'admin' ? 'Administrador' : 'Operador';
          document.getElementById('userAvatar').textContent = (data.data.nome || 'U').charAt(0).toUpperCase();
          if (data.data.nivel !== 'admin') document.getElementById('adminSection').style.display = 'none';
        }
      } catch (e) { console.error(e); }
    }

    async function carregarDashboard() {
      try {
        const res = await fetch(API + '/api/dashboard', { headers: getHeaders() });
        const data = await res.json();
        if (data.success) {
          document.getElementById('totalRecebido').textContent = fmtMoney(data.totalRecebido);
          document.getElementById('totalPendentes').textContent = fmtMoney(data.totalPendente);
          document.getElementById('totalVencidos').textContent = fmtMoney(data.totalVencido);
          document.getElementById('totalClientes').textContent = data.clientesAtivos || 0;
        }
      } catch (e) { console.error(e); }
    }

    async function carregarGraficos() {
      try {
        const res = await fetch(API + '/api/dashboard/graficos', { headers: getHeaders() });
        const data = await res.json();
        if (data.success) {
          renderFaturamento(data.faturamentoMensal);
          renderStatus(data.statusCobrancas);
          renderDevedores(data.topDevedores);
        }
      } catch (e) { console.error(e); }
    }

    function renderFaturamento(d) {
      const ctx = document.getElementById('chartFaturamento');
      if (chartFaturamento) chartFaturamento.destroy();
      const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(246,200,76,0.3)');
      gradient.addColorStop(1, 'rgba(246,200,76,0)');
      chartFaturamento = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d?.meses || ['Jan','Fev','Mar','Abr','Mai','Jun'],
          datasets: [{ label: 'Faturado', data: d?.total || [0,0,0,0,0,0], borderColor: '#F6C84C', backgroundColor: gradient, borderWidth: 3, fill: true, tension: 0.4, pointRadius: 4 },
                     { label: 'Recebido', data: d?.recebido || [0,0,0,0,0,0], borderColor: '#22c55e', borderWidth: 2, borderDash: [5,5], tension: 0.4, pointRadius: 3 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { color: '#a1a1aa', usePointStyle: true } } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a', callback: v => fmtMoney(v) } } } }
      });
    }

    function renderStatus(d) {
      const ctx = document.getElementById('chartStatus');
      if (chartStatus) chartStatus.destroy();
      const pago = d?.pago || 0, pendente = d?.pendente || 0, vencido = d?.vencido || 0;
      document.getElementById('legendPago').textContent = pago;
      document.getElementById('legendPendente').textContent = pendente;
      document.getElementById('legendVencido').textContent = vencido;
      chartStatus = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Pago','Pendente','Vencido'], datasets: [{ data: [pago, pendente, vencido], backgroundColor: ['#22c55e','#f59e0b','#ef4444'], borderColor: '#09090b', borderWidth: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
      });
    }

    function renderDevedores(lista) {
      const el = document.getElementById('listaDevedores');
      if (!lista || !lista.length) { el.innerHTML = '<div class="activity-empty"><i class="fas fa-check-circle"></i><span>Nenhum devedor</span></div>'; return; }
      el.innerHTML = lista.map((d, i) => '<div class="debtor-item"><div class="debtor-rank ' + (i === 0 ? 'top' : '') + '">' + (i + 1) + 'º</div><div class="debtor-info"><div class="debtor-name">' + (d.cliente || 'Sem nome') + '</div><div class="debtor-details">Pendente</div></div><div class="debtor-value">' + fmtMoney(d.total) + '</div></div>').join('');
    }

    async function carregarAgendamentos() {
      try {
        const res = await fetch(API + '/api/agendamentos/hoje', { headers: getHeaders() });
        const data = await res.json();
        const el = document.getElementById('listaAgendamentos');
        if (!data.success || !data.data || !data.data.length) { el.innerHTML = '<div class="activity-empty"><i class="fas fa-calendar-check"></i><span>Nenhum agendamento hoje</span></div>'; return; }
        el.innerHTML = data.data.slice(0, 5).map(a => '<div class="activity-item"><div class="activity-icon" style="background:var(--blue-bg);color:var(--blue);"><i class="fas fa-calendar"></i></div><div class="activity-info"><div class="activity-title">' + (a.cliente_nome || 'Cliente') + '</div><div class="activity-subtitle">' + (a.descricao || a.tipo) + '</div></div><div class="activity-time">' + fmtTime(a.data_agendamento) + '</div></div>').join('');
      } catch (e) { console.error(e); }
    }

    document.getElementById('btnRefresh').onclick = async () => {
      document.getElementById('btnRefresh').querySelector('i').classList.add('fa-spin');
      await Promise.all([carregarDashboard(), carregarGraficos(), carregarAgendamentos()]);
      document.getElementById('btnRefresh').querySelector('i').classList.remove('fa-spin');
      showToast('Dados atualizados!');
    };

    document.getElementById('btnExportar').onclick = async () => {
      try {
        showToast('Gerando relatório...');
        const res = await fetch(API + '/api/relatorios/export-csv', { headers: getHeaders() });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'relatorio_' + new Date().toISOString().slice(0, 10) + '.csv';
        a.click();
        showToast('Relatório exportado!');
      } catch (e) { showToast('Erro ao exportar', 'error'); }
    };

    carregarUsuario();
    carregarDashboard();
    carregarGraficos();
    carregarAgendamentos();
  </script>
</body>
</html>
