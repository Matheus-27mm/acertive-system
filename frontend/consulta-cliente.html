<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Cliente - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; min-height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar { width: 260px; background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; padding: 20px 0; position: fixed; left: 0; top: 0; z-index: 100; }
    .logo-section { padding: 0 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; color: #1a1a1a; }
    .logo-text { font-size: 22px; font-weight: 800; color: #fff; }
    .logo-text span { color: #F6C84C; }
    .nav-menu { list-style: none; padding: 0 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #a1a1aa; text-decoration: none; border-radius: 12px; transition: all 0.2s; font-weight: 500; }
    .nav-link:hover, .nav-link.active { background: rgba(246, 200, 76, 0.1); color: #F6C84C; }
    .nav-link i { width: 20px; text-align: center; font-size: 16px; }
    .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 16px 12px; }

    /* Main Content */
    .main-content { flex: 1; margin-left: 260px; padding: 24px; }

    /* Header */
    .page-header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 20px; padding: 28px 32px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #F6C84C; }
    .page-title h1 { font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 6px; }
    .page-title p { color: #a1a1aa; font-size: 14px; }

    /* Search Section */
    .search-section { background: #fff; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
    .search-box { display: flex; gap: 12px; }
    .search-input-wrapper { flex: 1; position: relative; }
    .search-input { width: 100%; padding: 16px 20px 16px 50px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; transition: all 0.2s; }
    .search-input:focus { outline: none; border-color: #F6C84C; box-shadow: 0 0 0 4px rgba(246, 200, 76, 0.15); }
    .search-input::placeholder { color: #9ca3af; }
    .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 18px; }
    .search-btn { padding: 16px 32px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border: none; border-radius: 12px; font-size: 16px; font-weight: 700; color: #1a1a1a; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .search-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(246, 200, 76, 0.35); }

    /* Results List */
    .results-section { display: none; }
    .results-section.active { display: block; }
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .results-header h3 { font-size: 18px; font-weight: 700; color: #1a1a1a; }
    .results-count { background: #F6C84C; color: #1a1a1a; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; }
    .results-list { display: flex; flex-direction: column; gap: 12px; }
    .result-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .result-card:hover { border-color: #F6C84C; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .result-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .result-name { font-size: 18px; font-weight: 700; color: #1a1a1a; }
    .result-cpf { font-size: 13px; color: #6b7280; margin-top: 4px; }
    .result-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .result-badge.devendo { background: #fee2e2; color: #dc2626; }
    .result-badge.em-dia { background: #dcfce7; color: #16a34a; }
    .result-stats { display: flex; gap: 20px; }
    .result-stat { display: flex; flex-direction: column; }
    .result-stat-label { font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600; }
    .result-stat-value { font-size: 16px; font-weight: 700; color: #1a1a1a; }
    .result-stat-value.pendente { color: #dc2626; }
    .result-stat-value.pago { color: #16a34a; }

    /* Client Detail Section */
    .client-detail { display: none; }
    .client-detail.active { display: block; }
    .back-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; color: #374151; cursor: pointer; margin-bottom: 20px; transition: all 0.2s; }
    .back-btn:hover { background: #e5e7eb; }

    /* Client Card */
    .client-card { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 20px; padding: 28px; margin-bottom: 24px; color: #fff; }
    .client-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .client-avatar { width: 70px; height: 70px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 900; color: #1a1a1a; }
    .client-info { flex: 1; margin-left: 20px; }
    .client-name { font-size: 26px; font-weight: 800; margin-bottom: 8px; }
    .client-contact { display: flex; flex-wrap: wrap; gap: 16px; font-size: 14px; color: #a1a1aa; }
    .client-contact span { display: flex; align-items: center; gap: 6px; }
    .client-contact i { color: #F6C84C; }
    .client-status-badge { padding: 8px 16px; border-radius: 10px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
    .client-status-badge.inadimplente { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
    .client-status-badge.regular { background: rgba(246, 200, 76, 0.2); color: #F6C84C; }
    .client-status-badge.bom_pagador { background: rgba(34, 197, 94, 0.2); color: #86efac; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat-card { background: rgba(255,255,255,0.1); border-radius: 14px; padding: 18px; text-align: center; }
    .stat-card.destaque { background: linear-gradient(135deg, #F6C84C, #F9D77E); }
    .stat-card.destaque .stat-label, .stat-card.destaque .stat-value { color: #1a1a1a; }
    .stat-label { font-size: 11px; color: #a1a1aa; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 8px; }
    .stat-value { font-size: 24px; font-weight: 900; color: #fff; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #fff; padding: 8px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .tab-btn { flex: 1; padding: 14px 20px; border: none; background: transparent; border-radius: 10px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .tab-btn:hover { background: #f3f4f6; }
    .tab-btn.active { background: #1a1a1a; color: #F6C84C; }
    .tab-btn .count { background: rgba(246,200,76,0.2); color: #F6C84C; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
    .tab-btn.active .count { background: #F6C84C; color: #1a1a1a; }

    /* Cobran√ßas Table */
    .cobrancas-section { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th { background: #f8f9fa; padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
    tbody td { padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; }
    tbody tr:hover { background: #fefce8; }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .status-badge.pago { background: #dcfce7; color: #16a34a; }
    .status-badge.pendente { background: #fef3c7; color: #d97706; }
    .status-badge.vencido { background: #fee2e2; color: #dc2626; }
    .status-badge.negociando { background: #dbeafe; color: #2563eb; }
    .valor-cell { font-weight: 700; }
    .valor-cell.pendente { color: #dc2626; }
    .valor-cell.pago { color: #16a34a; }

    /* Actions */
    .action-btn { padding: 8px 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .action-btn.primary { background: #F6C84C; color: #1a1a1a; }
    .action-btn.secondary { background: #f3f4f6; color: #374151; }
    .action-btn:hover { transform: translateY(-1px); }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
    .empty-state i { font-size: 48px; color: #d1d5db; margin-bottom: 16px; }
    .empty-state h3 { font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 8px; }

    /* Loading */
    .loading { display: none; text-align: center; padding: 40px; }
    .loading.active { display: block; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #F6C84C; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Quick Actions */
    .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; }
    .quick-action-btn { padding: 12px 24px; border: 2px solid #e5e7eb; background: #fff; border-radius: 12px; font-size: 14px; font-weight: 600; color: #374151; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .quick-action-btn:hover { border-color: #F6C84C; background: #fefce8; }
    .quick-action-btn i { color: #F6C84C; }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; }
      .stats-grid { grid-template-columns: 1fr; }
      .search-box { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="logo-section">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
      <li class="nav-item"><a href="cobrancas.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobran√ßas</a></li>
      <li class="nav-item"><a href="clientes-ativos.html" class="nav-link"><i class="fas fa-users"></i> Clientes</a></li>
      <li class="nav-item"><a href="consulta-cliente.html" class="nav-link active"><i class="fas fa-search-dollar"></i> Consulta Cliente</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="nova-cobranca.html" class="nav-link"><i class="fas fa-plus-circle"></i> Nova Cobran√ßa</a></li>
      <li class="nav-item"><a href="novo-cliente.html" class="nav-link"><i class="fas fa-user-plus"></i> Novo Cliente</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="agendamentos.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Agendamentos</a></li>
      <li class="nav-item"><a href="cobrancas-recorrentes.html" class="nav-link"><i class="fas fa-redo"></i> Recorrentes</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="historico.html" class="nav-link"><i class="fas fa-history"></i> Hist√≥rico</a></li>
      <li class="nav-item"><a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configura√ß√µes</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="page-header">
      <div class="page-title">
        <h1><i class="fas fa-search-dollar" style="color: #F6C84C; margin-right: 12px;"></i>Consulta de Cliente</h1>
        <p>Busque por nome ou CPF/CNPJ para ver o hist√≥rico completo de d√≠vidas</p>
      </div>
    </header>

    <!-- Search Section -->
    <section class="search-section">
      <div class="search-box">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchInput" class="search-input" placeholder="Digite o nome ou CPF/CNPJ do cliente..." autofocus>
        </div>
        <button type="button" class="search-btn" onclick="buscarClientes()">
          <i class="fas fa-search"></i> Buscar
        </button>
      </div>
    </section>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Buscando clientes...</p>
    </div>

    <!-- Results Section -->
    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <h3><i class="fas fa-users" style="color: #F6C84C; margin-right: 8px;"></i>Resultados da Busca</h3>
        <span class="results-count" id="resultsCount">0 encontrados</span>
      </div>
      <div class="results-list" id="resultsList"></div>
    </section>

    <!-- Client Detail Section -->
    <section class="client-detail" id="clientDetail">
      <button class="back-btn" onclick="voltarBusca()">
        <i class="fas fa-arrow-left"></i> Voltar para busca
      </button>

      <!-- Client Card -->
      <div class="client-card" id="clientCard">
        <!-- Preenchido via JS -->
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="novaCobrancaCliente()">
          <i class="fas fa-plus"></i> Nova Cobran√ßa
        </button>
        <button class="quick-action-btn" onclick="novoAgendamento()">
          <i class="fas fa-calendar-plus"></i> Agendar Contato
        </button>
        <button class="quick-action-btn" onclick="gerarPdfDividas()">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
        <button class="quick-action-btn" onclick="enviarWhatsApp()">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="todas" onclick="filtrarCobrancas('todas')">
          <i class="fas fa-list"></i> Todas <span class="count" id="countTodas">0</span>
        </button>
        <button class="tab-btn" data-tab="pendentes" onclick="filtrarCobrancas('pendentes')">
          <i class="fas fa-clock"></i> Pendentes <span class="count" id="countPendentes">0</span>
        </button>
        <button class="tab-btn" data-tab="vencidas" onclick="filtrarCobrancas('vencidas')">
          <i class="fas fa-exclamation-triangle"></i> Vencidas <span class="count" id="countVencidas">0</span>
        </button>
        <button class="tab-btn" data-tab="pagas" onclick="filtrarCobrancas('pagas')">
          <i class="fas fa-check-circle"></i> Pagas <span class="count" id="countPagas">0</span>
        </button>
      </div>

      <!-- Cobran√ßas Table -->
      <div class="cobrancas-section">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Vencimento</th>
                <th>Descri√ß√£o</th>
                <th>Valor Original</th>
                <th>Valor Atual</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="cobrancasTableBody">
              <!-- Preenchido via JS -->
            </tbody>
          </table>
        </div>
        <div class="empty-state" id="emptyCobrancas" style="display: none;">
          <i class="fas fa-inbox"></i>
          <h3>Nenhuma cobran√ßa encontrada</h3>
          <p>Este cliente n√£o possui cobran√ßas registradas.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = '';
    let token = localStorage.getItem('token');
    let clienteAtual = null;
    let cobrancasCliente = [];

    // Verificar autentica√ß√£o
    if (!token) {
      window.location.href = 'login.html';
    }

    // Headers padr√£o
    function getHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    // Formatadores
    function fmtMoney(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    }

    function fmtDate(dateStr) {
      if (!dateStr) return '‚Äî';
      const d = new Date(dateStr);
      return d.toLocaleDateString('pt-BR');
    }

    // Buscar com Enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        buscarClientes();
      }
    });

    // Buscar clientes
    async function buscarClientes() {
      const query = document.getElementById('searchInput').value.trim();
      if (query.length < 2) {
        alert('Digite pelo menos 2 caracteres para buscar.');
        return;
      }

      document.getElementById('loading').classList.add('active');
      document.getElementById('resultsSection').classList.remove('active');
      document.getElementById('clientDetail').classList.remove('active');

      try {
        const res = await fetch(`${API_BASE}/api/clientes/buscar?q=${encodeURIComponent(query)}`, {
          headers: getHeaders()
        });
        const data = await res.json();

        document.getElementById('loading').classList.remove('active');

        if (data.success && data.data.length > 0) {
          renderizarResultados(data.data);
        } else {
          document.getElementById('resultsSection').classList.add('active');
          document.getElementById('resultsList').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-search"></i>
              <h3>Nenhum cliente encontrado</h3>
              <p>Tente buscar por outro nome ou CPF/CNPJ.</p>
            </div>
          `;
          document.getElementById('resultsCount').textContent = '0 encontrados';
        }
      } catch (err) {
        document.getElementById('loading').classList.remove('active');
        console.error('Erro ao buscar:', err);
        alert('Erro ao buscar clientes. Tente novamente.');
      }
    }

    // Renderizar resultados
    function renderizarResultados(clientes) {
      const container = document.getElementById('resultsList');
      document.getElementById('resultsCount').textContent = `${clientes.length} encontrado${clientes.length !== 1 ? 's' : ''}`;

      container.innerHTML = clientes.map(c => {
        const devendoBadge = c.divida_total > 0 ? 'devendo' : 'em-dia';
        const devendoTexto = c.divida_total > 0 ? 'Devendo' : 'Em dia';
        return `
          <div class="result-card" onclick="carregarCliente('${c.id}')">
            <div class="result-card-header">
              <div>
                <div class="result-name">${c.nome}</div>
                <div class="result-cpf">${c.cpf_cnpj || 'CPF/CNPJ n√£o informado'}</div>
              </div>
              <span class="result-badge ${devendoBadge}">${devendoTexto}</span>
            </div>
            <div class="result-stats">
              <div class="result-stat">
                <span class="result-stat-label">Cobran√ßas</span>
                <span class="result-stat-value">${c.total_cobrancas || 0}</span>
              </div>
              <div class="result-stat">
                <span class="result-stat-label">Total Pendente</span>
                <span class="result-stat-value pendente">${fmtMoney(c.divida_total)}</span>
              </div>
              <div class="result-stat">
                <span class="result-stat-label">Total Pago</span>
                <span class="result-stat-value pago">${fmtMoney(c.total_pago)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('resultsSection').classList.add('active');
    }

    // Carregar detalhes do cliente
    async function carregarCliente(clienteId) {
      document.getElementById('loading').classList.add('active');
      document.getElementById('resultsSection').classList.remove('active');

      try {
        const res = await fetch(`${API_BASE}/api/clientes/${clienteId}/completo`, {
          headers: getHeaders()
        });
        const data = await res.json();

        document.getElementById('loading').classList.remove('active');

        if (data.success) {
          clienteAtual = data.data.cliente;
          cobrancasCliente = data.data.cobrancas;
          const stats = data.data.estatisticas;

          renderizarClienteCard(clienteAtual, stats);
          renderizarCobrancas(cobrancasCliente);
          atualizarContadores(stats);

          document.getElementById('clientDetail').classList.add('active');
        } else {
          alert('Erro ao carregar cliente.');
        }
      } catch (err) {
        document.getElementById('loading').classList.remove('active');
        console.error('Erro:', err);
        alert('Erro ao carregar cliente.');
      }
    }

    // Renderizar card do cliente
    function renderizarClienteCard(cliente, stats) {
      const statusClass = cliente.status_cliente || 'regular';
      const statusLabels = {
        'regular': 'Regular',
        'inadimplente': 'Inadimplente',
        'negociando': 'Negociando',
        'bom_pagador': 'Bom Pagador',
        'novo': 'Novo',
        'juridico': 'Jur√≠dico'
      };

      document.getElementById('clientCard').innerHTML = `
        <div class="client-card-header">
          <div style="display: flex; align-items: center;">
            <div class="client-avatar">${cliente.nome.charAt(0).toUpperCase()}</div>
            <div class="client-info">
              <div class="client-name">${cliente.nome}</div>
              <div class="client-contact">
                ${cliente.cpf_cnpj ? `<span><i class="fas fa-id-card"></i> ${cliente.cpf_cnpj}</span>` : ''}
                ${cliente.telefone ? `<span><i class="fas fa-phone"></i> ${cliente.telefone}</span>` : ''}
                ${cliente.email ? `<span><i class="fas fa-envelope"></i> ${cliente.email}</span>` : ''}
              </div>
            </div>
          </div>
          <span class="client-status-badge ${statusClass}">${statusLabels[statusClass] || statusClass}</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card destaque">
            <div class="stat-label">Total Pendente</div>
            <div class="stat-value">${fmtMoney(stats.valor_pendente)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Pago</div>
            <div class="stat-value">${fmtMoney(stats.valor_pago)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Cobran√ßas</div>
            <div class="stat-value">${stats.total_cobrancas}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Vencidas</div>
            <div class="stat-value">${stats.total_vencidas}</div>
          </div>
        </div>
      `;
    }

    // Atualizar contadores das tabs
    function atualizarContadores(stats) {
      document.getElementById('countTodas').textContent = stats.total_cobrancas;
      document.getElementById('countPendentes').textContent = stats.total_pendentes;
      document.getElementById('countVencidas').textContent = stats.total_vencidas;
      document.getElementById('countPagas').textContent = stats.total_pagas;
    }

    // Renderizar cobran√ßas
    function renderizarCobrancas(cobrancas, filtro = 'todas') {
      const tbody = document.getElementById('cobrancasTableBody');
      const empty = document.getElementById('emptyCobrancas');

      let filtradas = cobrancas;
      if (filtro === 'pendentes') filtradas = cobrancas.filter(c => c.status === 'pendente');
      else if (filtro === 'vencidas') filtradas = cobrancas.filter(c => c.status === 'vencido');
      else if (filtro === 'pagas') filtradas = cobrancas.filter(c => c.status === 'pago');

      if (filtradas.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      tbody.innerHTML = filtradas.map(c => {
        const valorClass = c.status === 'pago' ? 'pago' : 'pendente';
        return `
          <tr>
            <td>${fmtDate(c.vencimento)}</td>
            <td>${c.descricao || '‚Äî'}</td>
            <td>${fmtMoney(c.valor_original)}</td>
            <td class="valor-cell ${valorClass}">${fmtMoney(c.valor_atualizado)}</td>
            <td><span class="status-badge ${c.status}">${c.status.toUpperCase()}</span></td>
            <td>
              <button class="action-btn secondary" onclick="verCobranca('${c.id}')" title="Ver detalhes">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filtrar cobran√ßas por tab
    function filtrarCobrancas(filtro) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === filtro);
      });
      renderizarCobrancas(cobrancasCliente, filtro);
    }

    // Voltar para busca
    function voltarBusca() {
      document.getElementById('clientDetail').classList.remove('active');
      document.getElementById('resultsSection').classList.add('active');
    }

    // A√ß√µes r√°pidas
    function novaCobrancaCliente() {
      if (clienteAtual) {
        window.location.href = `nova-cobranca.html?cliente_id=${clienteAtual.id}&cliente_nome=${encodeURIComponent(clienteAtual.nome)}`;
      }
    }

    function novoAgendamento() {
      if (clienteAtual) {
        window.location.href = `novo-agendamento.html?cliente_id=${clienteAtual.id}`;
      }
    }

    async function gerarPdfDividas() {
      if (!clienteAtual) return;
      try {
        const res = await fetch(`${API_BASE}/api/clientes/${clienteAtual.id}/pdf-dividas`, {
          headers: getHeaders()
        });
        if (res.ok) {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
        } else {
          alert('Erro ao gerar PDF.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao gerar PDF.');
      }
    }

    function enviarWhatsApp() {
      if (!clienteAtual || !clienteAtual.telefone) {
        alert('Cliente n√£o possui telefone cadastrado.');
        return;
      }
      let tel = clienteAtual.telefone.replace(/\D/g, '');
      if (tel.length === 10 || tel.length === 11) tel = '55' + tel;
      
      const totalPendente = cobrancasCliente
        .filter(c => ['pendente', 'vencido'].includes(c.status))
        .reduce((acc, c) => acc + Number(c.valor_atualizado || 0), 0);

      const msg = `Ol√°, *${clienteAtual.nome}*! üëã\n\n` +
        `üìä *Resumo de Pend√™ncias*\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üí∞ *Total Pendente:* ${fmtMoney(totalPendente)}\n\n` +
        `Entre em contato para regularizar sua situa√ß√£o.\n\n` +
        `_ACERTIVE - Sistema de Cobran√ßas_`;

      window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function verCobranca(id) {
      window.location.href = `cobrancas.html?id=${id}`;
    }
  </script>
</body>
</html>