<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gest√£o de Usu√°rios | ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0d0d0d 100%);
      min-height: 100vh;
      color: #e0e0e0;
    }
    .navbar {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 15px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #F6C84C;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .navbar-logo {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 22px;
      color: #1a1a1a;
    }
    .navbar-title {
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-menu {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .navbar-menu a {
      color: #e0e0e0;
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
    }
    .navbar-menu a:hover, .navbar-menu a.active {
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      color: #1a1a1a;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    .page-title {
      font-size: 32px;
      font-weight: 900;
      color: #fff;
    }
    .btn {
      padding: 12px 25px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      color: #1a1a1a;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(246, 200, 76, 0.4);
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    .btn-success {
      background: #16a34a;
      color: #fff;
    }
    .btn-sm {
      padding: 8px 15px;
      font-size: 12px;
    }
    .table-card {
      background: linear-gradient(145deg, #1e1e1e, #252525);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #333;
    }
    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-title {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead th {
      background: #252525;
      padding: 15px 20px;
      text-align: left;
      font-size: 11px;
      font-weight: 800;
      color: #888;
      text-transform: uppercase;
    }
    tbody tr {
      border-bottom: 1px solid #2a2a2a;
      transition: background 0.2s;
    }
    tbody tr:hover {
      background: rgba(246, 200, 76, 0.05);
    }
    tbody td {
      padding: 15px 20px;
      font-size: 13px;
      color: #ccc;
    }
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
    }
    .badge-admin {
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      color: #1a1a1a;
    }
    .badge-operador {
      background: #dbeafe;
      color: #1e40af;
    }
    .badge-ativo {
      background: #dcfce7;
      color: #166534;
    }
    .badge-inativo {
      background: #fee2e2;
      color: #991b1b;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 14px;
      color: #1a1a1a;
    }
    .user-details .user-name {
      font-weight: 700;
      color: #fff;
      margin-bottom: 2px;
    }
    .user-details .user-email {
      font-size: 12px;
      color: #888;
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: linear-gradient(145deg, #1e1e1e, #252525);
      border-radius: 20px;
      padding: 30px;
      width: 100%;
      max-width: 500px;
      border: 1px solid #333;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 22px;
      font-weight: 900;
      color: #fff;
      margin-bottom: 25px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 2px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #F6C84C;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #dc2626;
    }
    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #16a34a;
    }
    .access-denied {
      text-align: center;
      padding: 100px 20px;
    }
    .access-denied-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .access-denied h2 {
      color: #fff;
      margin-bottom: 10px;
    }
    .access-denied p {
      color: #888;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-logo">A</div>
      <span class="navbar-title">ACERTIVE</span>
    </div>
    <div class="navbar-menu">
      <a href="/dashboard">Dashboard</a>
      <a href="/cobrancas">Cobran√ßas</a>
      <a href="/clientes-ativos">Clientes</a>
      <a href="/historico">Hist√≥rico</a>
      <a href="/usuarios" class="active">Usu√°rios</a>
      <a href="/login" id="btnLogout">Sair</a>
    </div>
  </nav>

  <div class="container">
    <div id="conteudoPrincipal">
      <div class="loading">Verificando permiss√µes...</div>
    </div>
  </div>

  <!-- Modal Criar/Editar Usu√°rio -->
  <div class="modal-overlay" id="modalUsuario">
    <div class="modal">
      <h2 class="modal-title" id="modalTitulo">Novo Usu√°rio</h2>
      <div id="modalAlert"></div>
      <form id="formUsuario">
        <input type="hidden" id="usuarioId" />
        <div class="form-group">
          <label>Nome Completo *</label>
          <input type="text" id="usuarioNome" required placeholder="Ex: Jo√£o Silva" />
        </div>
        <div class="form-group">
          <label>E-mail *</label>
          <input type="email" id="usuarioEmail" required placeholder="Ex: joao@empresa.com" />
        </div>
        <div class="form-group">
          <label>Senha <span id="senhaObrigatoria">*</span></label>
          <input type="password" id="usuarioSenha" placeholder="M√≠nimo 6 caracteres" />
        </div>
        <div class="form-group">
          <label>N√≠vel de Acesso *</label>
          <select id="usuarioNivel" required>
            <option value="operador">Operador</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">üíæ Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let usuarioAtual = null;
    let editandoId = null;

    function getToken() { return localStorage.getItem('token'); }
    function checkAuth() { if (!getToken()) window.location.href = '/login'; }

    document.getElementById('btnLogout').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    function getIniciais(nome) {
      if (!nome) return '?';
      return nome.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
    }

    function formatarData(data) {
      if (!data) return '‚Äî';
      return new Date(data).toLocaleDateString('pt-BR');
    }

    async function verificarPermissao() {
      try {
        const res = await fetch(`${API_URL}/api/usuarios/me`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await res.json();
        
        if (!data.success) {
          mostrarAcessoNegado();
          return;
        }

        usuarioAtual = data.data;

        if (usuarioAtual.nivel !== 'admin') {
          mostrarAcessoNegado();
          return;
        }

        renderizarPagina();
        carregarUsuarios();
      } catch (err) {
        console.error(err);
        mostrarAcessoNegado();
      }
    }

    function mostrarAcessoNegado() {
      document.getElementById('conteudoPrincipal').innerHTML = `
        <div class="access-denied">
          <div class="access-denied-icon">üîí</div>
          <h2>Acesso Restrito</h2>
          <p>Apenas administradores podem acessar esta p√°gina.</p>
          <br>
          <a href="/dashboard" class="btn btn-primary">Voltar ao Dashboard</a>
        </div>
      `;
    }

    function renderizarPagina() {
      document.getElementById('conteudoPrincipal').innerHTML = `
        <div class="page-header">
          <h1 class="page-title">üë• Gest√£o de Usu√°rios</h1>
          <button class="btn btn-primary" onclick="abrirModalNovo()">‚ûï Novo Usu√°rio</button>
        </div>
        <div class="table-card">
          <div class="table-header">
            <h3 class="table-title">Usu√°rios do Sistema</h3>
          </div>
          <div id="tabelaContainer">
            <div class="loading">Carregando...</div>
          </div>
        </div>
      `;
    }

    async function carregarUsuarios() {
      const container = document.getElementById('tabelaContainer');
      
      try {
        const res = await fetch(`${API_URL}/api/usuarios`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await res.json();

        if (!data.success) {
          container.innerHTML = `<div class="empty-state">Erro: ${data.message}</div>`;
          return;
        }

        if (!data.data?.length) {
          container.innerHTML = '<div class="empty-state">Nenhum usu√°rio encontrado</div>';
          return;
        }

        let html = `<table><thead><tr><th>Usu√°rio</th><th>N√≠vel</th><th>Status</th><th>Criado em</th><th>A√ß√µes</th></tr></thead><tbody>`;
        
        data.data.forEach(user => {
          const isMe = user.id === usuarioAtual.id;
          html += `<tr>
            <td>
              <div class="user-info">
                <div class="user-avatar">${getIniciais(user.nome)}</div>
                <div class="user-details">
                  <div class="user-name">${user.nome} ${isMe ? '(voc√™)' : ''}</div>
                  <div class="user-email">${user.email}</div>
                </div>
              </div>
            </td>
            <td><span class="badge badge-${user.nivel}">${user.nivel}</span></td>
            <td><span class="badge badge-${user.ativo ? 'ativo' : 'inativo'}">${user.ativo ? 'Ativo' : 'Inativo'}</span></td>
            <td>${formatarData(user.created_at)}</td>
            <td class="actions">
              <button class="btn btn-primary btn-sm" onclick="editarUsuario('${user.id}')">‚úèÔ∏è Editar</button>
              ${!isMe ? (user.ativo 
                ? `<button class="btn btn-danger btn-sm" onclick="desativarUsuario('${user.id}')">üö´ Desativar</button>`
                : `<button class="btn btn-success btn-sm" onclick="ativarUsuario('${user.id}')">‚úÖ Ativar</button>`
              ) : ''}
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="empty-state">Erro ao carregar usu√°rios</div>';
      }
    }

    function abrirModalNovo() {
      editandoId = null;
      document.getElementById('modalTitulo').textContent = 'Novo Usu√°rio';
      document.getElementById('formUsuario').reset();
      document.getElementById('usuarioSenha').required = true;
      document.getElementById('senhaObrigatoria').textContent = '*';
      document.getElementById('modalAlert').innerHTML = '';
      document.getElementById('modalUsuario').classList.add('active');
    }

    async function editarUsuario(id) {
      editandoId = id;
      document.getElementById('modalTitulo').textContent = 'Editar Usu√°rio';
      document.getElementById('usuarioSenha').required = false;
      document.getElementById('senhaObrigatoria').textContent = '(deixe vazio para manter)';
      document.getElementById('modalAlert').innerHTML = '';

      try {
        const res = await fetch(`${API_URL}/api/usuarios`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await res.json();
        const user = data.data.find(u => u.id === id);

        if (user) {
          document.getElementById('usuarioId').value = user.id;
          document.getElementById('usuarioNome').value = user.nome;
          document.getElementById('usuarioEmail').value = user.email;
          document.getElementById('usuarioSenha').value = '';
          document.getElementById('usuarioNivel').value = user.nivel;
          document.getElementById('modalUsuario').classList.add('active');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar usu√°rio');
      }
    }

    function fecharModal() {
      document.getElementById('modalUsuario').classList.remove('active');
    }

    document.getElementById('formUsuario').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nome = document.getElementById('usuarioNome').value.trim();
      const email = document.getElementById('usuarioEmail').value.trim();
      const senha = document.getElementById('usuarioSenha').value;
      const nivel = document.getElementById('usuarioNivel').value;

      if (!editandoId && senha.length < 6) {
        document.getElementById('modalAlert').innerHTML = '<div class="alert alert-error">Senha deve ter no m√≠nimo 6 caracteres</div>';
        return;
      }

      const body = { nome, email, nivel };
      if (senha) body.senha = senha;

      try {
        const url = editandoId ? `${API_URL}/api/usuarios/${editandoId}` : `${API_URL}/api/usuarios`;
        const method = editandoId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (!data.success) {
          document.getElementById('modalAlert').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
          return;
        }

        fecharModal();
        carregarUsuarios();
      } catch (err) {
        console.error(err);
        document.getElementById('modalAlert').innerHTML = '<div class="alert alert-error">Erro ao salvar usu√°rio</div>';
      }
    });

    async function desativarUsuario(id) {
      if (!confirm('Tem certeza que deseja desativar este usu√°rio?')) return;

      try {
        const res = await fetch(`${API_URL}/api/usuarios/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await res.json();

        if (!data.success) {
          alert(data.message);
          return;
        }

        carregarUsuarios();
      } catch (err) {
        console.error(err);
        alert('Erro ao desativar usu√°rio');
      }
    }

    async function ativarUsuario(id) {
      try {
        const res = await fetch(`${API_URL}/api/usuarios/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({ ativo: true })
        });
        const data = await res.json();

        if (!data.success) {
          alert(data.message);
          return;
        }

        carregarUsuarios();
      } catch (err) {
        console.error(err);
        alert('Erro ao ativar usu√°rio');
      }
    }

    // Fechar modal ao clicar fora
    document.getElementById('modalUsuario').addEventListener('click', (e) => {
      if (e.target.id === 'modalUsuario') fecharModal();
    });

    checkAuth();
    verificarPermissao();
  </script>
</body>
</html>