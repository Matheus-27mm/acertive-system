<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importar Cobranças - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; min-height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar { width: 260px; background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; padding: 20px 0; position: fixed; left: 0; top: 0; z-index: 100; }
    .logo-section { padding: 0 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; color: #1a1a1a; }
    .logo-text { font-size: 22px; font-weight: 800; color: #fff; }
    .logo-text span { color: #F6C84C; }
    .nav-menu { list-style: none; padding: 0 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #a1a1aa; text-decoration: none; border-radius: 12px; transition: all 0.2s; font-weight: 500; }
    .nav-link:hover, .nav-link.active { background: rgba(246, 200, 76, 0.1); color: #F6C84C; }
    .nav-link i { width: 20px; text-align: center; font-size: 16px; }
    .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 16px 12px; }

    /* Main Content */
    .main-content { flex: 1; margin-left: 260px; padding: 24px; }

    /* Header */
    .page-header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 20px; padding: 28px 32px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #F6C84C; }
    .page-title h1 { font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 6px; }
    .page-title p { color: #a1a1aa; font-size: 14px; }

    /* Upload Section */
    .upload-section { background: #fff; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 24px; }
    .upload-area { border: 3px dashed #e5e7eb; border-radius: 16px; padding: 60px 40px; text-align: center; transition: all 0.3s; cursor: pointer; }
    .upload-area:hover, .upload-area.dragover { border-color: #F6C84C; background: #fefce8; }
    .upload-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
    .upload-icon i { font-size: 36px; color: #1a1a1a; }
    .upload-title { font-size: 22px; font-weight: 700; color: #1a1a1a; margin-bottom: 12px; }
    .upload-subtitle { color: #6b7280; font-size: 15px; margin-bottom: 24px; }
    .upload-btn { display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border: none; border-radius: 12px; font-size: 16px; font-weight: 700; color: #1a1a1a; cursor: pointer; transition: all 0.2s; }
    .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(246, 200, 76, 0.4); }
    .upload-formats { margin-top: 20px; font-size: 13px; color: #9ca3af; }
    .upload-formats span { background: #f3f4f6; padding: 4px 10px; border-radius: 6px; margin: 0 4px; font-weight: 600; }
    input[type="file"] { display: none; }

    /* File Selected */
    .file-selected { display: none; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 24px; }
    .file-selected.active { display: flex; align-items: center; justify-content: space-between; }
    .file-info { display: flex; align-items: center; gap: 16px; }
    .file-icon { width: 50px; height: 50px; background: #dcfce7; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .file-icon i { font-size: 24px; color: #16a34a; }
    .file-name { font-weight: 700; color: #1a1a1a; font-size: 16px; }
    .file-size { font-size: 13px; color: #6b7280; }
    .file-remove { padding: 10px 20px; background: #fee2e2; border: none; border-radius: 10px; color: #dc2626; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .file-remove:hover { background: #fecaca; }

    /* Import Button */
    .import-actions { display: none; margin-top: 24px; }
    .import-actions.active { display: flex; gap: 16px; justify-content: center; }
    .import-btn { padding: 18px 48px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 14px; font-size: 18px; font-weight: 700; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
    .import-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4); }
    .import-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* Progress Section */
    .progress-section { display: none; background: #fff; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 24px; text-align: center; }
    .progress-section.active { display: block; }
    .progress-spinner { width: 60px; height: 60px; border: 5px solid #e5e7eb; border-top-color: #F6C84C; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 24px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-title { font-size: 20px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px; }
    .progress-subtitle { color: #6b7280; font-size: 15px; }

    /* Results Section */
    .results-section { display: none; background: #fff; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .results-section.active { display: block; }
    .results-header { text-align: center; margin-bottom: 32px; }
    .results-icon { width: 80px; height: 80px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
    .results-icon i { font-size: 40px; color: #16a34a; }
    .results-icon.error { background: #fee2e2; }
    .results-icon.error i { color: #dc2626; }
    .results-title { font-size: 24px; font-weight: 800; color: #1a1a1a; margin-bottom: 8px; }
    .results-subtitle { color: #6b7280; font-size: 16px; }

    /* Stats Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: #f8f9fa; border-radius: 14px; padding: 24px; text-align: center; }
    .stat-card.success { background: #dcfce7; }
    .stat-card.warning { background: #fef3c7; }
    .stat-card.info { background: #dbeafe; }
    .stat-value { font-size: 32px; font-weight: 900; color: #1a1a1a; margin-bottom: 8px; }
    .stat-card.success .stat-value { color: #16a34a; }
    .stat-card.warning .stat-value { color: #d97706; }
    .stat-card.info .stat-value { color: #2563eb; }
    .stat-label { font-size: 13px; color: #6b7280; font-weight: 600; text-transform: uppercase; }

    /* Action Buttons */
    .results-actions { display: flex; gap: 16px; justify-content: center; }
    .action-btn { padding: 14px 28px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s; text-decoration: none; }
    .action-btn.primary { background: linear-gradient(135deg, #F6C84C, #F9D77E); border: none; color: #1a1a1a; }
    .action-btn.secondary { background: #fff; border: 2px solid #e5e7eb; color: #374151; }
    .action-btn:hover { transform: translateY(-2px); }

    /* Info Box */
    .info-box { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
    .info-box h4 { color: #1e40af; font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .info-box ul { list-style: none; color: #3b82f6; font-size: 14px; }
    .info-box li { padding: 6px 0; padding-left: 20px; position: relative; }
    .info-box li::before { content: "✓"; position: absolute; left: 0; color: #22c55e; font-weight: 700; }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="logo-section">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
      <li class="nav-item"><a href="cobrancas.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a></li>
      <li class="nav-item"><a href="clientes-ativos.html" class="nav-link"><i class="fas fa-users"></i> Clientes</a></li>
      <li class="nav-item"><a href="consulta-cliente.html" class="nav-link"><i class="fas fa-search-dollar"></i> Consulta Cliente</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="nova-cobranca.html" class="nav-link"><i class="fas fa-plus-circle"></i> Nova Cobrança</a></li>
      <li class="nav-item"><a href="novo-cliente.html" class="nav-link"><i class="fas fa-user-plus"></i> Novo Cliente</a></li>
      <li class="nav-item"><a href="importar-cobrancas.html" class="nav-link active"><i class="fas fa-file-import"></i> Importar Cobranças</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="agendamentos.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Agendamentos</a></li>
      <li class="nav-item"><a href="cobrancas-recorrentes.html" class="nav-link"><i class="fas fa-redo"></i> Recorrentes</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="historico.html" class="nav-link"><i class="fas fa-history"></i> Histórico</a></li>
      <li class="nav-item"><a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="page-header">
      <div class="page-title">
        <h1><i class="fas fa-file-import" style="color: #F6C84C; margin-right: 12px;"></i>Importar Cobranças</h1>
        <p>Importe sua planilha de cobranças e associe automaticamente aos clientes</p>
      </div>
    </header>

    <!-- Info Box -->
    <div class="info-box">
      <h4><i class="fas fa-info-circle"></i> Como funciona a importação</h4>
      <ul>
        <li>O sistema lê cada linha da planilha como uma cobrança</li>
        <li>Se o cliente (por CPF/CNPJ ou nome) já existir, a cobrança é vinculada a ele</li>
        <li>Se o cliente não existir, ele é criado automaticamente</li>
        <li>Cobranças com valor pago são marcadas como "Pago"</li>
        <li>Cobranças vencidas são marcadas automaticamente</li>
      </ul>
    </div>

    <!-- Upload Section -->
    <section class="upload-section" id="uploadSection">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-title">Arraste sua planilha aqui</div>
        <div class="upload-subtitle">ou clique no botão abaixo para selecionar</div>
        <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-folder-open"></i> Selecionar Arquivo
        </button>
        <div class="upload-formats">
          Formatos aceitos: <span>.xlsx</span> <span>.xls</span> <span>.csv</span>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
      </div>

      <!-- File Selected -->
      <div class="file-selected" id="fileSelected">
        <div class="file-info">
          <div class="file-icon">
            <i class="fas fa-file-excel"></i>
          </div>
          <div>
            <div class="file-name" id="fileName">arquivo.xlsx</div>
            <div class="file-size" id="fileSize">2.5 MB</div>
          </div>
        </div>
        <button type="button" class="file-remove" onclick="removeFile()">
          <i class="fas fa-times"></i> Remover
        </button>
      </div>

      <!-- Import Actions -->
      <div class="import-actions" id="importActions">
        <button type="button" class="import-btn" id="importBtn" onclick="iniciarImportacao()">
          <i class="fas fa-rocket"></i> Iniciar Importação
        </button>
      </div>
    </section>

    <!-- Progress Section -->
    <section class="progress-section" id="progressSection">
      <div class="progress-spinner"></div>
      <div class="progress-title">Importando cobranças...</div>
      <div class="progress-subtitle">Aguarde, isso pode levar alguns minutos dependendo do tamanho do arquivo.</div>
    </section>

    <!-- Results Section -->
    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <div class="results-icon" id="resultsIcon">
          <i class="fas fa-check"></i>
        </div>
        <div class="results-title" id="resultsTitle">Importação Concluída!</div>
        <div class="results-subtitle" id="resultsSubtitle">Todas as cobranças foram processadas com sucesso.</div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card success">
          <div class="stat-value" id="statCobrancas">0</div>
          <div class="stat-label">Cobranças Criadas</div>
        </div>
        <div class="stat-card info">
          <div class="stat-value" id="statClientesCriados">0</div>
          <div class="stat-label">Clientes Criados</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statClientesExistentes">0</div>
          <div class="stat-label">Clientes Existentes</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value" id="statIgnoradas">0</div>
          <div class="stat-label">Linhas Ignoradas</div>
        </div>
      </div>

      <div class="results-actions">
        <a href="consulta-cliente.html" class="action-btn primary">
          <i class="fas fa-search"></i> Consultar Clientes
        </a>
        <a href="cobrancas.html" class="action-btn secondary">
          <i class="fas fa-list"></i> Ver Cobranças
        </a>
        <button type="button" class="action-btn secondary" onclick="novaImportacao()">
          <i class="fas fa-redo"></i> Nova Importação
        </button>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = '';
    let token = localStorage.getItem('token');
    let selectedFile = null;

    // Verificar autenticação
    if (!token) {
      window.location.href = 'login.html';
    }

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        processFile(files[0]);
      }
    });

    // File select
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processFile(file);
      }
    }

    // Process file
    function processFile(file) {
      const validExtensions = ['.xlsx', '.xls', '.csv'];
      const fileName = file.name.toLowerCase();
      const isValid = validExtensions.some(ext => fileName.endsWith(ext));

      if (!isValid) {
        alert('Formato de arquivo inválido. Use .xlsx, .xls ou .csv');
        return;
      }

      selectedFile = file;
      
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileSelected').classList.add('active');
      document.getElementById('importActions').classList.add('active');
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Remove file
    function removeFile() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('fileSelected').classList.remove('active');
      document.getElementById('importActions').classList.remove('active');
    }

    // Iniciar importação
    async function iniciarImportacao() {
      if (!selectedFile) {
        alert('Selecione um arquivo primeiro.');
        return;
      }

      const btn = document.getElementById('importBtn');
      btn.disabled = true;

      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('progressSection').classList.add('active');

      const formData = new FormData();
      formData.append('file', selectedFile);

      try {
        const res = await fetch(`${API_BASE}/api/cobrancas/import`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await res.json();

        document.getElementById('progressSection').classList.remove('active');
        document.getElementById('resultsSection').classList.add('active');

        if (data.success) {
          const r = data.resultado;
          document.getElementById('resultsIcon').innerHTML = '<i class="fas fa-check"></i>';
          document.getElementById('resultsIcon').classList.remove('error');
          document.getElementById('resultsTitle').textContent = 'Importação Concluída!';
          document.getElementById('resultsSubtitle').textContent = `${r.totalLinhas} linhas processadas com sucesso.`;
          
          document.getElementById('statCobrancas').textContent = r.cobrancasCriadas;
          document.getElementById('statClientesCriados').textContent = r.clientesCriados;
          document.getElementById('statClientesExistentes').textContent = r.clientesExistentes;
          document.getElementById('statIgnoradas').textContent = r.cobrancasIgnoradas;
        } else {
          document.getElementById('resultsIcon').innerHTML = '<i class="fas fa-times"></i>';
          document.getElementById('resultsIcon').classList.add('error');
          document.getElementById('resultsTitle').textContent = 'Erro na Importação';
          document.getElementById('resultsSubtitle').textContent = data.message || 'Ocorreu um erro ao processar o arquivo.';
        }
      } catch (err) {
        console.error('Erro:', err);
        document.getElementById('progressSection').classList.remove('active');
        document.getElementById('resultsSection').classList.add('active');
        document.getElementById('resultsIcon').innerHTML = '<i class="fas fa-times"></i>';
        document.getElementById('resultsIcon').classList.add('error');
        document.getElementById('resultsTitle').textContent = 'Erro na Importação';
        document.getElementById('resultsSubtitle').textContent = 'Erro de conexão. Tente novamente.';
      }
    }

    // Nova importação
    function novaImportacao() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('fileSelected').classList.remove('active');
      document.getElementById('importActions').classList.remove('active');
      document.getElementById('importBtn').disabled = false;
      document.getElementById('uploadSection').style.display = 'block';
      document.getElementById('resultsSection').classList.remove('active');
    }
  </script>
</body>
</html>