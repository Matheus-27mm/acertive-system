<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nova Cobrança - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; min-height: 100vh; display: flex; }

    .sidebar { width: 260px; background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; padding: 20px 0; position: fixed; left: 0; top: 0; z-index: 100; }
    .logo-section { padding: 0 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; color: #1a1a1a; }
    .logo-text { font-size: 22px; font-weight: 800; color: #fff; }
    .logo-text span { color: #F6C84C; }
    .nav-menu { list-style: none; padding: 0 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #a1a1aa; text-decoration: none; border-radius: 12px; transition: all 0.2s; font-weight: 500; }
    .nav-link:hover, .nav-link.active { background: rgba(246, 200, 76, 0.1); color: #F6C84C; }
    .nav-link i { width: 20px; text-align: center; font-size: 16px; }
    .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 16px 12px; }

    .main-content { flex: 1; margin-left: 260px; padding: 24px; }

    .page-header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 20px; padding: 28px 32px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #F6C84C; }
    .page-title h1 { font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 6px; }
    .page-title p { color: #a1a1aa; font-size: 14px; }

    .form-container { background: #fff; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

    .section-title { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6; }
    .section-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #F6C84C, #F9D77E); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .section-icon i { font-size: 18px; color: #1a1a1a; }
    .section-title h2 { font-size: 18px; font-weight: 700; color: #1a1a1a; }

    .client-tabs { display: flex; gap: 12px; margin-bottom: 24px; }
    .client-tab { flex: 1; padding: 16px 24px; border: 2px solid #e5e7eb; background: #fff; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .client-tab:hover { border-color: #F6C84C; }
    .client-tab.active { border-color: #F6C84C; background: #fefce8; }
    .client-tab i { font-size: 24px; color: #6b7280; margin-bottom: 8px; display: block; }
    .client-tab.active i { color: #F6C84C; }
    .client-tab-title { font-weight: 700; color: #1a1a1a; margin-bottom: 4px; }
    .client-tab-desc { font-size: 12px; color: #6b7280; }

    .client-section { display: none; margin-bottom: 24px; }
    .client-section.active { display: block; }

    .search-wrapper { position: relative; margin-bottom: 16px; }
    .search-input { width: 100%; padding: 16px 20px 16px 50px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; transition: all 0.2s; }
    .search-input:focus { outline: none; border-color: #F6C84C; box-shadow: 0 0 0 4px rgba(246, 200, 76, 0.15); }
    .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 18px; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #F6C84C; border-top: none; border-radius: 0 0 12px 12px; max-height: 300px; overflow-y: auto; display: none; z-index: 50; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .search-results.active { display: block; }
    .search-result-item { padding: 14px 18px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; }
    .search-result-item:hover { background: #fefce8; }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-name { font-weight: 700; color: #1a1a1a; margin-bottom: 4px; }
    .search-result-info { font-size: 12px; color: #6b7280; display: flex; gap: 16px; }
    .search-result-info span { display: flex; align-items: center; gap: 4px; }
    .search-no-results { padding: 20px; text-align: center; color: #6b7280; }

    .selected-client { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 14px; padding: 20px; display: none; }
    .selected-client.active { display: flex; align-items: center; justify-content: space-between; }
    .selected-client-info { display: flex; align-items: center; gap: 16px; }
    .selected-client-avatar { width: 50px; height: 50px; background: #F6C84C; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; color: #1a1a1a; }
    .selected-client-name { color: #fff; font-weight: 700; font-size: 16px; }
    .selected-client-cpf { color: #a1a1aa; font-size: 13px; }
    .selected-client-stats { display: flex; gap: 24px; }
    .selected-client-stat { text-align: center; }
    .selected-client-stat-value { color: #F6C84C; font-size: 18px; font-weight: 800; }
    .selected-client-stat-label { color: #a1a1aa; font-size: 11px; text-transform: uppercase; }
    .btn-change-client { padding: 10px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .btn-change-client:hover { background: rgba(255,255,255,0.2); }

    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group.full { grid-column: span 2; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    .form-label .required { color: #dc2626; }
    .form-control { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.2s; }
    .form-control:focus { outline: none; border-color: #F6C84C; box-shadow: 0 0 0 4px rgba(246, 200, 76, 0.15); }
    .form-control::placeholder { color: #9ca3af; }
    select.form-control { cursor: pointer; background: #fff; }
    textarea.form-control { resize: vertical; min-height: 100px; }

    .input-group { position: relative; }
    .input-prefix { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #6b7280; font-weight: 600; }
    .input-group .form-control { padding-left: 50px; }

    .form-actions { display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px; padding-top: 24px; border-top: 2px solid #f3f4f6; }
    .btn { padding: 14px 32px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #F6C84C, #F9D77E); border: none; color: #1a1a1a; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(246, 200, 76, 0.4); }
    .btn-secondary { background: #fff; border: 2px solid #e5e7eb; color: #374151; }
    .btn-secondary:hover { border-color: #d1d5db; background: #f9fafb; }

    .empresa-select { margin-bottom: 24px; }
    .empresa-select .form-control { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; font-weight: 600; }
    .empresa-select .form-control option { background: #fff; color: #1a1a1a; }

    .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: none; }
    .alert.success { background: #dcfce7; color: #166534; display: block; }
    .alert.error { background: #fee2e2; color: #991b1b; display: block; }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; }
      .form-grid { grid-template-columns: 1fr; }
      .form-group.full { grid-column: span 1; }
      .client-tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <nav class="sidebar">
    <div class="logo-section">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
      <li class="nav-item"><a href="cobrancas.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a></li>
      <li class="nav-item"><a href="clientes-ativos.html" class="nav-link"><i class="fas fa-users"></i> Clientes</a></li>
      <li class="nav-item"><a href="consulta-cliente.html" class="nav-link"><i class="fas fa-search-dollar"></i> Consulta Cliente</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="nova-cobranca.html" class="nav-link active"><i class="fas fa-plus-circle"></i> Nova Cobrança</a></li>
      <li class="nav-item"><a href="novo-cliente.html" class="nav-link"><i class="fas fa-user-plus"></i> Novo Cliente</a></li>
      <li class="nav-item"><a href="importar-cobrancas.html" class="nav-link"><i class="fas fa-file-import"></i> Importar Cobranças</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="agendamentos.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Agendamentos</a></li>
      <li class="nav-item"><a href="cobrancas-recorrentes.html" class="nav-link"><i class="fas fa-redo"></i> Recorrentes</a></li>
      <div class="nav-divider"></div>
      <li class="nav-item"><a href="historico.html" class="nav-link"><i class="fas fa-history"></i> Histórico</a></li>
      <li class="nav-item"><a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <div class="page-title">
        <h1><i class="fas fa-plus-circle" style="color: #F6C84C; margin-right: 12px;"></i>Nova Cobrança</h1>
        <p>Cadastre uma nova cobrança para um cliente</p>
      </div>
    </header>

    <div class="form-container">
      <div id="alertBox" class="alert"></div>

      <form id="cobrancaForm">
        <!-- Empresa -->
        <div class="empresa-select">
          <label class="form-label"><i class="fas fa-building" style="margin-right: 6px;"></i>Empresa Emissora</label>
          <select id="empresaId" class="form-control" required>
            <option value="">Carregando empresas...</option>
          </select>
        </div>

        <!-- Seção Cliente -->
        <div class="section-title">
          <div class="section-icon"><i class="fas fa-user"></i></div>
          <h2>Selecionar Cliente</h2>
        </div>

        <!-- Tabs de seleção -->
        <div class="client-tabs">
          <div class="client-tab active" data-tab="existente" onclick="selecionarTab('existente')">
            <i class="fas fa-search"></i>
            <div class="client-tab-title">Cliente Existente</div>
            <div class="client-tab-desc">Buscar cliente já cadastrado</div>
          </div>
          <div class="client-tab" data-tab="novo" onclick="selecionarTab('novo')">
            <i class="fas fa-user-plus"></i>
            <div class="client-tab-title">Novo Cliente</div>
            <div class="client-tab-desc">Cadastrar durante a cobrança</div>
          </div>
        </div>

        <!-- Buscar Cliente Existente -->
        <div class="client-section active" id="clienteExistente">
          <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchCliente" class="search-input" placeholder="Digite o nome ou CPF/CNPJ do cliente..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
          </div>
          <div class="selected-client" id="selectedClient">
            <div class="selected-client-info">
              <div class="selected-client-avatar" id="clienteAvatar">J</div>
              <div>
                <div class="selected-client-name" id="clienteNome">Nome do Cliente</div>
                <div class="selected-client-cpf" id="clienteCpf">CPF/CNPJ</div>
              </div>
            </div>
            <div class="selected-client-stats">
              <div class="selected-client-stat">
                <div class="selected-client-stat-value" id="clienteCobrancas">0</div>
                <div class="selected-client-stat-label">Cobranças</div>
              </div>
              <div class="selected-client-stat">
                <div class="selected-client-stat-value" id="clienteDivida">R$ 0</div>
                <div class="selected-client-stat-label">Pendente</div>
              </div>
            </div>
            <button type="button" class="btn-change-client" onclick="limparClienteSelecionado()">
              <i class="fas fa-times"></i> Alterar
            </button>
          </div>
          <input type="hidden" id="clienteId" name="cliente_id">
        </div>

        <!-- Cadastrar Novo Cliente -->
        <div class="client-section" id="clienteNovo">
          <div class="form-grid">
            <div class="form-group full">
              <label class="form-label">Nome Completo <span class="required">*</span></label>
              <input type="text" id="novoClienteNome" class="form-control" placeholder="Nome do cliente">
            </div>
            <div class="form-group">
              <label class="form-label">CPF/CNPJ</label>
              <input type="text" id="novoClienteCpf" class="form-control" placeholder="000.000.000-00">
            </div>
            <div class="form-group">
              <label class="form-label">Telefone</label>
              <input type="text" id="novoClienteTelefone" class="form-control" placeholder="(00) 00000-0000">
            </div>
            <div class="form-group full">
              <label class="form-label">E-mail</label>
              <input type="email" id="novoClienteEmail" class="form-control" placeholder="email@exemplo.com">
            </div>
          </div>
        </div>

        <!-- Seção Cobrança -->
        <div class="section-title" style="margin-top: 32px;">
          <div class="section-icon"><i class="fas fa-file-invoice-dollar"></i></div>
          <h2>Dados da Cobrança</h2>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Valor <span class="required">*</span></label>
            <div class="input-group">
              <span class="input-prefix">R$</span>
              <input type="text" id="valorOriginal" class="form-control" placeholder="0,00" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Vencimento <span class="required">*</span></label>
            <input type="date" id="vencimento" class="form-control" required>
          </div>
          <div class="form-group full">
            <label class="form-label">Descrição</label>
            <input type="text" id="descricao" class="form-control" placeholder="Ex: Mensalidade Janeiro/2026, Serviço prestado...">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select id="status" class="form-control">
              <option value="pendente">Pendente</option>
              <option value="pago">Pago</option>
              <option value="vencido">Vencido</option>
              <option value="negociando">Negociando</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Compromisso</label>
            <input type="date" id="dataCompromisso" class="form-control">
          </div>
          <div class="form-group full">
            <label class="form-label">Observações</label>
            <textarea id="observacoes" class="form-control" placeholder="Observações adicionais sobre a cobrança..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='cobrancas.html'">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-check"></i> Salvar Cobrança
          </button>
        </div>
      </form>
    </div>
  </main>

  <script>
    const API_BASE = '';
    let token = localStorage.getItem('token');
    let clienteSelecionado = null;
    let modoCliente = 'existente';
    let searchTimeout = null;

    if (!token) window.location.href = 'login.html';

    function getHeaders() {
      return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    function fmtMoney(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    }

    // Verificar parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const clienteIdParam = urlParams.get('cliente_id');
    const clienteNomeParam = urlParams.get('cliente_nome');

    // Carregar empresas
    async function carregarEmpresas() {
      try {
        const res = await fetch(`${API_BASE}/api/empresas`, { headers: getHeaders() });
        const data = await res.json();
        const select = document.getElementById('empresaId');
        if (data.success && data.data.length > 0) {
          select.innerHTML = data.data.map(e => 
            `<option value="${e.id}" ${e.padrao ? 'selected' : ''}>${e.nome}${e.padrao ? ' (Padrão)' : ''}</option>`
          ).join('');
        } else {
          select.innerHTML = '<option value="">Nenhuma empresa cadastrada</option>';
        }
      } catch (err) {
        console.error('Erro ao carregar empresas:', err);
      }
    }

    // Tabs de cliente
    function selecionarTab(tab) {
      document.querySelectorAll('.client-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.client-tab[data-tab="${tab}"]`).classList.add('active');
      document.querySelectorAll('.client-section').forEach(s => s.classList.remove('active'));
      document.getElementById(tab === 'existente' ? 'clienteExistente' : 'clienteNovo').classList.add('active');
      modoCliente = tab;
      if (tab === 'novo') {
        limparClienteSelecionado();
      }
    }

    // Busca de cliente com debounce
    document.getElementById('searchCliente').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      if (query.length < 2) {
        document.getElementById('searchResults').classList.remove('active');
        return;
      }
      searchTimeout = setTimeout(() => buscarClientes(query), 300);
    });

    document.getElementById('searchCliente').addEventListener('focus', function() {
      if (this.value.trim().length >= 2) {
        document.getElementById('searchResults').classList.add('active');
      }
    });

    // Fechar resultados ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-wrapper')) {
        document.getElementById('searchResults').classList.remove('active');
      }
    });

    async function buscarClientes(query) {
      try {
        const res = await fetch(`${API_BASE}/api/clientes/buscar?q=${encodeURIComponent(query)}`, { headers: getHeaders() });
        const data = await res.json();
        const container = document.getElementById('searchResults');
        
        if (data.success && data.data.length > 0) {
          container.innerHTML = data.data.map(c => `
            <div class="search-result-item" onclick="selecionarCliente(${JSON.stringify(c).replace(/"/g, '&quot;')})">
              <div class="search-result-name">${c.nome}</div>
              <div class="search-result-info">
                <span><i class="fas fa-id-card"></i> ${c.cpf_cnpj || 'Sem CPF'}</span>
                <span><i class="fas fa-file-invoice"></i> ${c.total_cobrancas || 0} cobranças</span>
                <span><i class="fas fa-exclamation-circle"></i> ${fmtMoney(c.divida_total)} pendente</span>
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="search-no-results"><i class="fas fa-search"></i> Nenhum cliente encontrado</div>';
        }
        container.classList.add('active');
      } catch (err) {
        console.error('Erro na busca:', err);
      }
    }

    function selecionarCliente(cliente) {
      clienteSelecionado = cliente;
      document.getElementById('clienteId').value = cliente.id;
      document.getElementById('clienteAvatar').textContent = cliente.nome.charAt(0).toUpperCase();
      document.getElementById('clienteNome').textContent = cliente.nome;
      document.getElementById('clienteCpf').textContent = cliente.cpf_cnpj || 'CPF/CNPJ não informado';
      document.getElementById('clienteCobrancas').textContent = cliente.total_cobrancas || 0;
      document.getElementById('clienteDivida').textContent = fmtMoney(cliente.divida_total);
      document.getElementById('selectedClient').classList.add('active');
      document.getElementById('searchCliente').style.display = 'none';
      document.getElementById('searchResults').classList.remove('active');
    }

    function limparClienteSelecionado() {
      clienteSelecionado = null;
      document.getElementById('clienteId').value = '';
      document.getElementById('selectedClient').classList.remove('active');
      document.getElementById('searchCliente').style.display = 'block';
      document.getElementById('searchCliente').value = '';
    }

    // Carregar cliente da URL
    async function carregarClienteUrl() {
      if (clienteIdParam) {
        try {
          const res = await fetch(`${API_BASE}/api/clientes/${clienteIdParam}/completo`, { headers: getHeaders() });
          const data = await res.json();
          if (data.success) {
            const c = data.data.cliente;
            const stats = data.data.estatisticas;
            selecionarCliente({
              id: c.id,
              nome: c.nome,
              cpf_cnpj: c.cpf_cnpj,
              total_cobrancas: stats.total_cobrancas,
              divida_total: stats.valor_pendente
            });
          }
        } catch (err) {
          console.error('Erro ao carregar cliente:', err);
        }
      }
    }

    // Máscaras
    document.getElementById('valorOriginal').addEventListener('input', function() {
      let v = this.value.replace(/\D/g, '');
      v = (parseInt(v) / 100).toFixed(2);
      this.value = v.replace('.', ',');
    });

    document.getElementById('novoClienteCpf').addEventListener('input', function() {
      let v = this.value.replace(/\D/g, '');
      if (v.length <= 11) {
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      } else {
        v = v.replace(/^(\d{2})(\d)/, '$1.$2');
        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
        v = v.replace(/(\d{4})(\d)/, '$1-$2');
      }
      this.value = v;
    });

    document.getElementById('novoClienteTelefone').addEventListener('input', function() {
      let v = this.value.replace(/\D/g, '');
      v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
      v = v.replace(/(\d{5})(\d)/, '$1-$2');
      this.value = v.substring(0, 15);
    });

    // Submit
    document.getElementById('cobrancaForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

      try {
        let clienteIdFinal = document.getElementById('clienteId').value;

        // Se modo novo cliente, criar primeiro
        if (modoCliente === 'novo') {
          const nomeNovo = document.getElementById('novoClienteNome').value.trim();
          if (!nomeNovo) {
            showAlert('Nome do cliente é obrigatório.', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Salvar Cobrança';
            return;
          }

          const resCliente = await fetch(`${API_BASE}/api/clientes`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({
              nome: nomeNovo,
              cpf_cnpj: document.getElementById('novoClienteCpf').value,
              telefone: document.getElementById('novoClienteTelefone').value,
              email: document.getElementById('novoClienteEmail').value,
              empresa_id: document.getElementById('empresaId').value
            })
          });
          const dataCliente = await resCliente.json();
          if (!dataCliente.success) {
            showAlert(dataCliente.message || 'Erro ao criar cliente.', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Salvar Cobrança';
            return;
          }
          clienteIdFinal = dataCliente.data.id;
        }

        if (!clienteIdFinal) {
          showAlert('Selecione ou cadastre um cliente.', 'error');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check"></i> Salvar Cobrança';
          return;
        }

        // Criar cobrança
        const valorStr = document.getElementById('valorOriginal').value.replace(',', '.');
        const payload = {
          cliente_id: clienteIdFinal,
          empresa_id: document.getElementById('empresaId').value,
          valor_original: parseFloat(valorStr),
          vencimento: document.getElementById('vencimento').value,
          descricao: document.getElementById('descricao').value,
          status: document.getElementById('status').value,
          data_compromisso: document.getElementById('dataCompromisso').value || null,
          observacoes: document.getElementById('observacoes').value
        };

        const res = await fetch(`${API_BASE}/api/cobrancas`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.success) {
          showAlert('Cobrança cadastrada com sucesso!', 'success');
          setTimeout(() => window.location.href = 'cobrancas.html', 1500);
        } else {
          showAlert(data.message || 'Erro ao cadastrar cobrança.', 'error');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check"></i> Salvar Cobrança';
        }
      } catch (err) {
        console.error('Erro:', err);
        showAlert('Erro de conexão. Tente novamente.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check"></i> Salvar Cobrança';
      }
    });

    function showAlert(msg, type) {
      const box = document.getElementById('alertBox');
      box.textContent = msg;
      box.className = `alert ${type}`;
      box.scrollIntoView({ behavior: 'smooth' });
    }

    // Init
    carregarEmpresas();
    carregarClienteUrl();

    // Data padrão
    const hoje = new Date();
    hoje.setDate(hoje.getDate() + 30);
    document.getElementById('vencimento').value = hoje.toISOString().split('T')[0];
  </script>
</body>
</html>