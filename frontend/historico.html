<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hist√≥rico de A√ß√µes | ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0d0d0d 100%);
      min-height: 100vh;
      color: #e0e0e0;
    }
    .navbar {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 15px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #F6C84C;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .navbar-logo {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 22px;
      color: #1a1a1a;
    }
    .navbar-title {
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-menu {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .navbar-menu a {
      color: #e0e0e0;
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
    }
    .navbar-menu a:hover, .navbar-menu a.active {
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      color: #1a1a1a;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .page-header {
      margin-bottom: 30px;
    }
    .page-title {
      font-size: 32px;
      font-weight: 900;
      color: #fff;
      margin-bottom: 8px;
    }
    .page-subtitle {
      color: #888;
      font-size: 14px;
    }
    .filters-card {
      background: linear-gradient(145deg, #1e1e1e, #252525);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #333;
    }
    .filters-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: end;
    }
    .filter-group {
      flex: 1;
      min-width: 180px;
    }
    .filter-group label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .filter-group select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 2px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
    }
    .filter-group select:focus {
      outline: none;
      border-color: #F6C84C;
    }
    .btn {
      padding: 12px 25px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      color: #1a1a1a;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(246, 200, 76, 0.4);
    }
    .btn-secondary {
      background: #333;
      color: #fff;
    }
    .table-card {
      background: linear-gradient(145deg, #1e1e1e, #252525);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #333;
    }
    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-title {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
    }
    .table-count {
      background: #333;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: #F6C84C;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead th {
      background: #252525;
      padding: 15px 20px;
      text-align: left;
      font-size: 11px;
      font-weight: 800;
      color: #888;
      text-transform: uppercase;
    }
    tbody tr {
      border-bottom: 1px solid #2a2a2a;
      transition: background 0.2s;
    }
    tbody tr:hover {
      background: rgba(246, 200, 76, 0.05);
    }
    tbody td {
      padding: 15px 20px;
      font-size: 13px;
      color: #ccc;
    }
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
    }
    .badge-criar { background: #dcfce7; color: #166534; }
    .badge-atualizar { background: #dbeafe; color: #1e40af; }
    .badge-excluir { background: #fee2e2; color: #991b1b; }
    .badge-login { background: #f3e8ff; color: #7c3aed; }
    .badge-email { background: #fef3c7; color: #854d0e; }
    .badge-pdf { background: #e0e7ff; color: #3730a3; }
    .badge-backup { background: #ccfbf1; color: #0f766e; }
    .badge-default { background: #333; color: #888; }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #F6C84C, #FFD56A);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 12px;
      color: #1a1a1a;
    }
    .user-name {
      font-weight: 700;
      color: #fff;
    }
    .mono {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #888;
    }
    .details-cell {
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 25px;
      border-top: 1px solid #333;
    }
    .pagination button {
      padding: 10px 20px;
      border-radius: 8px;
      border: 2px solid #333;
      background: transparent;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    .pagination button:hover:not(:disabled) {
      border-color: #F6C84C;
      color: #F6C84C;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-logo">A</div>
      <span class="navbar-title">ACERTIVE</span>
    </div>
    <div class="navbar-menu">
      <a href="/dashboard">Dashboard</a>
      <a href="/cobrancas">Cobran√ßas</a>
      <a href="/clientes-ativos">Clientes</a>
      <a href="/historico" class="active">Hist√≥rico</a>
      <a href="/usuarios">Usu√°rios</a>
      <a href="/login" id="btnLogout">Sair</a>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">üìú Hist√≥rico de A√ß√µes</h1>
      <p class="page-subtitle">Auditoria completa de todas as a√ß√µes realizadas no sistema</p>
    </div>

    <div class="filters-card">
      <div class="filters-row">
        <div class="filter-group">
          <label>Entidade</label>
          <select id="filtroEntidade">
            <option value="">Todas</option>
            <option value="cobrancas">Cobran√ßas</option>
            <option value="clientes">Clientes</option>
            <option value="users">Usu√°rios</option>
            <option value="sistema">Sistema</option>
          </select>
        </div>
        <div class="filter-group">
          <label>A√ß√£o</label>
          <select id="filtroAcao">
            <option value="">Todas</option>
            <option value="CRIAR">Criar</option>
            <option value="ATUALIZAR">Atualizar</option>
            <option value="ATUALIZAR_STATUS">Atualizar Status</option>
            <option value="EXCLUIR">Excluir</option>
            <option value="LOGIN">Login</option>
            <option value="ENVIAR_EMAIL">Enviar E-mail</option>
            <option value="GERAR_PDF">Gerar PDF</option>
            <option value="BACKUP">Backup</option>
          </select>
        </div>
        <div class="filter-group" style="flex: 0;">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="carregarHistorico()">üîç Filtrar</button>
        </div>
        <div class="filter-group" style="flex: 0;">
          <label>&nbsp;</label>
          <button class="btn btn-secondary" onclick="limparFiltros()">Limpar</button>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header">
        <h3 class="table-title">Registros de Auditoria</h3>
        <span class="table-count" id="totalRegistros">0 registros</span>
      </div>
      <div id="tabelaContainer">
        <div class="loading">Carregando...</div>
      </div>
      <div class="pagination" id="paginacao"></div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let paginaAtual = 0;
    const limitePorPagina = 50;

    function getToken() { return localStorage.getItem('token'); }
    function checkAuth() { if (!getToken()) window.location.href = '/login'; }

    document.getElementById('btnLogout').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    function getBadgeClass(acao) {
      if (acao.includes('CRIAR') || acao.includes('IMPORTAR')) return 'badge-criar';
      if (acao.includes('ATUALIZAR')) return 'badge-atualizar';
      if (acao.includes('EXCLUIR') || acao.includes('DESATIVAR')) return 'badge-excluir';
      if (acao === 'LOGIN') return 'badge-login';
      if (acao.includes('EMAIL')) return 'badge-email';
      if (acao.includes('PDF') || acao.includes('WHATSAPP') || acao.includes('IA')) return 'badge-pdf';
      if (acao === 'BACKUP') return 'badge-backup';
      return 'badge-default';
    }

    function formatarData(data) {
      if (!data) return '‚Äî';
      return new Date(data).toLocaleString('pt-BR');
    }

    function formatarDetalhes(detalhes) {
      if (!detalhes) return '‚Äî';
      try {
        const obj = typeof detalhes === 'string' ? JSON.parse(detalhes) : detalhes;
        return Object.entries(obj).map(([k, v]) => `${k}: ${v}`).join(', ');
      } catch { return String(detalhes); }
    }

    function getIniciais(nome) {
      if (!nome) return '?';
      return nome.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
    }

    async function carregarHistorico() {
      const container = document.getElementById('tabelaContainer');
      container.innerHTML = '<div class="loading">Carregando...</div>';

      const params = new URLSearchParams();
      const entidade = document.getElementById('filtroEntidade').value;
      const acao = document.getElementById('filtroAcao').value;
      if (entidade) params.append('entidade', entidade);
      if (acao) params.append('acao', acao);
      params.append('limite', limitePorPagina);
      params.append('offset', paginaAtual * limitePorPagina);

      try {
        const res = await fetch(`${API_URL}/api/historico?${params}`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await res.json();

        if (!data.success) {
          container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>${data.message}</p></div>`;
          return;
        }

        document.getElementById('totalRegistros').textContent = `${data.total || 0} registros`;

        if (!data.data?.length) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Nenhum registro encontrado</p></div>';
          renderizarPaginacao(0);
          return;
        }

        let html = `<table><thead><tr><th>Usu√°rio</th><th>A√ß√£o</th><th>Entidade</th><th>Detalhes</th><th>IP</th><th>Data/Hora</th></tr></thead><tbody>`;
        data.data.forEach(log => {
          html += `<tr>
            <td><div class="user-info"><div class="user-avatar">${getIniciais(log.usuario_nome)}</div><span class="user-name">${log.usuario_nome || 'Sistema'}</span></div></td>
            <td><span class="badge ${getBadgeClass(log.acao)}">${log.acao}</span></td>
            <td>${log.entidade}</td>
            <td class="details-cell" title="${formatarDetalhes(log.detalhes)}">${formatarDetalhes(log.detalhes)}</td>
            <td class="mono">${log.ip || '‚Äî'}</td>
            <td>${formatarData(log.created_at)}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        renderizarPaginacao(data.total || 0);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Erro ao carregar</p></div>';
      }
    }

    function renderizarPaginacao(total) {
      const totalPaginas = Math.ceil(total / limitePorPagina);
      const pag = document.getElementById('paginacao');
      if (totalPaginas <= 1) { pag.innerHTML = ''; return; }
      pag.innerHTML = `
        <button onclick="mudarPagina(-1)" ${paginaAtual === 0 ? 'disabled' : ''}>‚Üê Anterior</button>
        <span style="padding:10px 20px;color:#888">P√°gina ${paginaAtual + 1} de ${totalPaginas}</span>
        <button onclick="mudarPagina(1)" ${paginaAtual >= totalPaginas - 1 ? 'disabled' : ''}>Pr√≥xima ‚Üí</button>
      `;
    }

    function mudarPagina(d) { paginaAtual += d; carregarHistorico(); }
    function limparFiltros() {
      document.getElementById('filtroEntidade').value = '';
      document.getElementById('filtroAcao').value = '';
      paginaAtual = 0;
      carregarHistorico();
    }

    checkAuth();
    carregarHistorico();
  </script>
</body>
</html>