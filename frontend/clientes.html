<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACERTIVE • Devedores</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E4BC;
            --gold-dark: #AA8C2C;
            --dark: #1a1a2e;
            --dark-light: #252542;
            --dark-lighter: #2d2d4a;
            --text: #e8e8e8;
            --text-muted: #a0a0a0;
            --success: #4ade80;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--dark) 0%, #0f0f1a 100%); min-height: 100vh; color: var(--text); }
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: linear-gradient(180deg, var(--dark-light) 0%, var(--dark) 100%); border-right: 1px solid rgba(212, 175, 55, 0.2); padding: 20px 0; z-index: 1000; overflow-y: auto; }
        .logo { padding: 10px 25px 30px; border-bottom: 1px solid rgba(212, 175, 55, 0.1); margin-bottom: 20px; }
        .logo h1 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; }
        .logo span { font-size: 0.7rem; color: var(--text-muted); letter-spacing: 3px; text-transform: uppercase; }
        .nav-section { padding: 0 15px; margin-bottom: 10px; }
        .nav-section-title { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; color: var(--gold); padding: 10px; font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-muted); text-decoration: none; border-radius: 10px; margin-bottom: 5px; transition: all 0.3s ease; font-size: 0.9rem; }
        .nav-item:hover { background: rgba(212, 175, 55, 0.1); color: var(--gold); }
        .nav-item.active { background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 100%); color: var(--gold); border-left: 3px solid var(--gold); }
        .nav-item i { width: 20px; text-align: center; font-size: 1rem; }
        .main-content { margin-left: 260px; padding: 30px; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--text); }
        .page-title span { color: var(--gold); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, var(--dark-light) 0%, var(--dark-lighter) 100%); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 15px; padding: 20px; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); border-color: rgba(212, 175, 55, 0.4); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-bottom: 15px; background: rgba(212, 175, 55, 0.15); color: var(--gold); border: 1px solid rgba(212, 175, 55, 0.3); }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: var(--gold); margin-bottom: 5px; }
        .stat-card .label { font-size: 0.85rem; color: var(--text-muted); }
        .filters-bar { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .search-box { flex: 1; min-width: 250px; position: relative; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .search-box input { width: 100%; padding: 12px 15px 12px 45px; background: var(--dark-light); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 10px; color: var(--text); font-size: 0.9rem; transition: all 0.3s ease; }
        .search-box input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }
        .search-box input::placeholder { color: var(--text-muted); }
        .filter-select { padding: 12px 35px 12px 15px; background: var(--dark-light); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 10px; color: var(--text); font-size: 0.9rem; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23D4AF37' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; }
        .filter-select:focus { outline: none; border-color: var(--gold); }
        .filter-select option { background: var(--dark); color: var(--text); }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: var(--dark); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3); }
        .btn-secondary { background: var(--dark-lighter); color: var(--text); border: 1px solid rgba(212, 175, 55, 0.2); }
        .btn-secondary:hover { border-color: var(--gold); color: var(--gold); }
        .table-container { background: linear-gradient(135deg, var(--dark-light) 0%, var(--dark-lighter) 100%); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 15px; overflow: hidden; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(212, 175, 55, 0.1); }
        th { padding: 15px 20px; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); font-weight: 600; white-space: nowrap; }
        td { padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.9rem; }
        tr:hover { background: rgba(212, 175, 55, 0.05); }
        .client-name { font-weight: 600; color: var(--text); }
        .client-doc { font-size: 0.8rem; color: var(--text-muted); margin-top: 3px; }
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: rgba(74, 222, 128, 0.2); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .debt-value { font-weight: 600; color: var(--danger); }
        .actions { display: flex; gap: 8px; }
        .btn-icon { width: 35px; height: 35px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 0.9rem; }
        .btn-icon.view { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .btn-icon.edit { background: rgba(212, 175, 55, 0.2); color: var(--gold); }
        .btn-icon.delete { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .btn-icon.whatsapp { background: rgba(37, 211, 102, 0.2); color: #25d366; }
        .btn-icon:hover { transform: scale(1.1); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: linear-gradient(135deg, var(--dark-light) 0%, var(--dark) 100%); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 30px; border-bottom: 1px solid rgba(212, 175, 55, 0.2); }
        .modal-header h2 { font-size: 1.3rem; color: var(--gold); }
        .modal-close { width: 35px; height: 35px; border: none; background: rgba(239, 68, 68, 0.2); color: var(--danger); border-radius: 8px; cursor: pointer; font-size: 1.2rem; transition: all 0.3s ease; }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { margin-bottom: 0; }
        .form-group.full-width { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; background: var(--dark); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 10px; color: var(--text); font-size: 0.9rem; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group select option { background: var(--dark); color: var(--text); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 15px; padding: 20px 30px; border-top: 1px solid rgba(212, 175, 55, 0.2); }
        .pagination { display: flex; justify-content: center; gap: 5px; padding: 20px; }
        .pagination button { width: 40px; height: 40px; border: 1px solid rgba(212, 175, 55, 0.2); background: transparent; color: var(--text-muted); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .pagination button:hover, .pagination button.active { background: var(--gold); color: var(--dark); border-color: var(--gold); }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 4rem; color: rgba(212, 175, 55, 0.3); margin-bottom: 20px; }
        .empty-state h3 { color: var(--text); margin-bottom: 10px; }
        .empty-state p { color: var(--text-muted); }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--gold); }
        .loading i { font-size: 2rem; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast { background: var(--dark-light); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 10px; padding: 15px 20px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; min-width: 300px; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast i { font-size: 1.2rem; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; } .form-grid { grid-template-columns: 1fr; } .form-group.full-width { grid-column: span 1; } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .page-header { flex-direction: column; align-items: flex-start; } .filters-bar { flex-direction: column; } .search-box { width: 100%; } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo"><h1>ACERTIVE</h1><span>Gestão de Cobranças</span></div>
        <nav class="nav-section">
            <div class="nav-section-title">Principal</div>
            <a href="/dashboard" class="nav-item"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
        </nav>
        <nav class="nav-section">
            <div class="nav-section-title">Cadastros</div>
            <a href="/clientes" class="nav-item active"><i class="fas fa-users"></i><span>Devedores</span></a>
            <a href="/credores" class="nav-item"><i class="fas fa-building"></i><span>Credores</span></a>
            <a href="/cobrancas" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>Cobranças</span></a>
        </nav>
        <nav class="nav-section">
            <div class="nav-section-title">Negociação</div>
            <a href="/acordos" class="nav-item"><i class="fas fa-handshake"></i><span>Acordos</span></a>
            <a href="/parcelas" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Parcelas</span></a>
        </nav>
        <nav class="nav-section">
            <div class="nav-section-title">Comunicação</div>
            <a href="/mensagens" class="nav-item"><i class="fab fa-whatsapp"></i><span>Mensagens</span></a>
            <a href="/agendamentos" class="nav-item"><i class="fas fa-clock"></i><span>Agendamentos</span></a>
        </nav>
        <nav class="nav-section">
            <div class="nav-section-title">Financeiro</div>
            <a href="/financeiro" class="nav-item"><i class="fas fa-wallet"></i><span>Financeiro</span></a>
        </nav>
        <nav class="nav-section">
            <div class="nav-section-title">Sistema</div>
            <a href="/usuarios" class="nav-item"><i class="fas fa-user-cog"></i><span>Usuários</span></a>
            <a href="/configuracoes" class="nav-item"><i class="fas fa-cog"></i><span>Configurações</span></a>
            <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Gestão de <span>Devedores</span></h1>
            <a href="/novo-cliente" class="btn btn-primary"><i class="fas fa-plus"></i> Novo Devedor</a>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="icon"><i class="fas fa-users"></i></div><div class="value" id="totalClientes">0</div><div class="label">Total de Devedores</div></div>
            <div class="stat-card"><div class="icon"><i class="fas fa-exclamation-circle"></i></div><div class="value" id="clientesAtivos">0</div><div class="label">Com Dívidas Ativas</div></div>
            <div class="stat-card"><div class="icon"><i class="fas fa-money-bill-wave"></i></div><div class="value" id="totalDivida">R$ 0,00</div><div class="label">Total em Dívidas</div></div>
            <div class="stat-card"><div class="icon"><i class="fas fa-handshake"></i></div><div class="value" id="clientesAcordo">0</div><div class="label">Com Acordos</div></div>
        </div>

        <div class="filters-bar">
            <div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Buscar por nome, CPF/CNPJ, telefone..."></div>
            <select class="filter-select" id="filterStatus"><option value="">Todos os Status</option><option value="ativo">Ativos</option><option value="inativo">Inativos</option><option value="negativado">Negativados</option></select>
            <select class="filter-select" id="filterCredor"><option value="">Todos os Credores</option></select>
            <button class="btn btn-secondary" onclick="exportarClientes()"><i class="fas fa-download"></i> Exportar</button>
        </div>

        <div class="table-container">
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Devedor</th><th>Contato</th><th>Dívida Total</th><th>Status</th><th>Última Ação</th><th>Ações</th></tr></thead>
                    <tbody id="clientesTable"><tr><td colspan="6"><div class="loading"><i class="fas fa-spinner"></i></div></td></tr></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </main>

    <div class="modal-overlay" id="modalEditar">
        <div class="modal">
            <div class="modal-header"><h2><i class="fas fa-edit"></i> Editar Devedor</h2><button class="modal-close" onclick="fecharModal()"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <form id="formEditar">
                    <input type="hidden" id="editId">
                    <div class="form-grid">
                        <div class="form-group full-width"><label>Nome Completo *</label><input type="text" id="editNome" required></div>
                        <div class="form-group"><label>Tipo de Pessoa</label><select id="editTipo"><option value="fisica">Pessoa Física</option><option value="juridica">Pessoa Jurídica</option></select></div>
                        <div class="form-group"><label>CPF/CNPJ</label><input type="text" id="editDocumento"></div>
                        <div class="form-group"><label>Telefone</label><input type="text" id="editTelefone"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
                        <div class="form-group full-width"><label>Endereço</label><input type="text" id="editEndereco"></div>
                        <div class="form-group"><label>Cidade</label><input type="text" id="editCidade"></div>
                        <div class="form-group"><label>Estado</label><select id="editEstado"><option value="">Selecione</option><option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amapá</option><option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Ceará</option><option value="DF">Distrito Federal</option><option value="ES">Espírito Santo</option><option value="GO">Goiás</option><option value="MA">Maranhão</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option><option value="MG">Minas Gerais</option><option value="PA">Pará</option><option value="PB">Paraíba</option><option value="PR">Paraná</option><option value="PE">Pernambuco</option><option value="PI">Piauí</option><option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option><option value="RO">Rondônia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option><option value="SP">São Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option></select></div>
                        <div class="form-group"><label>CEP</label><input type="text" id="editCep"></div>
                        <div class="form-group"><label>Status</label><select id="editStatus"><option value="ativo">Ativo</option><option value="inativo">Inativo</option><option value="negativado">Negativado</option></select></div>
                        <div class="form-group full-width"><label>Observações</label><textarea id="editObservacoes" rows="3"></textarea></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="fecharModal()"><i class="fas fa-times"></i> Cancelar</button><button class="btn btn-primary" onclick="salvarEdicao()"><i class="fas fa-save"></i> Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalDetalhes">
        <div class="modal">
            <div class="modal-header"><h2><i class="fas fa-user"></i> Detalhes do Devedor</h2><button class="modal-close" onclick="fecharModalDetalhes()"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="detalhesContent"></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="fecharModalDetalhes()"><i class="fas fa-times"></i> Fechar</button><button class="btn btn-primary" id="btnEditarDetalhes"><i class="fas fa-edit"></i> Editar</button></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_URL = '';
        let currentPage = 1, totalPages = 1, clientesData = [];

        function getToken() { return localStorage.getItem('token'); }
        function verificarAuth() { if (!getToken()) { window.location.href = '/login'; return false; } return true; }
        function logout() { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/login'; }

        function showToast(msg, type = 'success') {
            const c = document.getElementById('toastContainer'), t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation') + '-circle"></i><span>' + msg + '</span>';
            c.appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('pt-BR') : '-'; }
        function formatDocument(d) { if (!d) return '-'; d = d.replace(/\D/g, ''); return d.length === 11 ? d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : d.length === 14 ? d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5') : d; }

        async function carregarClientes() {
            if (!verificarAuth()) return;
            try {
                let url = API_URL + '/api/clientes?page=' + currentPage + '&limit=20';
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('filterStatus').value;
                if (search) url += '&search=' + encodeURIComponent(search);
                if (status) url += '&status=' + status;

                const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (res.status === 401) { logout(); return; }
                const data = await res.json();
                clientesData = data.data || data || [];
                renderClientes(Array.isArray(clientesData) ? clientesData : []);
                if (data.pagination) renderPagination(data.pagination);
                if (data.stats) atualizarEstatisticas(data.stats);
            } catch (e) { console.error(e); showToast('Erro de conexão', 'error'); renderClientes([]); }
        }

        async function carregarCredores() {
            try {
                const res = await fetch(API_URL + '/api/credores', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (!res.ok) return;
                const data = await res.json();
                const arr = data.data || data || [];
                const sel = document.getElementById('filterCredor');
                arr.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.nome || c.razao_social; sel.appendChild(o); });
            } catch (e) { console.error(e); }
        }

        function renderClientes(lista) {
            const tbody = document.getElementById('clientesTable');
            if (!lista || !lista.length) { tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-users"></i><h3>Nenhum devedor encontrado</h3><p>Cadastre um novo devedor para começar</p></div></td></tr>'; return; }
            tbody.innerHTML = lista.map(c => {
                const st = { 'ativo': 'badge-success', 'inativo': 'badge-warning', 'negativado': 'badge-danger' }[c.status] || 'badge-info';
                const tel = c.telefone || c.celular || '-';
                const wa = tel !== '-' ? 'https://wa.me/55' + tel.replace(/\D/g, '') : '#';
                return '<tr><td><div class="client-name">' + (c.nome || '-') + '</div><div class="client-doc">' + formatDocument(c.cpf_cnpj || c.documento) + '</div></td><td><div>' + tel + '</div><div class="client-doc">' + (c.email || '-') + '</div></td><td class="debt-value">' + formatCurrency(c.divida_total || c.total_divida || 0) + '</td><td><span class="badge ' + st + '">' + (c.status || 'ativo') + '</span></td><td>' + formatDate(c.ultima_acao || c.updated_at) + '</td><td><div class="actions"><button class="btn-icon view" onclick="verDetalhes(' + c.id + ')"><i class="fas fa-eye"></i></button><button class="btn-icon edit" onclick="editarCliente(' + c.id + ')"><i class="fas fa-edit"></i></button><a href="' + wa + '" target="_blank" class="btn-icon whatsapp"><i class="fab fa-whatsapp"></i></a><button class="btn-icon delete" onclick="confirmarExclusao(' + c.id + ')"><i class="fas fa-trash"></i></button></div></td></tr>';
            }).join('');
        }

        function renderPagination(p) {
            const c = document.getElementById('pagination');
            totalPages = p.totalPages || 1; currentPage = p.page || 1;
            if (totalPages <= 1) { c.innerHTML = ''; return; }
            let h = '<button onclick="mudarPagina(' + (currentPage - 1) + ')"' + (currentPage === 1 ? ' disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
            for (let i = 1; i <= totalPages; i++) h += '<button onclick="mudarPagina(' + i + ')"' + (i === currentPage ? ' class="active"' : '') + '>' + i + '</button>';
            h += '<button onclick="mudarPagina(' + (currentPage + 1) + ')"' + (currentPage === totalPages ? ' disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
            c.innerHTML = h;
        }

        function atualizarEstatisticas(s) {
            if (s) {
                document.getElementById('totalClientes').textContent = s.total || 0;
                document.getElementById('clientesAtivos').textContent = s.ativos || 0;
                document.getElementById('totalDivida').textContent = formatCurrency(s.totalDivida || 0);
                document.getElementById('clientesAcordo').textContent = s.comAcordo || 0;
            }
        }

        function mudarPagina(p) { if (p >= 1 && p <= totalPages) { currentPage = p; carregarClientes(); } }

        async function verDetalhes(id) {
            try {
                const res = await fetch(API_URL + '/api/clientes/' + id, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                const data = await res.json();
                const c = data.data || data;
                if (c && c.id) {
                    document.getElementById('detalhesContent').innerHTML = '<div class="form-grid"><div class="form-group"><label>Nome</label><p style="color:var(--text);font-weight:600">' + (c.nome || '-') + '</p></div><div class="form-group"><label>CPF/CNPJ</label><p style="color:var(--text)">' + formatDocument(c.cpf_cnpj || c.documento) + '</p></div><div class="form-group"><label>Telefone</label><p style="color:var(--text)">' + (c.telefone || '-') + '</p></div><div class="form-group"><label>Email</label><p style="color:var(--text)">' + (c.email || '-') + '</p></div><div class="form-group full-width"><label>Endereço</label><p style="color:var(--text)">' + (c.endereco || '-') + '</p></div><div class="form-group"><label>Cidade</label><p style="color:var(--text)">' + (c.cidade || '-') + '</p></div><div class="form-group"><label>Estado</label><p style="color:var(--text)">' + (c.estado || '-') + '</p></div><div class="form-group"><label>Dívida Total</label><p style="color:var(--danger);font-weight:700;font-size:1.2rem">' + formatCurrency(c.divida_total || 0) + '</p></div><div class="form-group"><label>Status</label><p><span class="badge badge-' + (c.status === 'ativo' ? 'success' : c.status === 'negativado' ? 'danger' : 'warning') + '">' + (c.status || 'ativo') + '</span></p></div></div>';
                    document.getElementById('btnEditarDetalhes').onclick = () => { fecharModalDetalhes(); editarCliente(id); };
                    document.getElementById('modalDetalhes').classList.add('active');
                }
            } catch (e) { showToast('Erro ao carregar detalhes', 'error'); }
        }

        function fecharModalDetalhes() { document.getElementById('modalDetalhes').classList.remove('active'); }

        async function editarCliente(id) {
            try {
                const res = await fetch(API_URL + '/api/clientes/' + id, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                const data = await res.json();
                const c = data.data || data;
                if (c && c.id) {
                    document.getElementById('editId').value = c.id;
                    document.getElementById('editNome').value = c.nome || '';
                    document.getElementById('editTipo').value = c.tipo || 'fisica';
                    document.getElementById('editDocumento').value = c.cpf_cnpj || c.documento || '';
                    document.getElementById('editTelefone').value = c.telefone || '';
                    document.getElementById('editEmail').value = c.email || '';
                    document.getElementById('editEndereco').value = c.endereco || '';
                    document.getElementById('editCidade').value = c.cidade || '';
                    document.getElementById('editEstado').value = c.estado || '';
                    document.getElementById('editCep').value = c.cep || '';
                    document.getElementById('editStatus').value = c.status || 'ativo';
                    document.getElementById('editObservacoes').value = c.observacoes || '';
                    document.getElementById('modalEditar').classList.add('active');
                }
            } catch (e) { showToast('Erro ao carregar dados', 'error'); }
        }

        function fecharModal() { document.getElementById('modalEditar').classList.remove('active'); }

        async function salvarEdicao() {
            const id = document.getElementById('editId').value;
            const dados = {
                nome: document.getElementById('editNome').value,
                tipo: document.getElementById('editTipo').value,
                cpf_cnpj: document.getElementById('editDocumento').value,
                telefone: document.getElementById('editTelefone').value,
                email: document.getElementById('editEmail').value,
                endereco: document.getElementById('editEndereco').value,
                cidade: document.getElementById('editCidade').value,
                estado: document.getElementById('editEstado').value,
                cep: document.getElementById('editCep').value,
                status: document.getElementById('editStatus').value,
                observacoes: document.getElementById('editObservacoes').value
            };
            try {
                const res = await fetch(API_URL + '/api/clientes/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() }, body: JSON.stringify(dados) });
                const data = await res.json();
                if (data.success !== false) { showToast('Devedor atualizado!', 'success'); fecharModal(); carregarClientes(); }
                else showToast(data.error || 'Erro ao salvar', 'error');
            } catch (e) { showToast('Erro de conexão', 'error'); }
        }

        async function confirmarExclusao(id) {
            if (!confirm('Excluir este devedor?')) return;
            try {
                const res = await fetch(API_URL + '/api/clientes/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + getToken() } });
                const data = await res.json();
                if (data.success !== false) { showToast('Devedor excluído!', 'success'); carregarClientes(); }
                else showToast(data.error || 'Erro ao excluir', 'error');
            } catch (e) { showToast('Erro de conexão', 'error'); }
        }

        function exportarClientes() { showToast('Exportação em desenvolvimento', 'warning'); }

        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentPage = 1; carregarClientes(); }, 500); });
        document.getElementById('filterStatus').addEventListener('change', () => { currentPage = 1; carregarClientes(); });
        document.getElementById('filterCredor').addEventListener('change', () => { currentPage = 1; carregarClientes(); });
        document.getElementById('modalEditar').addEventListener('click', e => { if (e.target.id === 'modalEditar') fecharModal(); });
        document.getElementById('modalDetalhes').addEventListener('click', e => { if (e.target.id === 'modalDetalhes') fecharModalDetalhes(); });

        document.addEventListener('DOMContentLoaded', () => { if (verificarAuth()) { carregarClientes(); carregarCredores(); } });
    </script>
</body>
</html>
