<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACERTIVE • Acordos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:rgba(17,17,21,0.95);--bg-sidebar:#0c0c0f;
      --text-primary:#fafafa;--text-secondary:#a1a1aa;--text-muted:#71717a;
      --gold:#F6C84C;--gold-light:#FFD56A;--gold-glow:rgba(246,200,76,0.15);--gold-glow-strong:rgba(246,200,76,0.3);
      --border:rgba(255,255,255,0.08);--border-gold:rgba(246,200,76,0.2);
      --green:#22c55e;--green-bg:rgba(34,197,94,0.15);--red:#ef4444;--red-bg:rgba(239,68,68,0.15);
      --blue:#3b82f6;--blue-bg:rgba(59,130,246,0.15);--orange:#f59e0b;--orange-bg:rgba(245,158,11,0.15);
      --purple:#8b5cf6;--purple-bg:rgba(139,92,246,0.12);
      --sidebar-width:260px;--radius-sm:8px;--radius-md:12px;--radius-lg:16px;
      --shadow-gold:0 8px 32px rgba(246,200,76,0.2);--transition-fast:0.15s ease;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

    /* SIDEBAR PADRÃO */
    .sidebar{position:fixed;left:0;top:0;width:var(--sidebar-width);height:100vh;background:var(--bg-sidebar);border-right:1px solid var(--border);z-index:1000;display:flex;flex-direction:column}
    .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px;color:var(--bg-primary);box-shadow:var(--shadow-gold)}
    .logo-text{font-size:20px;font-weight:800}.logo-text span{color:var(--gold)}
    .sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}.nav-section{margin-bottom:24px}
    .nav-section-title{font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;padding:0 12px;margin-bottom:8px}
    .nav-link{display:flex;align-items:center;gap:12px;padding:11px 14px;color:var(--text-secondary);text-decoration:none;border-radius:var(--radius-md);font-weight:500;font-size:14px;transition:all var(--transition-fast);margin-bottom:2px;position:relative}
    .nav-link:hover{background:var(--gold-glow);color:var(--gold)}
    .nav-link.active{background:linear-gradient(135deg,var(--gold-glow-strong),var(--gold-glow));color:var(--gold)}
    .nav-link.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--gold);border-radius:0 3px 3px 0}
    .nav-link i{width:20px;text-align:center;font-size:15px}
    .nav-badge{margin-left:auto;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;background:var(--red);color:white;display:none}
    .nav-badge:not(:empty){display:inline-block}
    .sidebar-footer{padding:16px;border-top:1px solid var(--border)}
    .user-card{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:var(--radius-md)}
    .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:var(--bg-primary)}
    .user-info{flex:1}.user-name{font-weight:600;font-size:13px}.user-role{font-size:11px;color:var(--text-muted)}
    .btn-logout{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:8px;border-radius:6px}.btn-logout:hover{background:var(--red-bg);color:var(--red)}

    .main { margin-left: var(--sidebar-width); min-height: 100vh; }
    .header { height: 64px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: sticky; top: 0; z-index: 50; }
    .page-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .page-title i { color: var(--gold); }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .content { padding: 24px; }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: var(--bg-primary); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212,168,83,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--gold-glow); color: var(--gold); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { width: 36px; height: 36px; padding: 0; justify-content: center; }

    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-bottom: 12px; }
    .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-value { font-size: 22px; font-weight: 800; }
    .stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-box { flex: 1; min-width: 250px; position: relative; }
    .search-box input { width: 100%; padding: 10px 12px 10px 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 13px; }
    .search-box input:focus { outline: none; border-color: var(--gold); }
    .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .filter-select { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 13px; min-width: 140px; }

    .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .table-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .table-title { font-size: 14px; font-weight: 700; }
    .table-count { font-size: 12px; color: var(--text-muted); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(255,255,255,0.02); }
    th { padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.02); cursor: pointer; }

    .acordo-info { display: flex; align-items: center; gap: 10px; }
    .acordo-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .acordo-id { font-weight: 700; font-size: 13px; }
    .acordo-data { font-size: 11px; color: var(--text-muted); }

    .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .status-badge.ativo { background: var(--green-bg); color: var(--green); }
    .status-badge.pendente { background: var(--orange-bg); color: var(--orange); }
    .status-badge.pago { background: var(--blue-bg); color: var(--blue); }
    .status-badge.quebrado { background: var(--red-bg); color: var(--red); }
    .status-badge.cancelado { background: rgba(255,255,255,0.1); color: var(--text-muted); }

    .parcelas-info { display: flex; align-items: center; gap: 8px; }
    .parcelas-bar { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
    .parcelas-bar-fill { height: 100%; border-radius: 3px; background: var(--green); }
    .parcelas-text { font-size: 12px; font-weight: 600; }

    .valor-cell { text-align: right; }
    .valor-acordo { font-weight: 700; color: var(--gold); }
    .valor-desconto { font-size: 11px; color: var(--green); }

    .actions { display: flex; gap: 6px; }

    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-top: 1px solid var(--border); }
    .pagination-info { font-size: 13px; color: var(--text-muted); }
    .pagination-buttons { display: flex; gap: 8px; }
    .page-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); cursor: pointer; }
    .page-btn:hover { background: var(--gold-glow); border-color: var(--gold); color: var(--gold); }
    .page-btn.active { background: var(--gold); color: var(--bg-primary); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .modal-title i { color: var(--gold); }
    .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

    .acordo-detalhes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .detalhe-card { background: var(--bg-primary); border-radius: 10px; padding: 16px; }
    .detalhe-card h4 { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
    .detalhe-card .valor { font-size: 20px; font-weight: 800; }
    .detalhe-card .sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    .parcelas-lista { margin-top: 20px; }
    .parcela-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
    .parcela-numero { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; }
    .parcela-info { flex: 1; }
    .parcela-valor { font-weight: 600; }
    .parcela-venc { font-size: 11px; color: var(--text-muted); }
    .parcela-status { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 4px; }

    @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(2, 1fr); } .acordo-detalhes { grid-template-columns: 1fr; } }
    @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .main { margin-left: 0; } }
  </style>
</head>
<body>
  <!-- SIDEBAR PADRÃO -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header"><div class="logo-icon">A</div><div class="logo-text">ACERT<span>IVE</span></div></div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a href="/dashboard" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="/fila-cobranca" class="nav-link"><i class="fas fa-headset"></i> Fila de Cobrança <span class="nav-badge" id="badgeFila"></span></a>
        <a href="/atendimento" class="nav-link"><i class="fas fa-phone-volume"></i> Atendimento</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Cadastros</div>
        <a href="/credores" class="nav-link"><i class="fas fa-building"></i> Credores</a>
        <a href="/clientes" class="nav-link"><i class="fas fa-users"></i> Devedores</a>
        <a href="/cobrancas" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Negociação</div>
        <a href="/acordos" class="nav-link active"><i class="fas fa-handshake"></i> Acordos</a>
        <a href="/parcelas" class="nav-link"><i class="fas fa-calendar-check"></i> Parcelas</a>
        <a href="/simulador" class="nav-link"><i class="fas fa-calculator"></i> Simulador</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Financeiro</div>
        <a href="/comissoes" class="nav-link"><i class="fas fa-coins"></i> Comissões</a>
        <a href="/repasses" class="nav-link"><i class="fas fa-exchange-alt"></i> Repasses</a>
        <a href="/relatorios" class="nav-link"><i class="fas fa-chart-bar"></i> Relatórios</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Automação</div>
        <a href="/templates" class="nav-link"><i class="fas fa-file-alt"></i> Templates</a>
        <a href="/regua-cobranca" class="nav-link"><i class="fas fa-robot"></i> Régua de Cobrança</a>
        <a href="/lembretes" class="nav-link"><i class="fas fa-bell"></i> Lembretes E-mail</a>
        <a href="/agendamentos" class="nav-link"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Administração</div>
        <a href="/importar-massa" class="nav-link"><i class="fas fa-file-import"></i> Importar</a>
        <a href="/usuarios" class="nav-link"><i class="fas fa-user-shield"></i> Usuários</a>
        <a href="/configuracoes" class="nav-link"><i class="fas fa-cog"></i> Configurações</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-info"><div class="user-name" id="userName">Carregando...</div><div class="user-role" id="userRole">-</div></div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-right-from-bracket"></i></button>
      </div>
    </div>
  </aside>

  <main class="main">
    <header class="header">
      <div class="header-left">
        <h1 class="page-title"><i class="fas fa-handshake"></i> Acordos</h1>
      </div>
      <div class="header-right">
        <button class="btn btn-secondary"><i class="fas fa-download"></i> Exportar</button>
      </div>
    </header>

    <div class="content">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background:var(--green-bg);color:var(--green);"><i class="fas fa-handshake"></i></div>
          <div class="stat-label">Acordos Ativos</div>
          <div class="stat-value" id="statAtivos">0</div>
          <div class="stat-sub">Este mês: <span id="statMes">0</span> novos</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:var(--gold-glow);color:var(--gold);"><i class="fas fa-dollar-sign"></i></div>
          <div class="stat-label">Valor Negociado</div>
          <div class="stat-value" id="statValor">R$ 0</div>
          <div class="stat-sub">Desconto médio: <span id="statDesconto">0</span>%</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:var(--blue-bg);color:var(--blue);"><i class="fas fa-check-circle"></i></div>
          <div class="stat-label">Acordos Quitados</div>
          <div class="stat-value" id="statQuitados">0</div>
          <div class="stat-sub">R$ <span id="statRecuperado">0</span> recuperado</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:var(--red-bg);color:var(--red);"><i class="fas fa-times-circle"></i></div>
          <div class="stat-label">Acordos Quebrados</div>
          <div class="stat-value" id="statQuebrados">0</div>
          <div class="stat-sub"><span id="statPercQuebrado">0</span>% do total</div>
        </div>
      </div>

      <div class="filters">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Buscar por devedor, acordo..." id="searchAcordo">
        </div>
        <select class="filter-select" id="filtroCredor">
          <option value="">Todos os Credores</option>
        </select>
        <select class="filter-select" id="filtroStatus">
          <option value="">Todos os Status</option>
          <option value="ativo">Ativo</option>
          <option value="pago">Quitado</option>
          <option value="quebrado">Quebrado</option>
          <option value="pendente">Pendente Aprovação</option>
        </select>
        <select class="filter-select" id="filtroOrdem">
          <option value="recente">Mais Recente</option>
          <option value="valor">Maior Valor</option>
          <option value="vencimento">Próximo Vencimento</option>
        </select>
      </div>

      <div class="table-container">
        <div class="table-header">
          <div class="table-title">Lista de Acordos</div>
          <div class="table-count" id="tableCount">0 acordos</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Acordo</th>
              <th>Devedor</th>
              <th>Credor</th>
              <th>Parcelas</th>
              <th>Próx. Venc.</th>
              <th>Status</th>
              <th style="text-align:right;">Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="acordosBody">
            <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>
          </tbody>
        </table>
        <div class="pagination">
          <div class="pagination-info" id="paginationInfo">Mostrando 0-0 de 0</div>
          <div class="pagination-buttons" id="paginationButtons"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODAL DETALHES DO ACORDO -->
  <div class="modal-overlay" id="modalAcordo">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-file-contract"></i> <span id="modalAcordoId">Acordo</span></h3>
        <button class="modal-close" onclick="fecharModal('modalAcordo')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="acordo-detalhes" id="acordoDetalhes"></div>
        <div class="parcelas-lista" id="parcelasLista"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalAcordo')">Fechar</button>
        <button class="btn btn-secondary"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
        <button class="btn btn-primary"><i class="fas fa-dollar-sign"></i> Registrar Pagamento</button>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    let token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';

    function getHeaders() { return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }; }
    function fmtMoney(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); }
    function fmtDate(d) { return d ? new Date(d).toLocaleDateString('pt-BR') : '—'; }
    function logout() { localStorage.removeItem('token'); window.location.href = '/login'; }

    async function carregarUsuario() {
      try {
        const res = await fetch(API + '/api/usuarios/me', { headers: getHeaders() });
        const data = await res.json();
        if (data.success && data.data) {
          document.getElementById('userName').textContent = data.data.nome || 'Usuário';
          document.getElementById('userRole').textContent = data.data.nivel === 'admin' ? 'Administrador' : 'Operador';
          document.getElementById('userAvatar').textContent = (data.data.nome || 'U').charAt(0).toUpperCase();
        }
      } catch (e) { console.error(e); }
    }

    async function carregarBadges() {
      try {
        const res = await fetch(API + '/api/alertas/contador', { headers: getHeaders() });
        const data = await res.json();
        if (data.success) {
          const badgeFila = document.getElementById('badgeFila');
          if (badgeFila) {
            const total = (data.vencidas || 0) + (data.vencendoHoje || 0);
            badgeFila.textContent = total > 0 ? total : '';
          }
        }
      } catch (e) { console.error(e); }
    }

    async function carregarAcordos() {
      const tbody = document.getElementById('acordosBody');
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>';
      
      try {
        const res = await fetch(API + '/api/acordos', { headers: getHeaders() });
        const data = await res.json();
        
        if (data.success && data.data && data.data.length > 0) {
          renderizarAcordos(data.data);
          atualizarEstatisticas(data.data);
        } else {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);"><i class="fas fa-handshake" style="font-size:32px;opacity:0.5;"></i><p style="margin-top:12px;">Nenhum acordo encontrado</p></td></tr>';
        }
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);">Erro ao carregar acordos</td></tr>';
      }
    }

    function renderizarAcordos(acordos) {
      const tbody = document.getElementById('acordosBody');
      document.getElementById('tableCount').textContent = acordos.length + ' acordos';
      
      tbody.innerHTML = acordos.map(a => {
        const statusClass = a.status || 'ativo';
        const parcelasPagas = a.parcelas_pagas || 0;
        const totalParcelas = a.total_parcelas || 1;
        const progresso = Math.round((parcelasPagas / totalParcelas) * 100);
        
        return `<tr onclick="verAcordo('${a.id}')">
          <td>
            <div class="acordo-info">
              <div class="acordo-icon" style="background:var(--${statusClass === 'pago' ? 'blue' : statusClass === 'quebrado' ? 'red' : 'green'}-bg);color:var(--${statusClass === 'pago' ? 'blue' : statusClass === 'quebrado' ? 'red' : 'green'});"><i class="fas fa-file-contract"></i></div>
              <div>
                <div class="acordo-id">#${a.id}</div>
                <div class="acordo-data">${fmtDate(a.created_at)}</div>
              </div>
            </div>
          </td>
          <td>
            <div style="font-weight:600;">${a.devedor_nome || '—'}</div>
            <div style="font-size:11px;color:var(--text-muted);">${a.devedor_cpf || ''}</div>
          </td>
          <td>${a.credor_nome || '—'}</td>
          <td>
            <div class="parcelas-info">
              <div class="parcelas-bar"><div class="parcelas-bar-fill" style="width:${progresso}%;"></div></div>
              <span class="parcelas-text">${parcelasPagas}/${totalParcelas}</span>
            </div>
          </td>
          <td>
            <div style="font-weight:600;">${fmtDate(a.proximo_vencimento)}</div>
          </td>
          <td><span class="status-badge ${statusClass}">${statusClass.toUpperCase()}</span></td>
          <td>
            <div class="valor-cell">
              <div class="valor-acordo">${fmtMoney(a.valor_acordo)}</div>
              ${a.desconto ? `<div class="valor-desconto">-${a.desconto}% desconto</div>` : ''}
            </div>
          </td>
          <td>
            <div class="actions" onclick="event.stopPropagation();">
              <button class="btn btn-secondary btn-sm btn-icon" title="Ver Detalhes" onclick="verAcordo('${a.id}')"><i class="fas fa-eye"></i></button>
              <button class="btn btn-secondary btn-sm btn-icon" title="Registrar Pagamento"><i class="fas fa-dollar-sign"></i></button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    function atualizarEstatisticas(acordos) {
      const ativos = acordos.filter(a => a.status === 'ativo').length;
      const quitados = acordos.filter(a => a.status === 'pago').length;
      const quebrados = acordos.filter(a => a.status === 'quebrado').length;
      const valorTotal = acordos.reduce((sum, a) => sum + (parseFloat(a.valor_acordo) || 0), 0);
      
      document.getElementById('statAtivos').textContent = ativos;
      document.getElementById('statQuitados').textContent = quitados;
      document.getElementById('statQuebrados').textContent = quebrados;
      document.getElementById('statValor').textContent = fmtMoney(valorTotal);
      document.getElementById('statPercQuebrado').textContent = acordos.length > 0 ? Math.round((quebrados / acordos.length) * 100) : 0;
    }

    function verAcordo(id) { 
      document.getElementById('modalAcordoId').textContent = 'Acordo #' + id;
      document.getElementById('modalAcordo').classList.add('show'); 
    }
    
    function fecharModal(id) { 
      document.getElementById(id).classList.remove('show'); 
    }

    document.getElementById('modalAcordo').onclick = e => { if (e.target.id === 'modalAcordo') fecharModal('modalAcordo'); };

    carregarUsuario();
    carregarBadges();
    carregarAcordos();
  </script>
</body>
</html>