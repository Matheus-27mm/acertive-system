<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repasses - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:#09090b;color:#fafafa;min-height:100vh}
    .sidebar{position:fixed;left:0;top:0;width:260px;height:100vh;background:#18181b;border-right:1px solid #27272a;padding:20px;overflow-y:auto;z-index:100}
    .logo{display:flex;align-items:center;gap:12px;padding:10px 0 30px;border-bottom:1px solid #27272a;margin-bottom:20px}
    .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#F6C84C,#f59e0b);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#09090b}
    .logo-text{font-size:22px;font-weight:700}.logo-text span{color:#F6C84C}
    .nav-section{margin-bottom:25px}.nav-title{font-size:11px;text-transform:uppercase;color:#71717a;letter-spacing:1px;margin-bottom:10px;padding-left:10px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:8px;color:#a1a1aa;text-decoration:none;transition:all .2s;margin-bottom:4px}
    .nav-item:hover{background:#27272a;color:#fafafa}.nav-item.active{background:linear-gradient(135deg,#F6C84C,#f59e0b);color:#09090b;font-weight:600}
    .nav-item i{width:20px;text-align:center}
    .main{margin-left:260px;padding:30px;min-height:100vh}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}.header h1{font-size:28px;font-weight:700}
    .btn{padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:8px;font-size:14px}
    .btn-primary{background:linear-gradient(135deg,#F6C84C,#f59e0b);color:#09090b}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(246,200,76,.4)}
    .btn-secondary{background:#27272a;color:#fafafa}.btn-secondary:hover{background:#3f3f46}
    .btn-success{background:#22c55e;color:#fff}.btn-success:hover{background:#16a34a}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#18181b;border:1px solid #27272a;border-radius:12px;padding:20px}
    .stat-card.highlight{border-color:#F6C84C;background:linear-gradient(135deg,rgba(246,200,76,.1),rgba(245,158,11,.05))}
    .stat-card.alert{border-color:#ef4444;background:linear-gradient(135deg,rgba(239,68,68,.1),rgba(239,68,68,.05))}
    .stat-icon{width:45px;height:45px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:15px}
    .stat-icon.yellow{background:rgba(246,200,76,.2);color:#F6C84C}.stat-icon.green{background:rgba(34,197,94,.2);color:#22c55e}
    .stat-icon.red{background:rgba(239,68,68,.2);color:#ef4444}.stat-icon.blue{background:rgba(59,130,246,.2);color:#3b82f6}
    .stat-label{font-size:13px;color:#71717a;margin-bottom:5px}.stat-value{font-size:28px;font-weight:700}.stat-sub{font-size:12px;color:#71717a;margin-top:5px}
    .table-container{background:#18181b;border:1px solid #27272a;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}thead{background:#27272a}
    th{text-align:left;padding:15px 20px;font-size:12px;text-transform:uppercase;color:#a1a1aa;font-weight:600}
    td{padding:15px 20px;border-bottom:1px solid #27272a;font-size:14px}tr:hover{background:rgba(246,200,76,.05)}
    .credor-info{display:flex;align-items:center;gap:12px}
    .credor-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:14px}
    .credor-nome{font-weight:600}.credor-sub{font-size:12px;color:#71717a}
    .valor{font-weight:700}.valor.destaque{color:#F6C84C}.valor.negativo{color:#ef4444}
    .status-badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}
    .status-badge.pendente{background:rgba(245,158,11,.2);color:#f59e0b}.status-badge.pago{background:rgba(34,197,94,.2);color:#22c55e}
    .empty-state{text-align:center;padding:60px 20px}.empty-state i{font-size:60px;color:#27272a;margin-bottom:20px}
    .empty-state h3{font-size:20px;margin-bottom:10px;color:#71717a}.empty-state p{color:#52525b;font-size:14px}
    .loading{display:flex;justify-content:center;padding:40px}
    .spinner{width:40px;height:40px;border:3px solid #27272a;border-top-color:#F6C84C;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .user-section{position:absolute;bottom:20px;left:20px;right:20px;display:flex;align-items:center;gap:12px;padding:15px;background:#27272a;border-radius:10px}
    .user-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#F6C84C,#f59e0b);display:flex;align-items:center;justify-content:center;font-weight:700;color:#09090b}
    .user-info{flex:1}.user-name{font-weight:600;font-size:14px}.user-role{font-size:12px;color:#71717a}
    .user-logout{color:#71717a;cursor:pointer;padding:8px;border-radius:6px}.user-logout:hover{background:#3f3f46;color:#fafafa}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-overlay.active{display:flex}
    .modal{background:#18181b;border:1px solid #27272a;border-radius:16px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 25px;border-bottom:1px solid #27272a}
    .modal-header h2{font-size:20px}.modal-close{background:none;border:none;color:#71717a;font-size:24px;cursor:pointer}.modal-close:hover{color:#fafafa}
    .modal-body{padding:25px}.modal-footer{display:flex;justify-content:flex-end;gap:12px;padding:20px 25px;border-top:1px solid #27272a}
    .form-group{margin-bottom:20px}.form-group label{display:block;font-size:13px;color:#a1a1aa;margin-bottom:8px}
    .form-group input,.form-group select{width:100%;background:#09090b;border:1px solid #27272a;color:#fafafa;padding:12px 15px;border-radius:8px;font-size:14px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#F6C84C}
    .btn-acao{padding:8px 15px;border-radius:6px;border:none;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn-acao.pagar{background:rgba(34,197,94,.2);color:#22c55e}.btn-acao.pagar:hover{background:#22c55e;color:#fff}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo"><div class="logo-icon">A</div><div class="logo-text">ACERT<span>IVE</span></div></div>
    <nav>
      <div class="nav-section"><div class="nav-title">Principal</div>
        <a href="/dashboard" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/fila-cobranca" class="nav-item"><i class="fas fa-layer-group"></i> Fila de Cobrança</a>
        <a href="/atendimento" class="nav-item"><i class="fas fa-headset"></i> Atendimento</a>
      </div>
      <div class="nav-section"><div class="nav-title">Cadastros</div>
        <a href="/credores" class="nav-item"><i class="fas fa-building"></i> Credores</a>
        <a href="/devedores" class="nav-item"><i class="fas fa-users"></i> Devedores</a>
        <a href="/dividas" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Dívidas</a>
      </div>
      <div class="nav-section"><div class="nav-title">Negociação</div>
        <a href="/acordos" class="nav-item"><i class="fas fa-handshake"></i> Acordos</a>
        <a href="/parcelas" class="nav-item"><i class="fas fa-calendar-check"></i> Parcelas</a>
        <a href="/simulador" class="nav-item"><i class="fas fa-calculator"></i> Simulador</a>
      </div>
      <div class="nav-section"><div class="nav-title">Financeiro</div>
        <a href="/comissoes" class="nav-item"><i class="fas fa-percentage"></i> Comissões</a>
        <a href="/repasses" class="nav-item active"><i class="fas fa-exchange-alt"></i> Repasses</a>
        <a href="/financeiro" class="nav-item"><i class="fas fa-chart-line"></i> Relatórios</a>
      </div>
      <div class="nav-section"><div class="nav-title">Configurações</div>
        <a href="/regua-cobranca" class="nav-item"><i class="fas fa-robot"></i> Régua de Cobrança</a>
        <a href="/configuracoes" class="nav-item"><i class="fas fa-cog"></i> Configurações</a>
      </div>
    </nav>
    <div class="user-section">
      <div class="user-avatar" id="userAvatar">A</div>
      <div class="user-info"><div class="user-name" id="userName">Administrador</div><div class="user-role" id="userRole">Admin</div></div>
      <div class="user-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <h1><i class="fas fa-exchange-alt" style="color:#F6C84C;margin-right:12px"></i>Repasses</h1>
      <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="calcularPendentes()"><i class="fas fa-calculator"></i> Calcular Pendentes</button>
        <button class="btn btn-primary" onclick="novoRepasse()"><i class="fas fa-plus"></i> Novo Repasse</button>
      </div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card alert">
        <div class="stat-icon red"><i class="fas fa-exclamation-circle"></i></div>
        <div class="stat-label">Pendente de Repasse</div>
        <div class="stat-value" id="statPendente">R$ 0,00</div>
        <div class="stat-sub">valor a repassar aos credores</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
        <div class="stat-label">Repassado (Mês)</div>
        <div class="stat-value" id="statRepassado">R$ 0,00</div>
        <div class="stat-sub">já repassado este mês</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-building"></i></div>
        <div class="stat-label">Credores com Saldo</div>
        <div class="stat-value" id="statCredores">0</div>
        <div class="stat-sub">aguardando repasse</div>
      </div>
    </div>
    
    <h3 style="margin-bottom:20px;font-size:18px"><i class="fas fa-list" style="color:#F6C84C;margin-right:10px"></i>Repasses Pendentes por Credor</h3>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Credor</th>
            <th>Valor Recuperado</th>
            <th>Comissão</th>
            <th>Valor a Repassar</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr>
        </tbody>
      </table>
    </div>
    
    <h3 style="margin:30px 0 20px;font-size:18px"><i class="fas fa-history" style="color:#71717a;margin-right:10px"></i>Histórico de Repasses</h3>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Credor</th>
            <th>Valor</th>
            <th>Forma</th>
            <th>Data</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="historicoBody">
          <tr><td colspan="5" class="empty-state" style="padding:30px"><i class="fas fa-inbox" style="font-size:30px"></i><p style="margin-top:10px">Nenhum repasse realizado</p></td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal Novo Repasse -->
  <div class="modal-overlay" id="modalRepasse">
    <div class="modal">
      <div class="modal-header">
        <h2>Registrar Repasse</h2>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Credor</label>
          <select id="repasseCredor"><option value="">Selecione o credor</option></select>
        </div>
        <div class="form-group">
          <label>Valor do Repasse</label>
          <input type="text" id="repasseValor" placeholder="R$ 0,00">
        </div>
        <div class="form-group">
          <label>Forma de Pagamento</label>
          <select id="repasseForma">
            <option value="pix">PIX</option>
            <option value="ted">TED</option>
            <option value="doc">DOC</option>
            <option value="deposito">Depósito</option>
            <option value="cheque">Cheque</option>
          </select>
        </div>
        <div class="form-group">
          <label>Comprovante (opcional)</label>
          <input type="text" id="repasseComprovante" placeholder="Código ou descrição do comprovante">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
        <button class="btn btn-success" onclick="salvarRepasse()"><i class="fas fa-check"></i> Confirmar Repasse</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL='';let token=localStorage.getItem('token');
    if(!token)window.location.href='/login';
    
    function logout(){localStorage.removeItem('token');window.location.href='/login'}
    function formatMoney(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0)}
    function formatDate(d){if(!d)return'—';return new Date(d).toLocaleDateString('pt-BR')}
    function getInitials(n){if(!n)return'?';const p=n.trim().split(' ');return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():n.substring(0,2).toUpperCase()}
    
    async function fetchAPI(url,opts={}){
      const res=await fetch(API_URL+url,{...opts,headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`,...opts.headers}});
      if(res.status===401){logout();return null}return res.json();
    }
    
    async function carregar(){
      try{
        // Calcular pendentes
        const pendentes=await fetchAPI('/api/financeiro/repasses/calcular');
        if(pendentes&&pendentes.success){
          const dados=pendentes.data||[];
          let totalPendente=0;
          dados.forEach(d=>totalPendente+=parseFloat(d.valor_repassar||0));
          document.getElementById('statPendente').textContent=formatMoney(totalPendente);
          document.getElementById('statCredores').textContent=dados.length;
          renderPendentes(dados);
        }
        
        // Histórico
        const historico=await fetchAPI('/api/financeiro/repasses');
        if(historico&&historico.success){
          let repassado=0;
          (historico.data||[]).forEach(r=>{if(r.status==='pago')repassado+=parseFloat(r.valor||0)});
          document.getElementById('statRepassado').textContent=formatMoney(repassado);
          renderHistorico(historico.data||[]);
        }
        
        carregarCredores();
      }catch(e){console.error(e)}
    }
    
    function renderPendentes(dados){
      const tbody=document.getElementById('tableBody');
      if(!dados||dados.length===0){
        tbody.innerHTML=`<tr><td colspan="5"><div class="empty-state"><i class="fas fa-check-circle" style="color:#22c55e"></i><h3 style="color:#22c55e">Nenhum repasse pendente!</h3><p>Todos os credores estão com repasses em dia.</p></div></td></tr>`;
        return;
      }
      
      tbody.innerHTML=dados.map(d=>`
        <tr>
          <td>
            <div class="credor-info">
              <div class="credor-avatar">${getInitials(d.credor_nome)}</div>
              <div><div class="credor-nome">${d.credor_nome||'Credor'}</div><div class="credor-sub">${d.credor_cnpj||''}</div></div>
            </div>
          </td>
          <td>${formatMoney(d.valor_recuperado)}</td>
          <td class="valor" style="color:#22c55e">- ${formatMoney(d.valor_comissao)}</td>
          <td class="valor destaque">${formatMoney(d.valor_repassar)}</td>
          <td><button class="btn-acao pagar" onclick="pagarRepasse('${d.credor_id}','${d.credor_nome}',${d.valor_repassar})"><i class="fas fa-paper-plane"></i> Repassar</button></td>
        </tr>
      `).join('');
    }
    
    function renderHistorico(dados){
      const tbody=document.getElementById('historicoBody');
      if(!dados||dados.length===0)return;
      
      tbody.innerHTML=dados.slice(0,10).map(r=>`
        <tr>
          <td><div class="credor-info"><div class="credor-avatar">${getInitials(r.credor_nome)}</div><div class="credor-nome">${r.credor_nome||'Credor'}</div></div></td>
          <td class="valor">${formatMoney(r.valor)}</td>
          <td>${r.forma_pagamento||'—'}</td>
          <td>${formatDate(r.data_repasse||r.created_at)}</td>
          <td><span class="status-badge ${r.status}">${r.status==='pago'?'Pago':'Pendente'}</span></td>
        </tr>
      `).join('');
    }
    
    async function carregarCredores(){
      try{
        const data=await fetchAPI('/api/credores');
        if(data&&data.success){
          const sel=document.getElementById('repasseCredor');
          sel.innerHTML='<option value="">Selecione o credor</option>';
          data.data.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nome;sel.appendChild(o)});
        }
      }catch(e){}
    }
    
    function novoRepasse(){document.getElementById('modalRepasse').classList.add('active')}
    function fecharModal(){document.getElementById('modalRepasse').classList.remove('active')}
    
    function pagarRepasse(credorId,credorNome,valor){
      document.getElementById('repasseCredor').value=credorId;
      document.getElementById('repasseValor').value=valor.toFixed(2).replace('.',',');
      novoRepasse();
    }
    
    async function salvarRepasse(){
      const credor=document.getElementById('repasseCredor').value;
      const valor=parseFloat(document.getElementById('repasseValor').value.replace(/[^\d,.-]/g,'').replace(',','.'))||0;
      const forma=document.getElementById('repasseForma').value;
      const comprovante=document.getElementById('repasseComprovante').value;
      
      if(!credor||!valor){alert('Preencha todos os campos obrigatórios');return}
      
      try{
        const res=await fetchAPI('/api/financeiro/repasses',{
          method:'POST',
          body:JSON.stringify({credor_id:credor,valor,forma_pagamento:forma,comprovante,status:'pago'})
        });
        
        if(res&&res.success){
          alert('Repasse registrado com sucesso!');
          fecharModal();
          carregar();
        }else{
          alert(res?.message||'Erro ao registrar repasse');
        }
      }catch(e){alert('Erro ao registrar repasse')}
    }
    
    function calcularPendentes(){carregar()}
    
    // Carregar usuario
    try{
      const payload=JSON.parse(atob(token.split('.')[1]));
      document.getElementById('userName').textContent=payload.nome||'Usuário';
      document.getElementById('userRole').textContent=payload.nivel||'Operador';
      document.getElementById('userAvatar').textContent=(payload.nome||'U')[0].toUpperCase();
    }catch(e){}
    
    carregar();
  </script>
</body>
</html>
