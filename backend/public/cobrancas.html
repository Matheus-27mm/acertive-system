<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cobranças - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #09090b;
      --card: rgba(17,17,21,0.95);
      --text: #fafafa;
      --muted: #71717a;
      --gold: #ca9b3c;
      --gold-glow: rgba(202,155,60,0.12);
      --border: rgba(255,255,255,0.08);
      --green: #22c55e;
      --green-bg: rgba(34,197,94,0.15);
      --red: #ef4444;
      --red-bg: rgba(239,68,68,0.15);
      --blue: #3b82f6;
      --blue-bg: rgba(59,130,246,0.15);
      --orange: #f59e0b;
      --orange-bg: rgba(245,158,11,0.15);
      --purple: #a855f7;
      --purple-bg: rgba(168,85,247,0.15);
      --sidebar: 240px;
      --radius: 12px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    
    /* Sidebar */
    .sidebar { position:fixed; left:0; top:0; width:var(--sidebar); height:100vh; background:var(--bg); border-right:1px solid var(--border); z-index:1000; display:flex; flex-direction:column; }
    .sidebar-header { padding:24px 20px; display:flex; align-items:center; gap:12px; }
    .logo-icon { width:36px; height:36px; background:var(--gold); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:16px; color:var(--bg); }
    .logo-text { font-size:18px; font-weight:700; }
    .logo-text span { color:var(--gold); }
    .sidebar-nav { flex:1; padding:8px 12px; }
    .nav-link { display:flex; align-items:center; gap:12px; padding:12px 16px; color:var(--muted); text-decoration:none; border-radius:10px; font-weight:500; font-size:14px; margin-bottom:4px; transition:all 0.15s; }
    .nav-link:hover { color:var(--text); background:rgba(255,255,255,0.05); }
    .nav-link.active { color:var(--gold); background:var(--gold-glow); }
    .nav-link i { width:20px; text-align:center; }
    .nav-divider { height:1px; background:var(--border); margin:16px 12px; }
    .sidebar-footer { padding:16px; border-top:1px solid var(--border); }
    .user-card { display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,0.03); border-radius:var(--radius); }
    .user-avatar { width:36px; height:36px; background:var(--gold-glow); border:1px solid var(--gold); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; color:var(--gold); }
    .user-info { flex:1; }
    .user-name { font-weight:600; font-size:13px; }
    .user-role { font-size:11px; color:var(--muted); }
    .btn-logout { background:none; border:none; color:var(--muted); cursor:pointer; padding:8px; border-radius:6px; }
    .btn-logout:hover { background:var(--red-bg); color:var(--red); }
    
    /* Main */
    .main { margin-left:var(--sidebar); padding:24px 32px; min-height:100vh; }
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:16px; }
    .page-title { font-size:24px; font-weight:700; display:flex; align-items:center; gap:12px; }
    .page-title i { color:var(--gold); }
    .page-subtitle { font-size:13px; color:var(--muted); margin-top:4px; }
    
    /* Buttons */
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 18px; border-radius:10px; font-weight:600; font-size:13px; cursor:pointer; border:none; transition:all 0.15s; }
    .btn-primary { background:var(--gold); color:var(--bg); }
    .btn-primary:hover { filter:brightness(1.1); }
    .btn-secondary { background:var(--card); color:var(--text); border:1px solid var(--border); }
    .btn-secondary:hover { border-color:var(--gold); color:var(--gold); }
    .btn-success { background:var(--green); color:#fff; }
    .btn-success:hover { filter:brightness(1.1); }
    .btn-danger { background:var(--red-bg); color:var(--red); border:1px solid transparent; }
    .btn-danger:hover { border-color:var(--red); }
    .btn-sm { padding:8px 14px; font-size:12px; }
    .btn-icon { width:36px; height:36px; padding:0; justify-content:center; }
    
    /* Stats */
    .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
    .stat-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; display:flex; align-items:center; gap:16px; }
    .stat-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; }
    .stat-icon.orange { background:var(--orange-bg); color:var(--orange); }
    .stat-icon.gold { background:var(--gold-glow); color:var(--gold); }
    .stat-icon.red { background:var(--red-bg); color:var(--red); }
    .stat-icon.green { background:var(--green-bg); color:var(--green); }
    .stat-label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
    .stat-value { font-size:24px; font-weight:700; margin-top:2px; }
    
    /* Tabs */
    .tabs { display:flex; gap:4px; margin-bottom:24px; background:var(--card); border-radius:var(--radius); padding:4px; border:1px solid var(--border); width:fit-content; }
    .tab { padding:12px 20px; background:transparent; border:none; color:var(--muted); font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; display:flex; align-items:center; gap:8px; transition:all 0.15s; }
    .tab:hover { color:var(--text); }
    .tab.active { background:var(--gold); color:var(--bg); }
    .tab .badge { padding:2px 8px; border-radius:10px; font-size:11px; background:rgba(0,0,0,0.2); }
    
    /* Toolbar */
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:12px; flex-wrap:wrap; }
    .search-box { display:flex; align-items:center; gap:10px; padding:10px 16px; background:var(--card); border:1px solid var(--border); border-radius:10px; min-width:300px; }
    .search-box:focus-within { border-color:var(--gold); }
    .search-box i { color:var(--muted); }
    .search-box input { flex:1; background:none; border:none; outline:none; color:var(--text); font-size:13px; }
    .filter-group { display:flex; gap:8px; }
    
    /* Table */
    .table-container { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
    .table { width:100%; border-collapse:collapse; }
    .table th { text-align:left; padding:14px 20px; font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; background:rgba(0,0,0,0.2); border-bottom:1px solid var(--border); }
    .table td { padding:16px 20px; border-bottom:1px solid var(--border); vertical-align:middle; }
    .table tr:last-child td { border-bottom:none; }
    .table tr:hover { background:rgba(255,255,255,0.02); }
    
    /* Cliente Cell */
    .cliente-cell { display:flex; align-items:center; gap:12px; }
    .cliente-avatar { width:40px; height:40px; background:var(--gold); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; color:var(--bg); flex-shrink:0; }
    .cliente-info { min-width:0; }
    .cliente-nome { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cliente-doc { font-size:12px; color:var(--muted); }
    
    /* Status Badge */
    .status { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; font-size:11px; font-weight:600; text-transform:uppercase; }
    .status.pendente { background:var(--orange-bg); color:var(--orange); }
    .status.vencido { background:var(--red-bg); color:var(--red); }
    .status.pago { background:var(--green-bg); color:var(--green); }
    .status.acordo { background:var(--blue-bg); color:var(--blue); }
    .status.arquivado { background:rgba(255,255,255,0.1); color:var(--muted); }
    .status::before { content:''; width:6px; height:6px; border-radius:50%; background:currentColor; }
    
    /* Valor */
    .valor { font-weight:700; font-size:15px; }
    .valor.destaque { color:var(--gold); font-size:16px; }
    
    /* Vencimento */
    .vencimento { font-size:13px; }
    .vencimento.vencido { color:var(--red); }
    .vencimento .dias { font-size:11px; color:var(--muted); display:block; margin-top:2px; }
    
    /* Actions */
    .actions { display:flex; gap:6px; }
    
    /* Empty State */
    .empty { text-align:center; padding:60px 20px; color:var(--muted); }
    .empty i { font-size:48px; margin-bottom:16px; opacity:0.3; }
    .empty h3 { font-size:18px; color:var(--text); margin-bottom:8px; }
    
    /* Loading */
    .loading { display:flex; justify-content:center; padding:40px; }
    .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    
    /* Modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
    .modal-overlay.show { display:flex; }
    .modal { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); width:100%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; }
    .modal-header { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-header h3 { font-size:18px; font-weight:700; display:flex; align-items:center; gap:10px; }
    .modal-header h3 i { color:var(--gold); }
    .modal-close { background:none; border:none; color:var(--muted); font-size:24px; cursor:pointer; }
    .modal-close:hover { color:var(--red); }
    .modal-body { padding:20px; overflow-y:auto; flex:1; }
    .modal-footer { padding:16px 20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px; }
    
    /* Form */
    .form-group { margin-bottom:16px; }
    .form-group:last-child { margin-bottom:0; }
    .form-group label { display:block; font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px; }
    .form-control { width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:14px; }
    .form-control:focus { outline:none; border-color:var(--gold); }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .input-prefix { position:relative; }
    .input-prefix span { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); font-weight:600; }
    .input-prefix input { padding-left:40px; }
    
    /* Cliente Search */
    .cliente-search-results { position:absolute; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:8px; max-height:200px; overflow-y:auto; z-index:10; display:none; }
    .cliente-search-results.show { display:block; }
    .cliente-search-item { padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--border); }
    .cliente-search-item:hover { background:var(--gold-glow); }
    .cliente-search-item:last-child { border-bottom:none; }
    
    /* Responsive */
    @media(max-width:1200px) { .stats-grid { grid-template-columns:repeat(2,1fr); } }
    @media(max-width:1024px) { .sidebar { transform:translateX(-100%); } .main { margin-left:0; } }
    @media(max-width:768px) { 
      .stats-grid { grid-template-columns:1fr; } 
      .form-row { grid-template-columns:1fr; }
      .table-container { overflow-x:auto; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
      <a href="cobrancas.html" class="nav-link active"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a>
      <a href="acordos.html" class="nav-link"><i class="fas fa-handshake"></i> Acordos</a>
      <a href="financeiro.html" class="nav-link"><i class="fas fa-wallet"></i> Financeiro</a>
      <div class="nav-divider"></div>
      <a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-info">
          <div class="user-name" id="userName">Admin</div>
          <div class="user-role" id="userRole">admin</div>
        </div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <div>
        <h1 class="page-title"><i class="fas fa-file-invoice-dollar"></i> Cobranças</h1>
        <p class="page-subtitle">Gerencie as dívidas dos seus clientes</p>
      </div>
      <button class="btn btn-primary" onclick="abrirModalNova()">
        <i class="fas fa-plus"></i> Nova Cobrança
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
        <div>
          <div class="stat-label">Pendentes</div>
          <div class="stat-value" id="statPendentes">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon red"><i class="fas fa-exclamation-triangle"></i></div>
        <div>
          <div class="stat-label">Vencidas</div>
          <div class="stat-value" id="statVencidas">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon gold"><i class="fas fa-coins"></i></div>
        <div>
          <div class="stat-label">Total a Receber</div>
          <div class="stat-value" id="statTotal">R$ 0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
        <div>
          <div class="stat-label">Recebido (mês)</div>
          <div class="stat-value" id="statRecebido">R$ 0</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="trocarTab('pendentes')">
        <i class="fas fa-clock"></i> Pendentes <span class="badge" id="countPendentes">0</span>
      </button>
      <button class="tab" onclick="trocarTab('vencidas')">
        <i class="fas fa-exclamation-triangle"></i> Vencidas
      </button>
      <button class="tab" onclick="trocarTab('pagas')">
        <i class="fas fa-check"></i> Pagas
      </button>
      <button class="tab" onclick="trocarTab('todas')">
        <i class="fas fa-list"></i> Todas
      </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="busca" placeholder="Buscar cliente ou descrição..." oninput="filtrar()">
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Descrição</th>
            <th>Valor</th>
            <th>Vencimento</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaCobrancas">
          <tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal Nova Cobrança -->
  <div class="modal-overlay" id="modalNova">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-plus-circle"></i> Nova Cobrança</h3>
        <button class="modal-close" onclick="fecharModal('modalNova')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="position:relative">
          <label>Cliente *</label>
          <input type="text" class="form-control" id="novoCliente" placeholder="Buscar cliente..." oninput="buscarCliente(this.value)" autocomplete="off">
          <div class="cliente-search-results" id="resultadosCliente"></div>
          <input type="hidden" id="novoClienteId">
        </div>
        <div id="clienteSelecionado" style="display:none; margin-bottom:16px; padding:12px; background:var(--gold-glow); border:1px solid var(--gold); border-radius:8px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <div class="cliente-avatar" id="selAvatar">--</div>
            <div style="flex:1">
              <div style="font-weight:600" id="selNome">-</div>
              <div style="font-size:12px; color:var(--muted)" id="selDoc">-</div>
            </div>
            <button onclick="limparCliente()" style="background:none; border:none; color:var(--muted); cursor:pointer; padding:8px;">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Descrição *</label>
          <input type="text" class="form-control" id="novoDescricao" placeholder="Ex: Fatura de celular, Empréstimo...">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Valor *</label>
            <div class="input-prefix">
              <span>R$</span>
              <input type="text" class="form-control" id="novoValor" placeholder="0,00" oninput="formatarMoeda(this)">
            </div>
          </div>
          <div class="form-group">
            <label>Vencimento *</label>
            <input type="date" class="form-control" id="novoVencimento">
          </div>
        </div>
        <div class="form-group">
          <label>Observações</label>
          <textarea class="form-control" id="novoObs" rows="2" placeholder="Observações opcionais..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalNova')">Cancelar</button>
        <button class="btn btn-primary" onclick="criarCobranca()">
          <i class="fas fa-check"></i> Criar Cobrança
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Pagar -->
  <div class="modal-overlay" id="modalPagar">
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <h3><i class="fas fa-check-circle"></i> Registrar Pagamento</h3>
        <button class="modal-close" onclick="fecharModal('modalPagar')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align:center; padding:20px 0; border-bottom:1px solid var(--border); margin-bottom:20px;">
          <div style="font-size:14px; color:var(--muted)" id="pagarDescricao">-</div>
          <div style="font-size:32px; font-weight:700; color:var(--gold); margin:8px 0" id="pagarValor">R$ 0,00</div>
        </div>
        <div class="form-group">
          <label>Data do Pagamento</label>
          <input type="date" class="form-control" id="pagarData">
        </div>
        <div class="form-group">
          <label>Forma de Pagamento</label>
          <select class="form-control" id="pagarForma">
            <option value="pix">PIX</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="cartao">Cartão</option>
            <option value="boleto">Boleto</option>
            <option value="transferencia">Transferência</option>
          </select>
        </div>
        <input type="hidden" id="pagarId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalPagar')">Cancelar</button>
        <button class="btn btn-success" onclick="confirmarPagamento()">
          <i class="fas fa-check"></i> Confirmar Pagamento
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Acordo -->
  <div class="modal-overlay" id="modalAcordo">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-handshake"></i> Criar Acordo</h3>
        <button class="modal-close" onclick="fecharModal('modalAcordo')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="padding:16px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:20px;">
          <div style="font-size:12px; color:var(--muted)">Dívida Original</div>
          <div style="font-size:24px; font-weight:700; color:var(--gold)" id="acordoValorOriginal">R$ 0,00</div>
          <div style="font-size:13px; color:var(--muted); margin-top:4px" id="acordoDescricao">-</div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Desconto (%)</label>
            <input type="number" class="form-control" id="acordoDesconto" value="0" min="0" max="100" oninput="calcularAcordo()">
          </div>
          <div class="form-group">
            <label>Parcelas</label>
            <select class="form-control" id="acordoParcelas" onchange="calcularAcordo()">
              <option value="1">1x (à vista)</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
              <option value="4">4x</option>
              <option value="5">5x</option>
              <option value="6" selected>6x</option>
              <option value="10">10x</option>
              <option value="12">12x</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Entrada (R$)</label>
          <div class="input-prefix">
            <span>R$</span>
            <input type="text" class="form-control" id="acordoEntrada" value="0,00" oninput="formatarMoeda(this); calcularAcordo()">
          </div>
        </div>
        <div class="form-group">
          <label>Primeiro Vencimento</label>
          <input type="date" class="form-control" id="acordoPrimeiroVenc">
        </div>
        <div style="padding:16px; background:var(--gold-glow); border:1px solid var(--gold); border-radius:8px; margin-top:16px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span style="color:var(--muted)">Valor com desconto:</span>
            <span style="font-weight:600" id="acordoValorFinal">R$ 0,00</span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span style="color:var(--muted)">Entrada:</span>
            <span style="font-weight:600" id="acordoEntradaRes">R$ 0,00</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.2);">
            <span style="font-weight:600">Parcelas:</span>
            <span style="font-weight:700; color:var(--gold); font-size:18px" id="acordoParcelasRes">6x de R$ 0,00</span>
          </div>
        </div>
        <input type="hidden" id="acordoCobrancaId">
        <input type="hidden" id="acordoClienteId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalAcordo')">Cancelar</button>
        <button class="btn btn-primary" onclick="criarAcordo()">
          <i class="fas fa-handshake"></i> Criar Acordo
        </button>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    let token = localStorage.getItem('token');
    if (!token) window.location.href = 'login.html';
    
    let cobrancas = [];
    let currentTab = 'pendentes';
    
    const H = () => ({ 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token });
    const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    const fmtMoney = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
    const parseMoney = s => parseFloat((s || '0').toString().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const initials = n => (n || '').split(' ').map(p => p[0]).slice(0, 2).join('').toUpperCase();
    const formatarMoeda = el => {
      let v = el.value.replace(/\D/g, '');
      v = (parseInt(v || 0) / 100).toFixed(2);
      el.value = parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    };
    const fecharModal = id => document.getElementById(id).classList.remove('show');
    
    // Calcular dias de vencimento
    function diasVencimento(dataVenc) {
      if (!dataVenc) return null;
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const venc = new Date(dataVenc + 'T00:00:00');
      const diff = Math.floor((venc - hoje) / (1000 * 60 * 60 * 24));
      return diff;
    }
    
    // Carregar usuário
    async function carregarUsuario() {
      try {
        const r = await fetch(API + '/api/auth/me', { headers: H() });
        if (r.ok) {
          const d = await r.json();
          if (d.user) {
            document.getElementById('userName').textContent = d.user.nome;
            document.getElementById('userAvatar').textContent = initials(d.user.nome);
          }
        }
      } catch (e) {}
    }
    
    // Carregar estatísticas
    async function carregarEstatisticas() {
      try {
        const r = await fetch(API + '/api/cobrancas/stats', { headers: H() });
        const d = await r.json();
        if (d.success && d.data) {
          document.getElementById('statPendentes').textContent = d.data.pendentes || 0;
          document.getElementById('statVencidas').textContent = d.data.vencidas || 0;
          document.getElementById('statTotal').textContent = fmtMoney(d.data.totalPendente);
          document.getElementById('statRecebido').textContent = fmtMoney(d.data.recebidoMes);
          document.getElementById('countPendentes').textContent = d.data.pendentes || 0;
        }
      } catch (e) {}
    }
    
    // Carregar cobranças
    async function carregarCobrancas() {
      try {
        const r = await fetch(API + '/api/cobrancas?limit=200', { headers: H() });
        const d = await r.json();
        if (d.success) {
          cobrancas = d.data || [];
          renderizar();
        }
      } catch (e) {
        document.getElementById('tabelaCobrancas').innerHTML = '<tr><td colspan="6"><div class="empty"><i class="fas fa-exclamation-circle"></i><p>Erro ao carregar</p></div></td></tr>';
      }
    }
    
    // Renderizar tabela
    function renderizar() {
      const tbody = document.getElementById('tabelaCobrancas');
      const busca = document.getElementById('busca').value.toLowerCase();
      const hoje = new Date().toISOString().split('T')[0];
      
      let filtradas = cobrancas.filter(c => {
        // Ignorar cobranças que já viraram acordo
        if (c.status === 'acordo') return false;
        
        if (currentTab === 'pendentes') {
          const venc = c.vencimento || c.data_vencimento;
          return c.status === 'pendente' && (!venc || venc >= hoje);
        }
        if (currentTab === 'vencidas') {
          const venc = c.vencimento || c.data_vencimento;
          return (c.status === 'pendente' || c.status === 'vencido') && venc && venc < hoje;
        }
        if (currentTab === 'pagas') return c.status === 'pago';
        return c.status !== 'acordo'; // todas menos acordos
      });
      
      if (busca) {
        filtradas = filtradas.filter(c => 
          c.cliente_nome?.toLowerCase().includes(busca) ||
          c.descricao?.toLowerCase().includes(busca)
        );
      }
      
      if (filtradas.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6">
            <div class="empty">
              <i class="fas fa-file-invoice-dollar"></i>
              <h3>Nenhuma cobrança</h3>
              <p>Clique em "Nova Cobrança" para começar</p>
            </div>
          </td></tr>`;
        return;
      }
      
      tbody.innerHTML = filtradas.map(c => {
        const venc = c.vencimento || c.data_vencimento;
        const dias = diasVencimento(venc);
        const vencido = dias !== null && dias < 0;
        const venceHoje = dias === 0;
        
        let statusClass = c.status;
        if (c.status === 'pendente' && vencido) statusClass = 'vencido';
        
        let diasTexto = '';
        if (dias !== null && c.status !== 'pago') {
          if (dias < 0) diasTexto = `${Math.abs(dias)} dias atrás`;
          else if (dias === 0) diasTexto = 'Vence hoje';
          else diasTexto = `em ${dias} dias`;
        }
        
        return `
          <tr>
            <td>
              <div class="cliente-cell">
                <div class="cliente-avatar">${initials(c.cliente_nome)}</div>
                <div class="cliente-info">
                  <div class="cliente-nome">${c.cliente_nome || '-'}</div>
                  <div class="cliente-doc">${c.cliente_cpf || ''}</div>
                </div>
              </div>
            </td>
            <td>${c.descricao || '-'}</td>
            <td><span class="valor destaque">${fmtMoney(c.valor || c.valor_original)}</span></td>
            <td>
              <div class="vencimento ${vencido ? 'vencido' : ''}">
                ${venc ? new Date(venc + 'T12:00:00').toLocaleDateString('pt-BR') : '-'}
                ${diasTexto ? `<span class="dias">${diasTexto}</span>` : ''}
              </div>
            </td>
            <td><span class="status ${statusClass}">${statusClass}</span></td>
            <td>
              <div class="actions">
                ${c.status !== 'pago' ? `
                  <button class="btn btn-sm btn-success" onclick="abrirModalPagar('${c.id}', '${c.descricao || ''}', ${c.valor || c.valor_original})" title="Pagar">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="abrirModalAcordo('${c.id}', '${c.cliente_id}', '${c.descricao || ''}', ${c.valor || c.valor_original})" title="Criar Acordo">
                    <i class="fas fa-handshake"></i>
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="enviarWhatsapp('${c.id}')" title="WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                  </button>
                ` : `
                  <span style="color:var(--muted); font-size:12px">
                    <i class="fas fa-check-circle"></i> Pago
                  </span>
                `}
              </div>
            </td>
          </tr>`;
      }).join('');
    }
    
    // Trocar tab
    function trocarTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="trocarTab('${tab}')"]`).classList.add('active');
      renderizar();
    }
    
    function filtrar() { renderizar(); }
    
    // ========== NOVA COBRANÇA ==========
    function abrirModalNova() {
      document.getElementById('novoClienteId').value = '';
      document.getElementById('novoCliente').value = '';
      document.getElementById('novoCliente').style.display = 'block';
      document.getElementById('clienteSelecionado').style.display = 'none';
      document.getElementById('novoDescricao').value = '';
      document.getElementById('novoValor').value = '';
      document.getElementById('novoObs').value = '';
      
      // Data padrão: hoje + 30 dias
      const data = new Date();
      data.setDate(data.getDate() + 30);
      document.getElementById('novoVencimento').value = data.toISOString().split('T')[0];
      
      document.getElementById('modalNova').classList.add('show');
    }
    
    let buscaTimeout;
    async function buscarCliente(termo) {
      clearTimeout(buscaTimeout);
      const container = document.getElementById('resultadosCliente');
      
      if (termo.length < 2) {
        container.classList.remove('show');
        return;
      }
      
      buscaTimeout = setTimeout(async () => {
        try {
          const r = await fetch(API + '/api/clientes?q=' + encodeURIComponent(termo), { headers: H() });
          const d = await r.json();
          
          if (d.success && d.data?.length > 0) {
            container.innerHTML = d.data.slice(0, 8).map(c => `
              <div class="cliente-search-item" onclick="selecionarCliente('${c.id}', '${c.nome}', '${c.cpf_cnpj || ''}')">
                <div style="font-weight:600">${c.nome}</div>
                <div style="font-size:11px; color:var(--muted)">${c.cpf_cnpj || '-'}</div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<div style="padding:16px; text-align:center; color:var(--muted)">Nenhum cliente encontrado</div>';
          }
          container.classList.add('show');
        } catch (e) {}
      }, 300);
    }
    
    function selecionarCliente(id, nome, doc) {
      document.getElementById('novoClienteId').value = id;
      document.getElementById('selAvatar').textContent = initials(nome);
      document.getElementById('selNome').textContent = nome;
      document.getElementById('selDoc').textContent = doc || '-';
      document.getElementById('novoCliente').style.display = 'none';
      document.getElementById('clienteSelecionado').style.display = 'block';
      document.getElementById('resultadosCliente').classList.remove('show');
    }
    
    function limparCliente() {
      document.getElementById('novoClienteId').value = '';
      document.getElementById('novoCliente').value = '';
      document.getElementById('novoCliente').style.display = 'block';
      document.getElementById('clienteSelecionado').style.display = 'none';
    }
    
    async function criarCobranca() {
      const clienteId = document.getElementById('novoClienteId').value;
      const descricao = document.getElementById('novoDescricao').value.trim();
      const valor = parseMoney(document.getElementById('novoValor').value);
      const vencimento = document.getElementById('novoVencimento').value;
      const obs = document.getElementById('novoObs').value.trim();
      
      if (!clienteId) { alert('Selecione um cliente'); return; }
      if (!descricao) { alert('Informe a descrição'); return; }
      if (valor <= 0) { alert('Informe o valor'); return; }
      if (!vencimento) { alert('Informe o vencimento'); return; }
      
      try {
        const r = await fetch(API + '/api/cobrancas', {
          method: 'POST',
          headers: H(),
          body: JSON.stringify({
            cliente_id: clienteId,
            descricao,
            valor,
            vencimento,
            observacoes: obs,
            status: 'pendente'
          })
        });
        
        const d = await r.json();
        if (d.success) {
          fecharModal('modalNova');
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Cobrança criada!');
        } else {
          alert(d.error || 'Erro ao criar cobrança');
        }
      } catch (e) {
        alert('Erro ao criar cobrança');
      }
    }
    
    // ========== PAGAR ==========
    function abrirModalPagar(id, descricao, valor) {
      document.getElementById('pagarId').value = id;
      document.getElementById('pagarDescricao').textContent = descricao || '-';
      document.getElementById('pagarValor').textContent = fmtMoney(valor);
      document.getElementById('pagarData').value = new Date().toISOString().split('T')[0];
      document.getElementById('modalPagar').classList.add('show');
    }
    
    async function confirmarPagamento() {
      const id = document.getElementById('pagarId').value;
      const data = document.getElementById('pagarData').value;
      const forma = document.getElementById('pagarForma').value;
      
      try {
        const r = await fetch(API + '/api/cobrancas/' + id + '/pagar', {
          method: 'PUT',
          headers: H(),
          body: JSON.stringify({ data_pagamento: data, forma_pagamento: forma })
        });
        
        const d = await r.json();
        if (d.success) {
          fecharModal('modalPagar');
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Pagamento registrado!');
        } else {
          alert(d.error || 'Erro');
        }
      } catch (e) {
        alert('Erro ao registrar pagamento');
      }
    }
    
    // ========== ACORDO ==========
    let acordoValorOriginal = 0;
    
    function abrirModalAcordo(cobrancaId, clienteId, descricao, valor) {
      acordoValorOriginal = valor;
      document.getElementById('acordoCobrancaId').value = cobrancaId;
      document.getElementById('acordoClienteId').value = clienteId;
      document.getElementById('acordoValorOriginal').textContent = fmtMoney(valor);
      document.getElementById('acordoDescricao').textContent = descricao || '-';
      document.getElementById('acordoDesconto').value = 0;
      document.getElementById('acordoParcelas').value = '6';
      document.getElementById('acordoEntrada').value = '0,00';
      
      const data = new Date();
      data.setDate(data.getDate() + 7);
      document.getElementById('acordoPrimeiroVenc').value = data.toISOString().split('T')[0];
      
      calcularAcordo();
      document.getElementById('modalAcordo').classList.add('show');
    }
    
    function calcularAcordo() {
      const desconto = parseFloat(document.getElementById('acordoDesconto').value) || 0;
      const parcelas = parseInt(document.getElementById('acordoParcelas').value) || 1;
      const entrada = parseMoney(document.getElementById('acordoEntrada').value);
      
      const valorComDesconto = acordoValorOriginal * (1 - desconto / 100);
      const valorRestante = valorComDesconto - entrada;
      const valorParcela = parcelas > 0 ? valorRestante / parcelas : 0;
      
      document.getElementById('acordoValorFinal').textContent = fmtMoney(valorComDesconto);
      document.getElementById('acordoEntradaRes').textContent = fmtMoney(entrada);
      document.getElementById('acordoParcelasRes').textContent = `${parcelas}x de ${fmtMoney(valorParcela)}`;
    }
    
    async function criarAcordo() {
      const cobrancaId = document.getElementById('acordoCobrancaId').value;
      const clienteId = document.getElementById('acordoClienteId').value;
      const desconto = parseFloat(document.getElementById('acordoDesconto').value) || 0;
      const parcelas = parseInt(document.getElementById('acordoParcelas').value) || 1;
      const entrada = parseMoney(document.getElementById('acordoEntrada').value);
      const primeiroVenc = document.getElementById('acordoPrimeiroVenc').value;
      
      if (!primeiroVenc) { alert('Informe o primeiro vencimento'); return; }
      
      const valorAcordo = acordoValorOriginal * (1 - desconto / 100);
      
      try {
        const r = await fetch(API + '/api/acordos', {
          method: 'POST',
          headers: H(),
          body: JSON.stringify({
            cobranca_id: cobrancaId,
            cliente_id: clienteId,
            valor_original: acordoValorOriginal,
            valor_acordo: valorAcordo,
            desconto_percentual: desconto,
            valor_entrada: entrada,
            numero_parcelas: parcelas,
            data_primeiro_vencimento: primeiroVenc
          })
        });
        
        const d = await r.json();
        if (d.success) {
          fecharModal('modalAcordo');
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Acordo criado! Veja na tela de Acordos.');
        } else {
          alert(d.error || 'Erro ao criar acordo');
        }
      } catch (e) {
        alert('Erro ao criar acordo');
      }
    }
    
    // ========== WHATSAPP ==========
    async function enviarWhatsapp(cobrancaId) {
      try {
        const r = await fetch(API + '/api/cobrancas/' + cobrancaId + '/whatsapp', { headers: H() });
        const d = await r.json();
        if (d.success && d.link) {
          window.open(d.link, '_blank');
        } else {
          alert(d.error || 'Erro ao gerar link');
        }
      } catch (e) {
        alert('Erro');
      }
    }
    
    // Inicializar
    carregarUsuario();
    carregarEstatisticas();
    carregarCobrancas();
  </script>
</body>
</html>