<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cobranças - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #09090b;
      --card: rgba(17,17,21,0.95);
      --card-hover: rgba(25,25,30,0.95);
      --text: #fafafa;
      --muted: #71717a;
      --gold: #ca9b3c;
      --gold-glow: rgba(202,155,60,0.12);
      --border: rgba(255,255,255,0.08);
      --green: #22c55e;
      --green-bg: rgba(34,197,94,0.15);
      --red: #ef4444;
      --red-bg: rgba(239,68,68,0.15);
      --blue: #3b82f6;
      --blue-bg: rgba(59,130,246,0.15);
      --orange: #f59e0b;
      --orange-bg: rgba(245,158,11,0.15);
      --purple: #a855f7;
      --sidebar: 240px;
      --radius: 12px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    
    /* Sidebar */
    .sidebar { position:fixed; left:0; top:0; width:var(--sidebar); height:100vh; background:var(--bg); border-right:1px solid var(--border); z-index:1000; display:flex; flex-direction:column; }
    .sidebar-header { padding:24px 20px; display:flex; align-items:center; gap:12px; }
    .logo-icon { width:36px; height:36px; background:var(--gold); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:16px; color:var(--bg); }
    .logo-text { font-size:18px; font-weight:700; }
    .logo-text span { color:var(--gold); }
    .sidebar-nav { flex:1; padding:8px 12px; }
    .nav-link { display:flex; align-items:center; gap:12px; padding:12px 16px; color:var(--muted); text-decoration:none; border-radius:10px; font-weight:500; font-size:14px; margin-bottom:4px; transition:all 0.15s; }
    .nav-link:hover { color:var(--text); background:rgba(255,255,255,0.05); }
    .nav-link.active { color:var(--gold); background:var(--gold-glow); }
    .nav-link i { width:20px; text-align:center; }
    .nav-divider { height:1px; background:var(--border); margin:16px 12px; }
    .sidebar-footer { padding:16px; border-top:1px solid var(--border); }
    .user-card { display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,0.03); border-radius:var(--radius); }
    .user-avatar { width:36px; height:36px; background:var(--gold-glow); border:1px solid var(--gold); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; color:var(--gold); }
    .user-info { flex:1; }
    .user-name { font-weight:600; font-size:13px; }
    .user-role { font-size:11px; color:var(--muted); }
    .btn-logout { background:none; border:none; color:var(--muted); cursor:pointer; padding:8px; border-radius:6px; }
    .btn-logout:hover { background:var(--red-bg); color:var(--red); }
    
    /* Main */
    .main { margin-left:var(--sidebar); padding:24px 32px; min-height:100vh; }
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:16px; }
    .page-title { font-size:24px; font-weight:700; display:flex; align-items:center; gap:12px; }
    .page-title i { color:var(--gold); }
    .page-subtitle { font-size:13px; color:var(--muted); margin-top:4px; }
    
    /* Buttons */
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 18px; border-radius:10px; font-weight:600; font-size:13px; cursor:pointer; border:none; transition:all 0.15s; }
    .btn-primary { background:var(--gold); color:var(--bg); }
    .btn-primary:hover { filter:brightness(1.1); transform:translateY(-1px); }
    .btn-secondary { background:var(--card); color:var(--text); border:1px solid var(--border); }
    .btn-secondary:hover { border-color:var(--gold); color:var(--gold); }
    .btn-success { background:var(--green); color:#fff; }
    .btn-success:hover { filter:brightness(1.1); }
    .btn-danger { background:var(--red-bg); color:var(--red); border:1px solid transparent; }
    .btn-danger:hover { border-color:var(--red); }
    .btn-sm { padding:8px 14px; font-size:12px; }
    .btn-xs { padding:6px 10px; font-size:11px; }
    .btn-icon { width:32px; height:32px; padding:0; justify-content:center; border-radius:8px; }
    
    /* Stats */
    .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
    .stat-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; display:flex; align-items:center; gap:16px; }
    .stat-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; }
    .stat-icon.orange { background:var(--orange-bg); color:var(--orange); }
    .stat-icon.gold { background:var(--gold-glow); color:var(--gold); }
    .stat-icon.red { background:var(--red-bg); color:var(--red); }
    .stat-icon.green { background:var(--green-bg); color:var(--green); }
    .stat-label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
    .stat-value { font-size:24px; font-weight:700; margin-top:2px; }
    
    /* Toolbar */
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:12px; flex-wrap:wrap; }
    .toolbar-left { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .search-box { display:flex; align-items:center; gap:10px; padding:10px 16px; background:var(--card); border:1px solid var(--border); border-radius:10px; min-width:280px; }
    .search-box:focus-within { border-color:var(--gold); }
    .search-box i { color:var(--muted); }
    .search-box input { flex:1; background:none; border:none; outline:none; color:var(--text); font-size:13px; }
    .filter-select { padding:10px 14px; background:var(--card); border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:13px; cursor:pointer; }
    .filter-select:focus { border-color:var(--gold); outline:none; }
    
    /* Tabs */
    .tabs { display:flex; gap:4px; background:var(--card); border-radius:var(--radius); padding:4px; border:1px solid var(--border); }
    .tab { padding:10px 16px; background:transparent; border:none; color:var(--muted); font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; display:flex; align-items:center; gap:8px; transition:all 0.15s; }
    .tab:hover { color:var(--text); }
    .tab.active { background:var(--gold); color:var(--bg); }
    .tab .badge { padding:2px 8px; border-radius:10px; font-size:11px; background:rgba(0,0,0,0.2); }
    
    /* Cliente Card */
    .cliente-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:12px; overflow:hidden; transition:all 0.2s; }
    .cliente-card:hover { border-color:rgba(255,255,255,0.15); }
    .cliente-card.expanded { border-color:var(--gold); }
    
    .cliente-header { padding:16px 20px; display:flex; align-items:center; gap:16px; cursor:pointer; }
    .cliente-header:hover { background:rgba(255,255,255,0.02); }
    
    .cliente-avatar { width:48px; height:48px; background:var(--gold); border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; color:var(--bg); flex-shrink:0; }
    
    .cliente-info { flex:1; min-width:0; }
    .cliente-nome { font-weight:700; font-size:15px; margin-bottom:4px; display:flex; align-items:center; gap:10px; }
    .cliente-meta { display:flex; align-items:center; gap:16px; font-size:12px; color:var(--muted); flex-wrap:wrap; }
    .cliente-meta i { margin-right:4px; }
    .cliente-meta .telefone { color:var(--green); cursor:pointer; }
    .cliente-meta .telefone:hover { text-decoration:underline; }
    
    .cliente-resumo { display:flex; align-items:center; gap:24px; }
    .resumo-item { text-align:right; }
    .resumo-label { font-size:11px; color:var(--muted); text-transform:uppercase; }
    .resumo-valor { font-size:18px; font-weight:700; color:var(--gold); }
    .resumo-valor.vencido { color:var(--red); }
    
    .cliente-toggle { width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.05); color:var(--muted); transition:all 0.2s; }
    .cliente-card.expanded .cliente-toggle { background:var(--gold-glow); color:var(--gold); transform:rotate(180deg); }
    
    /* Cobranças List */
    .cobrancas-list { display:none; border-top:1px solid var(--border); background:rgba(0,0,0,0.2); }
    .cliente-card.expanded .cobrancas-list { display:block; }
    
    .cobranca-item { display:flex; align-items:center; gap:16px; padding:14px 20px; border-bottom:1px solid var(--border); transition:background 0.15s; }
    .cobranca-item:last-child { border-bottom:none; }
    .cobranca-item:hover { background:rgba(255,255,255,0.02); }
    
    .cobranca-check { width:20px; height:20px; border:2px solid var(--border); border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; }
    .cobranca-check:hover { border-color:var(--gold); }
    .cobranca-check.checked { background:var(--gold); border-color:var(--gold); }
    .cobranca-check.checked::after { content:'✓'; color:var(--bg); font-size:12px; font-weight:700; }
    
    .cobranca-info { flex:1; min-width:0; }
    .cobranca-descricao { font-weight:600; font-size:14px; margin-bottom:2px; }
    .cobranca-detalhe { font-size:12px; color:var(--muted); }
    
    .cobranca-valor { text-align:right; min-width:100px; }
    .cobranca-valor-num { font-weight:700; font-size:15px; color:var(--gold); }
    
    .cobranca-vencimento { text-align:center; min-width:120px; }
    .cobranca-data { font-size:13px; font-weight:500; }
    .cobranca-dias { font-size:11px; padding:3px 8px; border-radius:20px; margin-top:4px; display:inline-block; }
    .cobranca-dias.vencido { background:var(--red-bg); color:var(--red); }
    .cobranca-dias.hoje { background:var(--orange-bg); color:var(--orange); }
    .cobranca-dias.futuro { background:var(--green-bg); color:var(--green); }
    
    .cobranca-status { min-width:90px; text-align:center; }
    .status-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; font-size:11px; font-weight:600; text-transform:uppercase; }
    .status-badge.pendente { background:var(--orange-bg); color:var(--orange); }
    .status-badge.vencido { background:var(--red-bg); color:var(--red); }
    .status-badge.pago { background:var(--green-bg); color:var(--green); }
    .status-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:currentColor; }
    
    .cobranca-acoes { display:flex; gap:6px; }
    
    /* Ações do Cliente */
    .cliente-acoes { padding:16px 20px; background:rgba(0,0,0,0.3); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
    .acoes-selecionadas { display:flex; gap:8px; align-items:center; }
    .selecionadas-texto { font-size:13px; color:var(--muted); margin-right:8px; }
    .acoes-rapidas { display:flex; gap:8px; }
    
    /* Empty State */
    .empty { text-align:center; padding:60px 20px; color:var(--muted); }
    .empty i { font-size:48px; margin-bottom:16px; opacity:0.3; }
    .empty h3 { font-size:18px; color:var(--text); margin-bottom:8px; }
    
    /* Loading */
    .loading { display:flex; justify-content:center; padding:40px; }
    .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    
    /* Modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
    .modal-overlay.show { display:flex; }
    .modal { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); width:100%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; }
    .modal-header { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-header h3 { font-size:18px; font-weight:700; display:flex; align-items:center; gap:10px; }
    .modal-header h3 i { color:var(--gold); }
    .modal-close { background:none; border:none; color:var(--muted); font-size:24px; cursor:pointer; }
    .modal-close:hover { color:var(--red); }
    .modal-body { padding:20px; overflow-y:auto; flex:1; }
    .modal-footer { padding:16px 20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px; }
    
    /* Form */
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px; }
    .form-control { width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:14px; }
    .form-control:focus { outline:none; border-color:var(--gold); }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .input-prefix { position:relative; }
    .input-prefix span { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); font-weight:600; }
    .input-prefix input { padding-left:40px; }
    
    /* Cliente Search */
    .cliente-search-container { position:relative; }
    .cliente-search-results { position:absolute; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:8px; max-height:200px; overflow-y:auto; z-index:10; display:none; }
    .cliente-search-results.show { display:block; }
    .cliente-search-item { padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--border); }
    .cliente-search-item:hover { background:var(--gold-glow); }
    .cliente-search-item:last-child { border-bottom:none; }
    .cliente-selecionado { display:flex; align-items:center; gap:12px; padding:12px; background:var(--gold-glow); border:1px solid var(--gold); border-radius:8px; margin-top:8px; }
    
    /* Responsive */
    @media(max-width:1200px) { .stats-grid { grid-template-columns:repeat(2,1fr); } }
    @media(max-width:1024px) { .sidebar { transform:translateX(-100%); } .main { margin-left:0; } }
    @media(max-width:768px) { 
      .stats-grid { grid-template-columns:1fr; } 
      .form-row { grid-template-columns:1fr; }
      .cliente-resumo { flex-direction:column; gap:8px; }
      .cobranca-item { flex-wrap:wrap; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
      <a href="cobrancas.html" class="nav-link active"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a>
      <a href="acordos.html" class="nav-link"><i class="fas fa-handshake"></i> Acordos</a>
      <a href="financeiro.html" class="nav-link"><i class="fas fa-wallet"></i> Financeiro</a>
      <div class="nav-divider"></div>
      <a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-info">
          <div class="user-name" id="userName">Admin</div>
          <div class="user-role" id="userRole">admin</div>
        </div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <div>
        <h1 class="page-title"><i class="fas fa-file-invoice-dollar"></i> Cobranças</h1>
        <p class="page-subtitle">Gerencie as dívidas dos seus clientes</p>
      </div>
      <button class="btn btn-primary" onclick="abrirModalNova()">
        <i class="fas fa-plus"></i> Nova Cobrança
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-users"></i></div>
        <div>
          <div class="stat-label">Clientes com Dívidas</div>
          <div class="stat-value" id="statClientes">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon red"><i class="fas fa-exclamation-triangle"></i></div>
        <div>
          <div class="stat-label">Cobranças Vencidas</div>
          <div class="stat-value" id="statVencidas">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon gold"><i class="fas fa-coins"></i></div>
        <div>
          <div class="stat-label">Total a Receber</div>
          <div class="stat-value" id="statTotal">R$ 0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
        <div>
          <div class="stat-label">Recebido (mês)</div>
          <div class="stat-value" id="statRecebido">R$ 0</div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="busca" placeholder="Buscar cliente..." oninput="filtrar()">
        </div>
        <div class="tabs">
          <button class="tab active" onclick="trocarTab('todos')">
            <i class="fas fa-list"></i> Todos
          </button>
          <button class="tab" onclick="trocarTab('vencidos')">
            <i class="fas fa-exclamation-triangle"></i> Vencidos
          </button>
          <button class="tab" onclick="trocarTab('pendentes')">
            <i class="fas fa-clock"></i> A Vencer
          </button>
        </div>
      </div>
    </div>

    <!-- Lista de Clientes -->
    <div id="listaClientes">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </main>

  <!-- Modal Nova Cobrança -->
  <div class="modal-overlay" id="modalNova">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-plus-circle"></i> Nova Cobrança</h3>
        <button class="modal-close" onclick="fecharModal('modalNova')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group cliente-search-container">
          <label>Cliente *</label>
          <input type="text" class="form-control" id="novoCliente" placeholder="Buscar cliente..." oninput="buscarCliente(this.value)" autocomplete="off">
          <div class="cliente-search-results" id="resultadosCliente"></div>
          <input type="hidden" id="novoClienteId">
          <div id="clienteSelecionado" style="display:none" class="cliente-selecionado">
            <div class="cliente-avatar" id="selAvatar" style="width:36px;height:36px;font-size:14px;">--</div>
            <div style="flex:1">
              <div style="font-weight:600" id="selNome">-</div>
              <div style="font-size:12px;color:var(--muted)" id="selDoc">-</div>
            </div>
            <button onclick="limparCliente()" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:8px;">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Credor <span style="color:var(--muted);font-weight:400">(opcional)</span></label>
          <select class="form-control" id="novoCredor">
            <option value="">Sem credor específico</option>
          </select>
        </div>
        <div class="form-group">
          <label>Descrição *</label>
          <input type="text" class="form-control" id="novoDescricao" placeholder="Ex: Fatura de celular, Empréstimo...">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Categoria</label>
            <select class="form-control" id="novoCategoria">
              <option value="outros">Outros</option>
              <option value="emprestimo">Empréstimo</option>
              <option value="cartao">Cartão de Crédito</option>
              <option value="financiamento">Financiamento</option>
              <option value="telecom">Celular / Telecom</option>
              <option value="servicos">Serviços</option>
              <option value="boleto">Boleto</option>
              <option value="mensalidade">Mensalidade</option>
            </select>
          </div>
          <div class="form-group">
            <label>Vencimento *</label>
            <input type="date" class="form-control" id="novoVencimento">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Valor *</label>
            <div class="input-prefix">
              <span>R$</span>
              <input type="text" class="form-control" id="novoValor" placeholder="0,00" oninput="formatarMoeda(this)">
            </div>
          </div>
          <div class="form-group">
            <label>Referência <span style="color:var(--muted);font-weight:400">(opcional)</span></label>
            <input type="text" class="form-control" id="novoReferencia" placeholder="Nº contrato, protocolo...">
          </div>
        </div>
        <div class="form-group">
          <label>Observações</label>
          <textarea class="form-control" id="novoObs" rows="2" placeholder="Observações opcionais..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalNova')">Cancelar</button>
        <button class="btn btn-primary" onclick="criarCobranca()">
          <i class="fas fa-check"></i> Criar Cobrança
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Pagar -->
  <div class="modal-overlay" id="modalPagar">
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <h3><i class="fas fa-check-circle"></i> Registrar Pagamento</h3>
        <button class="modal-close" onclick="fecharModal('modalPagar')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;">
          <div style="font-size:14px;color:var(--muted)" id="pagarCliente">-</div>
          <div style="font-size:28px;font-weight:700;color:var(--gold);margin:8px 0" id="pagarValor">R$ 0,00</div>
          <div style="font-size:13px;color:var(--muted)" id="pagarDescricao">-</div>
        </div>
        <div class="form-group">
          <label>Data do Pagamento</label>
          <input type="date" class="form-control" id="pagarData">
        </div>
        <div class="form-group">
          <label>Forma de Pagamento</label>
          <select class="form-control" id="pagarForma">
            <option value="pix">PIX</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="cartao">Cartão</option>
            <option value="boleto">Boleto</option>
            <option value="transferencia">Transferência</option>
          </select>
        </div>
        <input type="hidden" id="pagarId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalPagar')">Cancelar</button>
        <button class="btn btn-success" onclick="confirmarPagamento()">
          <i class="fas fa-check"></i> Confirmar Pagamento
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Acordo -->
  <div class="modal-overlay" id="modalAcordo">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-handshake"></i> Criar Acordo</h3>
        <button class="modal-close" onclick="fecharModal('modalAcordo')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:20px;">
          <div style="font-size:12px;color:var(--muted)">Dívida Total Selecionada</div>
          <div style="font-size:24px;font-weight:700;color:var(--gold)" id="acordoValorOriginal">R$ 0,00</div>
          <div style="font-size:13px;color:var(--muted);margin-top:4px" id="acordoQtd">0 cobrança(s)</div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Desconto (%)</label>
            <input type="number" class="form-control" id="acordoDesconto" value="0" min="0" max="100" oninput="calcularAcordo()">
          </div>
          <div class="form-group">
            <label>Parcelas</label>
            <select class="form-control" id="acordoParcelas" onchange="calcularAcordo()">
              <option value="1">1x (à vista)</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
              <option value="4">4x</option>
              <option value="5">5x</option>
              <option value="6" selected>6x</option>
              <option value="10">10x</option>
              <option value="12">12x</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Entrada (R$)</label>
          <div class="input-prefix">
            <span>R$</span>
            <input type="text" class="form-control" id="acordoEntrada" value="0,00" oninput="formatarMoeda(this);calcularAcordo()">
          </div>
        </div>
        <div class="form-group">
          <label>Primeiro Vencimento</label>
          <input type="date" class="form-control" id="acordoPrimeiroVenc">
        </div>
        <div style="padding:16px;background:var(--gold-glow);border:1px solid var(--gold);border-radius:8px;margin-top:16px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="color:var(--muted)">Valor com desconto:</span>
            <span style="font-weight:600" id="acordoValorFinal">R$ 0,00</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="color:var(--muted)">Entrada:</span>
            <span style="font-weight:600" id="acordoEntradaRes">R$ 0,00</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">
            <span style="font-weight:600">Parcelas:</span>
            <span style="font-weight:700;color:var(--gold);font-size:18px" id="acordoParcelasRes">6x de R$ 0,00</span>
          </div>
        </div>
        <input type="hidden" id="acordoClienteId">
        <input type="hidden" id="acordoCobrancasIds">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalAcordo')">Cancelar</button>
        <button class="btn btn-primary" onclick="criarAcordo()">
          <i class="fas fa-handshake"></i> Criar Acordo
        </button>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    let token = localStorage.getItem('token');
    if (!token) window.location.href = 'login.html';
    
    let cobrancas = [];
    let clientesAgrupados = {};
    let currentTab = 'todos';
    let selecionados = {}; // { clienteId: [cobrancaIds] }
    
    const H = () => ({ 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token });
    const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    const fmtMoney = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
    const parseMoney = s => parseFloat((s || '0').toString().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const initials = n => (n || '').split(' ').map(p => p[0]).slice(0, 2).join('').toUpperCase();
    const formatarMoeda = el => {
      let v = el.value.replace(/\D/g, '');
      v = (parseInt(v || 0) / 100).toFixed(2);
      el.value = parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    };
    const fecharModal = id => document.getElementById(id).classList.remove('show');
    
    // Calcular dias de vencimento
    function diasVencimento(dataVenc) {
      if (!dataVenc) return null;
      try {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        // Pegar só a parte da data (YYYY-MM-DD) e criar data sem timezone
        const dataStr = dataVenc.toString().split('T')[0];
        if (!dataStr || dataStr === 'null') return null;
        const partes = dataStr.split('-');
        if (partes.length !== 3) return null;
        const venc = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
        if (isNaN(venc.getTime())) return null;
        return Math.floor((venc - hoje) / (1000 * 60 * 60 * 24));
      } catch (e) { return null; }
    }
    
    function formatarData(data) {
      if (!data) return '-';
      try {
        // Pegar só a parte da data (YYYY-MM-DD)
        const dataStr = data.toString().split('T')[0];
        if (!dataStr || dataStr === 'null') return '-';
        const partes = dataStr.split('-');
        if (partes.length !== 3) return '-';
        // Retornar no formato DD/MM/YYYY sem conversão de timezone
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      } catch (e) { return '-'; }
    }
    
    // Carregar usuário
    async function carregarUsuario() {
      try {
        const r = await fetch(API + '/api/auth/me', { headers: H() });
        if (r.ok) {
          const d = await r.json();
          if (d.user) {
            document.getElementById('userName').textContent = d.user.nome;
            document.getElementById('userAvatar').textContent = initials(d.user.nome);
          }
        }
      } catch (e) {}
    }
    
    // Carregar estatísticas
    async function carregarEstatisticas() {
      try {
        const r = await fetch(API + '/api/cobrancas/stats', { headers: H() });
        const d = await r.json();
        if (d.success && d.data) {
          document.getElementById('statVencidas').textContent = d.data.vencidas || 0;
          document.getElementById('statTotal').textContent = fmtMoney(d.data.totalPendente);
          document.getElementById('statRecebido').textContent = fmtMoney(d.data.recebidoMes);
        }
      } catch (e) { console.error('Erro stats:', e); }
    }
    
    // Carregar cobranças
    async function carregarCobrancas() {
      try {
        const r = await fetch(API + '/api/cobrancas?limit=500', { headers: H() });
        const d = await r.json();
        if (d.success) {
          cobrancas = (d.data || []).filter(c => c.status !== 'pago' && c.status !== 'acordo');
          agruparPorCliente();
          renderizar();
        }
      } catch (e) {
        document.getElementById('listaClientes').innerHTML = '<div class="empty"><i class="fas fa-exclamation-circle"></i><h3>Erro ao carregar</h3></div>';
      }
    }
    
    // Agrupar cobranças por cliente
    function agruparPorCliente() {
      clientesAgrupados = {};
      
      cobrancas.forEach(c => {
        const clienteId = c.cliente_id || 'sem-cliente';
        if (!clientesAgrupados[clienteId]) {
          clientesAgrupados[clienteId] = {
            id: clienteId,
            nome: c.cliente_nome || 'Cliente não identificado',
            cpf: c.cliente_cpf || '',
            telefone: c.cliente_telefone || '',
            email: c.cliente_email || '',
            cobrancas: [],
            totalValor: 0,
            totalVencido: 0,
            qtdVencidas: 0
          };
        }
        
        const cliente = clientesAgrupados[clienteId];
        cliente.cobrancas.push(c);
        
        const valor = parseFloat(c.valor || c.valor_original || 0);
        cliente.totalValor += valor;
        
        const dias = diasVencimento(c.data_vencimento || c.vencimento);
        if (dias !== null && dias < 0) {
          cliente.totalVencido += valor;
          cliente.qtdVencidas++;
        }
      });
      
      // Atualizar estatísticas
      document.getElementById('statClientes').textContent = Object.keys(clientesAgrupados).length;
    }
    
    // Renderizar lista
    function renderizar() {
      const container = document.getElementById('listaClientes');
      const busca = document.getElementById('busca').value.toLowerCase();
      
      let clientes = Object.values(clientesAgrupados);
      
      // Filtrar por busca
      if (busca) {
        clientes = clientes.filter(c => 
          c.nome.toLowerCase().includes(busca) ||
          (c.cpf && c.cpf.includes(busca)) ||
          (c.telefone && c.telefone.includes(busca))
        );
      }
      
      // Filtrar por tab
      if (currentTab === 'vencidos') {
        clientes = clientes.filter(c => c.qtdVencidas > 0);
      } else if (currentTab === 'pendentes') {
        clientes = clientes.filter(c => c.qtdVencidas === 0);
      }
      
      // Ordenar por valor vencido (maior primeiro)
      clientes.sort((a, b) => b.totalVencido - a.totalVencido || b.totalValor - a.totalValor);
      
      if (clientes.length === 0) {
        container.innerHTML = `
          <div class="empty">
            <i class="fas fa-file-invoice-dollar"></i>
            <h3>Nenhuma cobrança encontrada</h3>
            <p>Clique em "Nova Cobrança" para começar</p>
          </div>`;
        return;
      }
      
      container.innerHTML = clientes.map(cliente => {
        const temVencidas = cliente.qtdVencidas > 0;
        
        return `
          <div class="cliente-card" id="card-${cliente.id}">
            <div class="cliente-header" onclick="toggleCliente('${cliente.id}')">
              <div class="cliente-avatar">${initials(cliente.nome)}</div>
              <div class="cliente-info">
                <div class="cliente-nome">
                  ${cliente.nome}
                  ${temVencidas ? `<span style="color:var(--red);font-size:12px;font-weight:500"><i class="fas fa-exclamation-circle"></i> ${cliente.qtdVencidas} vencida(s)</span>` : ''}
                </div>
                <div class="cliente-meta">
                  ${cliente.telefone ? `<span class="telefone" onclick="event.stopPropagation();abrirWhatsappCliente('${cliente.telefone}','${cliente.nome}')"><i class="fab fa-whatsapp"></i> ${cliente.telefone}</span>` : ''}
                  ${cliente.cpf ? `<span><i class="fas fa-id-card"></i> ${cliente.cpf}</span>` : ''}
                  <span><i class="fas fa-file-invoice"></i> ${cliente.cobrancas.length} cobrança(s)</span>
                </div>
              </div>
              <div class="cliente-resumo">
                ${temVencidas ? `
                  <div class="resumo-item">
                    <div class="resumo-label">Vencido</div>
                    <div class="resumo-valor vencido">${fmtMoney(cliente.totalVencido)}</div>
                  </div>
                ` : ''}
                <div class="resumo-item">
                  <div class="resumo-label">Total</div>
                  <div class="resumo-valor">${fmtMoney(cliente.totalValor)}</div>
                </div>
              </div>
              <div class="cliente-toggle">
                <i class="fas fa-chevron-down"></i>
              </div>
            </div>
            
            <div class="cobrancas-list">
              ${cliente.cobrancas.map(c => renderCobranca(c, cliente.id)).join('')}
              
              <div class="cliente-acoes">
                <div class="acoes-selecionadas">
                  <span class="selecionadas-texto" id="sel-texto-${cliente.id}">Selecione cobranças</span>
                  <button class="btn btn-sm btn-success" onclick="pagarSelecionadas('${cliente.id}')" id="btn-pagar-${cliente.id}" style="display:none">
                    <i class="fas fa-check"></i> Pagar Selecionadas
                  </button>
                  <button class="btn btn-sm btn-primary" onclick="abrirModalAcordoCliente('${cliente.id}')" id="btn-acordo-${cliente.id}" style="display:none">
                    <i class="fas fa-handshake"></i> Criar Acordo
                  </button>
                </div>
                <div class="acoes-rapidas">
                  <button class="btn btn-sm btn-secondary" onclick="selecionarTodas('${cliente.id}')">
                    <i class="fas fa-check-double"></i> Selecionar Todas
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="abrirWhatsappCliente('${cliente.telefone}','${cliente.nome}')">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                  </button>
                </div>
              </div>
            </div>
          </div>`;
      }).join('');
    }
    
    // Render cobrança individual
    function renderCobranca(c, clienteId) {
      const venc = c.data_vencimento || c.vencimento;
      const dias = diasVencimento(venc);
      const vencido = dias !== null && dias < 0;
      const hoje = dias === 0;
      
      let diasTexto = '', diasClass = 'futuro';
      if (dias !== null) {
        if (dias < 0) {
          diasTexto = `${Math.abs(dias)} dias atrás`;
          diasClass = 'vencido';
        } else if (dias === 0) {
          diasTexto = 'Vence hoje';
          diasClass = 'hoje';
        } else {
          diasTexto = `em ${dias} dias`;
          diasClass = 'futuro';
        }
      }
      
      const statusClass = vencido ? 'vencido' : 'pendente';
      const isSelected = selecionados[clienteId]?.includes(c.id);
      
      return `
        <div class="cobranca-item">
          <div class="cobranca-check ${isSelected ? 'checked' : ''}" onclick="toggleSelecionado('${clienteId}','${c.id}')"></div>
          <div class="cobranca-info">
            <div class="cobranca-descricao">${c.descricao || '-'}</div>
            <div class="cobranca-detalhe">${c.referencia ? `Ref: ${c.referencia}` : ''}</div>
          </div>
          <div class="cobranca-valor">
            <div class="cobranca-valor-num">${fmtMoney(c.valor || c.valor_original)}</div>
          </div>
          <div class="cobranca-vencimento">
            <div class="cobranca-data">${formatarData(venc)}</div>
            ${diasTexto ? `<div class="cobranca-dias ${diasClass}">${diasTexto}</div>` : ''}
          </div>
          <div class="cobranca-status">
            <span class="status-badge ${statusClass}">${statusClass}</span>
          </div>
          <div class="cobranca-acoes">
            <button class="btn btn-icon btn-success" onclick="abrirModalPagar('${c.id}','${(c.descricao || '').replace(/'/g, "\\'")}',${c.valor || c.valor_original},'${c.cliente_nome || ''}')" title="Pagar">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-icon btn-secondary" onclick="enviarWhatsapp('${c.id}')" title="WhatsApp">
              <i class="fab fa-whatsapp"></i>
            </button>
          </div>
        </div>`;
    }
    
    // Toggle expandir cliente
    function toggleCliente(clienteId) {
      const card = document.getElementById('card-' + clienteId);
      card.classList.toggle('expanded');
    }
    
    // Toggle selecionado
    function toggleSelecionado(clienteId, cobrancaId) {
      if (!selecionados[clienteId]) selecionados[clienteId] = [];
      
      const idx = selecionados[clienteId].indexOf(cobrancaId);
      if (idx > -1) {
        selecionados[clienteId].splice(idx, 1);
      } else {
        selecionados[clienteId].push(cobrancaId);
      }
      
      atualizarSelecao(clienteId);
    }
    
    // Selecionar todas
    function selecionarTodas(clienteId) {
      const cliente = clientesAgrupados[clienteId];
      if (!cliente) return;
      
      const todasIds = cliente.cobrancas.map(c => c.id);
      const todasSelecionadas = selecionados[clienteId]?.length === todasIds.length;
      
      if (todasSelecionadas) {
        selecionados[clienteId] = [];
      } else {
        selecionados[clienteId] = [...todasIds];
      }
      
      atualizarSelecao(clienteId);
    }
    
    // Atualizar UI de seleção
    function atualizarSelecao(clienteId) {
      const cliente = clientesAgrupados[clienteId];
      if (!cliente) return;
      
      const qtd = selecionados[clienteId]?.length || 0;
      const texto = document.getElementById('sel-texto-' + clienteId);
      const btnPagar = document.getElementById('btn-pagar-' + clienteId);
      const btnAcordo = document.getElementById('btn-acordo-' + clienteId);
      
      if (qtd > 0) {
        const valorTotal = cliente.cobrancas
          .filter(c => selecionados[clienteId].includes(c.id))
          .reduce((sum, c) => sum + parseFloat(c.valor || c.valor_original || 0), 0);
        
        texto.textContent = `${qtd} selecionada(s) · ${fmtMoney(valorTotal)}`;
        btnPagar.style.display = 'inline-flex';
        btnAcordo.style.display = 'inline-flex';
      } else {
        texto.textContent = 'Selecione cobranças';
        btnPagar.style.display = 'none';
        btnAcordo.style.display = 'none';
      }
      
      // Atualizar checkboxes visuais
      cliente.cobrancas.forEach(c => {
        const checks = document.querySelectorAll(`.cobranca-check`);
        checks.forEach(check => {
          const onclick = check.getAttribute('onclick');
          if (onclick && onclick.includes(c.id)) {
            if (selecionados[clienteId]?.includes(c.id)) {
              check.classList.add('checked');
            } else {
              check.classList.remove('checked');
            }
          }
        });
      });
      
      renderizar(); // Simples re-render
    }
    
    // Trocar tab
    function trocarTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="trocarTab('${tab}')"]`).classList.add('active');
      renderizar();
    }
    
    function filtrar() { renderizar(); }
    
    // WhatsApp do cliente
    function abrirWhatsappCliente(telefone, nome) {
      if (!telefone) { alert('Cliente sem telefone'); return; }
      
      let tel = telefone.replace(/\D/g, '');
      if (tel.length <= 11) tel = '55' + tel;
      
      const msg = `Olá ${nome}! Entramos em contato sobre suas pendências financeiras. Podemos conversar?`;
      window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
    }
    
    // Carregar credores para o select
    async function carregarCredores() {
      try {
        const r = await fetch(API + '/api/credores', { headers: H() });
        const d = await r.json();
        if (d.success && d.data) {
          const select = document.getElementById('novoCredor');
          select.innerHTML = '<option value="">Sem credor específico</option>';
          d.data.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
          });
        }
      } catch (e) { console.log('Sem credores'); }
    }
    
    // ========== NOVA COBRANÇA ==========
    function abrirModalNova() {
      document.getElementById('novoClienteId').value = '';
      document.getElementById('novoCliente').value = '';
      document.getElementById('novoCliente').style.display = 'block';
      document.getElementById('clienteSelecionado').style.display = 'none';
      document.getElementById('novoCredor').value = '';
      document.getElementById('novoDescricao').value = '';
      document.getElementById('novoCategoria').value = 'outros';
      document.getElementById('novoValor').value = '';
      document.getElementById('novoReferencia').value = '';
      document.getElementById('novoObs').value = '';
      
      const data = new Date();
      data.setDate(data.getDate() + 30);
      document.getElementById('novoVencimento').value = data.toISOString().split('T')[0];
      
      document.getElementById('modalNova').classList.add('show');
    }
    
    let buscaTimeout;
    async function buscarCliente(termo) {
      clearTimeout(buscaTimeout);
      const container = document.getElementById('resultadosCliente');
      
      if (termo.length < 2) { container.classList.remove('show'); return; }
      
      buscaTimeout = setTimeout(async () => {
        try {
          const r = await fetch(API + '/api/clientes?q=' + encodeURIComponent(termo), { headers: H() });
          const d = await r.json();
          
          if (d.success && d.data?.length > 0) {
            container.innerHTML = d.data.slice(0, 8).map(c => `
              <div class="cliente-search-item" onclick="selecionarCliente('${c.id}','${c.nome}','${c.cpf_cnpj || ''}')">
                <div style="font-weight:600">${c.nome}</div>
                <div style="font-size:11px;color:var(--muted)">${c.cpf_cnpj || '-'} ${c.telefone ? '· ' + c.telefone : ''}</div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted)">Nenhum cliente encontrado</div>';
          }
          container.classList.add('show');
        } catch (e) {}
      }, 300);
    }
    
    function selecionarCliente(id, nome, doc) {
      document.getElementById('novoClienteId').value = id;
      document.getElementById('selAvatar').textContent = initials(nome);
      document.getElementById('selNome').textContent = nome;
      document.getElementById('selDoc').textContent = doc || '-';
      document.getElementById('novoCliente').style.display = 'none';
      document.getElementById('clienteSelecionado').style.display = 'flex';
      document.getElementById('resultadosCliente').classList.remove('show');
    }
    
    function limparCliente() {
      document.getElementById('novoClienteId').value = '';
      document.getElementById('novoCliente').value = '';
      document.getElementById('novoCliente').style.display = 'block';
      document.getElementById('clienteSelecionado').style.display = 'none';
    }
    
    async function criarCobranca() {
      const clienteId = document.getElementById('novoClienteId').value;
      const credorId = document.getElementById('novoCredor').value;
      const descricao = document.getElementById('novoDescricao').value.trim();
      const categoria = document.getElementById('novoCategoria').value;
      const valor = parseMoney(document.getElementById('novoValor').value);
      const vencimento = document.getElementById('novoVencimento').value;
      const referencia = document.getElementById('novoReferencia').value.trim();
      const obs = document.getElementById('novoObs').value.trim();
      
      if (!clienteId) { alert('Selecione um cliente'); return; }
      if (!descricao) { alert('Informe a descrição'); return; }
      if (valor <= 0) { alert('Informe o valor'); return; }
      if (!vencimento) { alert('Informe o vencimento'); return; }
      
      try {
        const r = await fetch(API + '/api/cobrancas', {
          method: 'POST',
          headers: H(),
          body: JSON.stringify({ 
            cliente_id: clienteId, 
            credor_id: credorId || null,
            descricao, 
            categoria,
            valor, 
            vencimento, 
            referencia: referencia || null,
            observacoes: obs, 
            status: 'pendente' 
          })
        });
        
        const d = await r.json();
        if (d.success) {
          fecharModal('modalNova');
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Cobrança criada!');
        } else {
          alert(d.error || 'Erro ao criar cobrança');
        }
      } catch (e) { alert('Erro ao criar cobrança'); }
    }
    
    // ========== PAGAR ==========
    function abrirModalPagar(id, descricao, valor, clienteNome) {
      document.getElementById('pagarId').value = id;
      document.getElementById('pagarCliente').textContent = clienteNome || '-';
      document.getElementById('pagarDescricao').textContent = descricao || '-';
      document.getElementById('pagarValor').textContent = fmtMoney(valor);
      document.getElementById('pagarData').value = new Date().toISOString().split('T')[0];
      document.getElementById('modalPagar').classList.add('show');
    }
    
    async function confirmarPagamento() {
      const id = document.getElementById('pagarId').value;
      const data = document.getElementById('pagarData').value;
      const forma = document.getElementById('pagarForma').value;
      
      try {
        const r = await fetch(API + '/api/cobrancas/' + id + '/pagar', {
          method: 'PUT',
          headers: H(),
          body: JSON.stringify({ data_pagamento: data, forma_pagamento: forma })
        });
        
        const d = await r.json();
        if (d.success) {
          fecharModal('modalPagar');
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Pagamento registrado!');
        } else { alert(d.error || 'Erro'); }
      } catch (e) { alert('Erro ao registrar pagamento'); }
    }
    
    // Pagar selecionadas
    async function pagarSelecionadas(clienteId) {
      const ids = selecionados[clienteId] || [];
      if (ids.length === 0) return;
      
      if (!confirm(`Confirma pagamento de ${ids.length} cobrança(s)?`)) return;
      
      try {
        const r = await fetch(API + '/api/cobrancas/marcar-pagas', {
          method: 'POST',
          headers: H(),
          body: JSON.stringify({ ids })
        });
        
        const d = await r.json();
        if (d.success) {
          selecionados[clienteId] = [];
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Pagamentos registrados!');
        } else { alert(d.error || 'Erro'); }
      } catch (e) { alert('Erro'); }
    }
    
    // ========== ACORDO ==========
    let acordoValorOriginal = 0;
    
    function abrirModalAcordoCliente(clienteId) {
      const ids = selecionados[clienteId] || [];
      if (ids.length === 0) { alert('Selecione pelo menos uma cobrança'); return; }
      
      const cliente = clientesAgrupados[clienteId];
      const cobrancasSel = cliente.cobrancas.filter(c => ids.includes(c.id));
      
      acordoValorOriginal = cobrancasSel.reduce((sum, c) => sum + parseFloat(c.valor || c.valor_original || 0), 0);
      
      document.getElementById('acordoClienteId').value = clienteId;
      document.getElementById('acordoCobrancasIds').value = ids.join(',');
      document.getElementById('acordoValorOriginal').textContent = fmtMoney(acordoValorOriginal);
      document.getElementById('acordoQtd').textContent = `${ids.length} cobrança(s) selecionada(s)`;
      document.getElementById('acordoDesconto').value = 0;
      document.getElementById('acordoParcelas').value = '6';
      document.getElementById('acordoEntrada').value = '0,00';
      
      const data = new Date();
      data.setDate(data.getDate() + 7);
      document.getElementById('acordoPrimeiroVenc').value = data.toISOString().split('T')[0];
      
      calcularAcordo();
      document.getElementById('modalAcordo').classList.add('show');
    }
    
    function calcularAcordo() {
      const desconto = parseFloat(document.getElementById('acordoDesconto').value) || 0;
      const parcelas = parseInt(document.getElementById('acordoParcelas').value) || 1;
      const entrada = parseMoney(document.getElementById('acordoEntrada').value);
      
      const valorComDesconto = acordoValorOriginal * (1 - desconto / 100);
      const valorRestante = valorComDesconto - entrada;
      const valorParcela = parcelas > 0 ? valorRestante / parcelas : 0;
      
      document.getElementById('acordoValorFinal').textContent = fmtMoney(valorComDesconto);
      document.getElementById('acordoEntradaRes').textContent = fmtMoney(entrada);
      document.getElementById('acordoParcelasRes').textContent = `${parcelas}x de ${fmtMoney(valorParcela)}`;
    }
    
    async function criarAcordo() {
      const clienteId = document.getElementById('acordoClienteId').value;
      const cobrancasIds = document.getElementById('acordoCobrancasIds').value.split(',');
      const desconto = parseFloat(document.getElementById('acordoDesconto').value) || 0;
      const parcelas = parseInt(document.getElementById('acordoParcelas').value) || 1;
      const entrada = parseMoney(document.getElementById('acordoEntrada').value);
      const primeiroVenc = document.getElementById('acordoPrimeiroVenc').value;
      
      if (!primeiroVenc) { alert('Informe o primeiro vencimento'); return; }
      
      const valorAcordo = acordoValorOriginal * (1 - desconto / 100);
      
      try {
        // Criar acordo com a primeira cobrança
        const r = await fetch(API + '/api/acordos', {
          method: 'POST',
          headers: H(),
          body: JSON.stringify({
            cobranca_id: cobrancasIds[0],
            cliente_id: clienteId,
            valor_original: acordoValorOriginal,
            valor_acordo: valorAcordo,
            desconto_percentual: desconto,
            valor_entrada: entrada,
            numero_parcelas: parcelas,
            data_primeiro_vencimento: primeiroVenc
          })
        });
        
        const d = await r.json();
        if (d.success) {
          // Marcar demais cobranças como acordo
          if (cobrancasIds.length > 1) {
            for (let i = 1; i < cobrancasIds.length; i++) {
              await fetch(API + '/api/cobrancas/' + cobrancasIds[i] + '/status', {
                method: 'PUT',
                headers: H(),
                body: JSON.stringify({ status: 'acordo' })
              });
            }
          }
          
          fecharModal('modalAcordo');
          selecionados[clienteId] = [];
          carregarCobrancas();
          carregarEstatisticas();
          alert('✅ Acordo criado! Veja na tela de Acordos.');
        } else { alert(d.error || 'Erro ao criar acordo'); }
      } catch (e) { alert('Erro ao criar acordo'); }
    }
    
    // WhatsApp individual
    async function enviarWhatsapp(cobrancaId) {
      try {
        const r = await fetch(API + '/api/cobrancas/' + cobrancaId + '/whatsapp', { headers: H() });
        const d = await r.json();
        if (d.success && d.link) {
          window.open(d.link, '_blank');
        } else { alert(d.error || 'Erro ao gerar link'); }
      } catch (e) { alert('Erro'); }
    }
    
    // Inicializar
    carregarUsuario();
    carregarCredores();
    carregarEstatisticas();
    carregarCobrancas();
  </script>
</body>
</html>