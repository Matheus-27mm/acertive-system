<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ACERTIVE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Outfit:wght@200;300;400;500;600;700&family=Tabular+Nums:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-deep:#050709;--bg-surface:#0a0d12;--bg-card:#0e1219;--bg-card-hover:#121924;
            --bg-elevated:#151c28;--bg-input:#111620;
            --gold:#c9a84c;--gold-light:#dfc070;--gold-pale:#f0d98a;--gold-dim:#8b7434;
            --gold-glow:rgba(201,168,76,0.12);--gold-glow-s:rgba(201,168,76,0.06);
            --green:#3ecf8e;--green-bg:rgba(62,207,142,0.08);--green-border:rgba(62,207,142,0.2);
            --red:#e05c5c;--red-bg:rgba(224,92,92,0.08);--red-border:rgba(224,92,92,0.2);
            --orange:#e0943e;--orange-bg:rgba(224,148,62,0.08);--orange-border:rgba(224,148,62,0.2);
            --blue:#5c8ee0;--blue-bg:rgba(92,142,224,0.08);--blue-border:rgba(92,142,224,0.2);
            --text:#e8e6e1;--text-dim:#7a7670;--text-muted:#4a4640;
            --border:rgba(201,168,76,0.07);--border-h:rgba(201,168,76,0.14);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg-deep);color:var(--text);min-height:100vh;overflow-x:hidden}

        /* ─── Sidebar ─── */
        .sidebar{position:fixed;left:0;top:0;width:260px;height:100vh;background:var(--bg-surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100}
        .sidebar-header{padding:28px 24px;border-bottom:1px solid var(--border)}
        .sidebar-logo{display:flex;align-items:center;gap:14px}
        .sidebar-logo-icon{width:44px;height:44px;background:linear-gradient(145deg,var(--gold),var(--gold-dim));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--bg-deep);box-shadow:0 8px 24px rgba(201,168,76,0.15)}
        .sidebar-logo-text{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;letter-spacing:2px}
        .sidebar-logo-text span{color:var(--gold)}
        .sidebar-nav{flex:1;padding:24px 14px;overflow-y:auto}
        .nav-group{margin-bottom:28px}
        .nav-group-label{font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:2.5px;padding:0 14px;margin-bottom:10px}
        .nav-link{display:flex;align-items:center;gap:14px;padding:12px 16px;color:var(--text-dim);text-decoration:none;border-radius:9px;margin-bottom:2px;transition:all .25s;font-size:13px;font-weight:400;position:relative;border:1px solid transparent;letter-spacing:0.2px}
        .nav-link:hover{background:var(--gold-glow-s);color:var(--text);border-color:var(--border)}
        .nav-link.active{background:var(--gold-glow);color:var(--gold-light);border-color:var(--border-h)}
        .nav-link.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:2px;height:20px;background:var(--gold);border-radius:0 2px 2px 0}
        .nav-link i{width:18px;text-align:center;font-size:14px}
        .nav-badge{margin-left:auto;background:var(--red);color:white;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px}
        .sidebar-footer{padding:18px;border-top:1px solid var(--border)}
        .user-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px}
        .user-avatar{width:36px;height:36px;background:linear-gradient(145deg,var(--gold),var(--gold-dim));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:var(--bg-deep)}
        .user-info{flex:1}
        .user-name{font-size:13px;font-weight:500}
        .user-role{font-size:11px;color:var(--text-muted);font-weight:300}
        .user-logout{color:var(--text-muted);cursor:pointer;padding:6px;border-radius:6px;transition:all .2s;background:none;border:none;font-size:14px}
        .user-logout:hover{background:var(--red-bg);color:var(--red)}

        /* ─── Main ─── */
        .main{margin-left:260px;min-height:100vh;padding:36px 40px;position:relative}

        /* Ambient */
        .main::before{content:'';position:fixed;top:-200px;right:-200px;width:600px;height:600px;background:radial-gradient(circle,rgba(201,168,76,0.025)0%,transparent 70%);pointer-events:none}

        /* Header */
        .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:36px}
        .page-title{font-family:'Cormorant Garamond',serif;font-size:34px;font-weight:500;letter-spacing:0.5px}
        .page-date{font-size:12px;color:var(--text-muted);font-weight:300;letter-spacing:0.3px;margin-top:6px}
        .btn-work{display:flex;align-items:center;gap:10px;padding:12px 28px;background:linear-gradient(135deg,var(--gold),var(--gold-dim));border:none;border-radius:10px;color:var(--bg-deep);font-size:13px;font-weight:600;font-family:'Outfit',sans-serif;letter-spacing:1px;text-transform:uppercase;cursor:pointer;text-decoration:none;transition:all .4s cubic-bezier(.16,1,.3,1);box-shadow:0 8px 30px rgba(201,168,76,0.15)}
        .btn-work:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(201,168,76,0.25)}

        /* ─── Metric Cards ─── */
        .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-bottom:32px}
        .metric{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:26px;transition:all .3s;position:relative;overflow:hidden}
        .metric:hover{border-color:var(--border-h);transform:translateY(-2px)}
        .metric-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
        .metric-icon{width:44px;height:44px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .metric-icon.gold{background:var(--gold-glow);color:var(--gold);border:1px solid var(--border-h)}
        .metric-icon.green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
        .metric-icon.blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border)}
        .metric-icon.red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
        .metric-badge{font-size:11px;font-weight:500;padding:4px 10px;border-radius:8px;display:flex;align-items:center;gap:4px}
        .metric-badge.up{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
        .metric-badge.down{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
        .metric-badge.neutral{background:rgba(255,255,255,0.04);color:var(--text-dim);border:1px solid var(--border)}
        .metric-value{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:600;letter-spacing:-0.5px;margin-bottom:4px}
        .metric-value.gold-text{color:var(--gold-light)}
        .metric-value.green-text{color:var(--green)}
        .metric-label{font-size:12px;color:var(--text-muted);font-weight:300;letter-spacing:0.5px}
        .metric-bar{position:absolute;bottom:0;left:0;right:0;height:2px}
        .metric-bar-fill{height:100%;border-radius:0 0 14px 14px}
        .metric-bar-fill.gold-bar{background:linear-gradient(90deg,var(--gold-dim),var(--gold))}
        .metric-bar-fill.green-bar{background:linear-gradient(90deg,#2a8f5e,var(--green))}
        .metric-bar-fill.blue-bar{background:linear-gradient(90deg,#3a6bb5,var(--blue))}
        .metric-bar-fill.red-bar{background:linear-gradient(90deg,#a03c3c,var(--red))}

        /* ─── Grid Layout ─── */
        .grid-2{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-bottom:24px}
        .grid-2.equal{grid-template-columns:1fr 1fr}

        /* ─── Card ─── */
        .card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
        .card-header{display:flex;justify-content:space-between;align-items:center;padding:22px 26px;border-bottom:1px solid var(--border)}
        .card-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:500;display:flex;align-items:center;gap:10px;letter-spacing:0.3px}
        .card-title i{color:var(--gold);font-size:16px}
        .card-action{font-size:12px;color:var(--gold-dim);text-decoration:none;font-weight:400;display:flex;align-items:center;gap:6px;transition:color .3s;letter-spacing:0.2px}
        .card-action:hover{color:var(--gold)}
        .card-body{padding:22px 26px}

        /* ─── Aging ─── */
        .aging-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
        .aging-item{text-align:center;padding:20px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:10px;transition:all .3s}
        .aging-item:hover{border-color:var(--border-h)}
        .aging-label{font-size:10px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px}
        .aging-count{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:600;margin-bottom:4px}
        .aging-count.green{color:var(--green)}
        .aging-count.orange{color:var(--orange)}
        .aging-count.red{color:var(--red)}
        .aging-value{font-size:12px;color:var(--text-muted);font-weight:300}
        .aging-bar{width:100%;height:2px;margin-top:14px;border-radius:1px;overflow:hidden}
        .aging-bar div{height:100%;border-radius:1px}

        /* ─── Credor List ─── */
        .credor-item{display:flex;align-items:center;gap:14px;padding:16px 0;border-bottom:1px solid var(--border);transition:all .2s}
        .credor-item:last-child{border-bottom:none}
        .credor-item:hover{padding-left:4px}
        .credor-icon{width:38px;height:38px;background:var(--gold-glow);border:1px solid var(--border-h);border-radius:9px;display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:14px;flex-shrink:0}
        .credor-info{flex:1;min-width:0}
        .credor-name{font-size:13px;font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .credor-sub{font-size:11px;color:var(--text-muted);font-weight:300}
        .credor-valor{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--gold-light);text-align:right;flex-shrink:0}

        /* ─── Fila List ─── */
        .fila-item{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);transition:all .2s}
        .fila-item:last-child{border-bottom:none}
        .fila-item:hover{padding-left:4px}
        .fila-pos{width:32px;height:32px;background:var(--bg-elevated);border:1px solid var(--border-h);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--gold);flex-shrink:0}
        .fila-info{flex:1;min-width:0}
        .fila-name{font-size:13px;font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .fila-credor{font-size:11px;color:var(--text-muted);font-weight:300}
        .fila-right{text-align:right;flex-shrink:0}
        .fila-valor{font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:600;color:var(--gold-light);margin-bottom:2px}
        .fila-atraso{font-size:10px;color:var(--red);font-weight:500}

        /* ─── Produtividade ─── */
        .prod-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .prod-item{text-align:center;padding:22px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:10px}
        .prod-value{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:600;margin-bottom:4px}
        .prod-value.gold-text{color:var(--gold-light)}
        .prod-value.green-text{color:var(--green)}
        .prod-label{font-size:9px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px}

        /* ─── Atividade ─── */
        .activity-item{display:flex;align-items:flex-start;gap:14px;padding:14px 0;border-bottom:1px solid var(--border)}
        .activity-item:last-child{border-bottom:none}
        .activity-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
        .activity-dot.green{background:var(--green)}
        .activity-dot.gold{background:var(--gold)}
        .activity-dot.blue{background:var(--blue)}
        .activity-text{font-size:13px;font-weight:400;line-height:1.5}
        .activity-text strong{font-weight:500}
        .activity-time{font-size:11px;color:var(--text-muted);font-weight:300;margin-top:3px}

        /* ─── Empty ─── */
        .empty{text-align:center;padding:40px;color:var(--text-muted);font-size:13px;font-weight:300}
        .empty i{font-size:28px;margin-bottom:12px;display:block;opacity:.4}

        /* ─── Loading ─── */
        .loading-pulse{animation:pulse-dim 1.5s ease-in-out infinite}
        @keyframes pulse-dim{0%,100%{opacity:1}50%{opacity:.4}}

        /* ─── Scrollbar ─── */
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:var(--bg-surface)}
        ::-webkit-scrollbar-thumb{background:var(--border-h);border-radius:3px}

        /* ─── Animations ─── */
        .fade-in{animation:fadeIn .8s cubic-bezier(.16,1,.3,1) forwards;opacity:0}
        .fade-in.d1{animation-delay:.1s}.fade-in.d2{animation-delay:.2s}.fade-in.d3{animation-delay:.3s}.fade-in.d4{animation-delay:.4s}.fade-in.d5{animation-delay:.5s}.fade-in.d6{animation-delay:.6s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

        /* ─── Responsive ─── */
        @media(max-width:1200px){.metrics{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}.aging-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){.sidebar{transform:translateX(-100%)}.main{margin-left:0;padding:24px 20px}.metrics{grid-template-columns:1fr}.prod-grid{grid-template-columns:1fr 1fr 1fr}}
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon"><i class="fas fa-scale-balanced"></i></div>
                <div class="sidebar-logo-text">ACERT<span>IVE</span></div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-group">
                <div class="nav-group-label">Principal</div>
                <a href="dashboard.html" class="nav-link active"><i class="fas fa-th-large"></i> Dashboard</a>
                <a href="fila.html" class="nav-link"><i class="fas fa-headset"></i> Fila de Trabalho <span class="nav-badge" id="filaBadge">0</span></a>
            </div>
            <div class="nav-group">
                <div class="nav-group-label">Gestão</div>
                <a href="devedores.html" class="nav-link"><i class="fas fa-users"></i> Devedores</a>
                <a href="acordos.html" class="nav-link"><i class="fas fa-handshake"></i> Acordos</a>
                <a href="cobrancas.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a>
            </div>
            <div class="nav-group">
                <div class="nav-group-label">Cadastros</div>
                <a href="credores.html" class="nav-link"><i class="fas fa-building"></i> Credores</a>
            </div>
            <div class="nav-group">
                <div class="nav-group-label">Sistema</div>
                <a href="importacao.html" class="nav-link"><i class="fas fa-file-import"></i> Importação</a>
                <a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-info"><div class="user-name" id="userName">Usuário</div><div class="user-role" id="userRole">admin</div></div>
                <button class="user-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </aside>

    <main class="main">
        <header class="page-header fade-in">
            <div>
                <h1 class="page-title">Dashboard</h1>
                <p class="page-date" id="pageDate"></p>
            </div>
            <a href="fila.html" class="btn-work"><i class="fas fa-headset"></i> Iniciar Trabalho</a>
        </header>

        <!-- Metrics -->
        <div class="metrics">
            <div class="metric fade-in d1">
                <div class="metric-top">
                    <div class="metric-icon gold"><i class="fas fa-wallet"></i></div>
                    <div class="metric-badge neutral" id="badgeCarteira"><i class="fas fa-minus"></i> --</div>
                </div>
                <div class="metric-value gold-text" id="totalCarteira">R$ 0</div>
                <div class="metric-label">Total em Carteira</div>
                <div class="metric-bar"><div class="metric-bar-fill gold-bar" style="width:100%"></div></div>
            </div>
            <div class="metric fade-in d2">
                <div class="metric-top">
                    <div class="metric-icon green"><i class="fas fa-arrow-trend-up"></i></div>
                    <div class="metric-badge neutral" id="badgeRecuperado"><i class="fas fa-minus"></i> --</div>
                </div>
                <div class="metric-value green-text" id="totalRecuperado">R$ 0</div>
                <div class="metric-label">Recuperado no Mês</div>
                <div class="metric-bar"><div class="metric-bar-fill green-bar" id="barRecuperado" style="width:0%"></div></div>
            </div>
            <div class="metric fade-in d3">
                <div class="metric-top">
                    <div class="metric-icon blue"><i class="fas fa-handshake"></i></div>
                    <div class="metric-badge neutral" id="badgeAcordos"><i class="fas fa-minus"></i> --</div>
                </div>
                <div class="metric-value" id="totalAcordos">0</div>
                <div class="metric-label">Acordos Ativos</div>
                <div class="metric-bar"><div class="metric-bar-fill blue-bar" id="barAcordos" style="width:0%"></div></div>
            </div>
            <div class="metric fade-in d4">
                <div class="metric-top">
                    <div class="metric-icon red"><i class="fas fa-triangle-exclamation"></i></div>
                    <div class="metric-badge neutral" id="badgeTitulos"><i class="fas fa-minus"></i> --</div>
                </div>
                <div class="metric-value" id="totalTitulos">0</div>
                <div class="metric-label">Títulos Vencidos</div>
                <div class="metric-bar"><div class="metric-bar-fill red-bar" style="width:100%"></div></div>
            </div>
        </div>

        <!-- Aging + Por Credor -->
        <div class="grid-2 fade-in d4">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-clock"></i> Aging da Carteira</div>
                </div>
                <div class="card-body">
                    <div class="aging-grid">
                        <div class="aging-item">
                            <div class="aging-label">A Vencer</div>
                            <div class="aging-count green" id="agingVencer">0</div>
                            <div class="aging-value" id="agingVencerVal">R$ 0</div>
                            <div class="aging-bar"><div style="width:100%;background:var(--green);height:100%;border-radius:1px"></div></div>
                        </div>
                        <div class="aging-item">
                            <div class="aging-label">1–30 dias</div>
                            <div class="aging-count orange" id="aging30">0</div>
                            <div class="aging-value" id="aging30Val">R$ 0</div>
                            <div class="aging-bar"><div style="width:100%;background:var(--orange);height:100%;border-radius:1px"></div></div>
                        </div>
                        <div class="aging-item">
                            <div class="aging-label">31–60 dias</div>
                            <div class="aging-count orange" id="aging60">0</div>
                            <div class="aging-value" id="aging60Val">R$ 0</div>
                            <div class="aging-bar"><div style="width:100%;background:var(--orange);height:100%;border-radius:1px"></div></div>
                        </div>
                        <div class="aging-item">
                            <div class="aging-label">60+ dias</div>
                            <div class="aging-count red" id="aging60plus">0</div>
                            <div class="aging-value" id="aging60plusVal">R$ 0</div>
                            <div class="aging-bar"><div style="width:100%;background:var(--red);height:100%;border-radius:1px"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-building"></i> Por Credor</div>
                    <a href="credores.html" class="card-action">Ver todos <i class="fas fa-arrow-right"></i></a>
                </div>
                <div class="card-body" id="credoresLista">
                    <div class="empty"><i class="fas fa-spinner loading-pulse"></i>Carregando...</div>
                </div>
            </div>
        </div>

        <!-- Fila + Produtividade -->
        <div class="grid-2 fade-in d5">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-list-check"></i> Próximos na Fila</div>
                    <a href="fila.html" class="card-action">Ver fila completa <i class="fas fa-arrow-right"></i></a>
                </div>
                <div class="card-body" id="filaLista">
                    <div class="empty"><i class="fas fa-spinner loading-pulse"></i>Carregando...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-trophy"></i> Produtividade Hoje</div>
                </div>
                <div class="card-body">
                    <div class="prod-grid">
                        <div class="prod-item">
                            <div class="prod-value" id="prodAcionamentos">0</div>
                            <div class="prod-label">Acionamentos</div>
                        </div>
                        <div class="prod-item">
                            <div class="prod-value gold-text" id="prodAcordos">0</div>
                            <div class="prod-label">Acordos</div>
                        </div>
                        <div class="prod-item">
                            <div class="prod-value green-text" id="prodRecuperado">R$ 0</div>
                            <div class="prod-label">Recuperado</div>
                        </div>
                    </div>
                </div>
                <div class="card-header" style="border-top:1px solid var(--border);border-bottom:none">
                    <div class="card-title"><i class="fas fa-clock-rotate-left"></i> Atividade Recente</div>
                </div>
                <div class="card-body" id="atividadeLista" style="padding-top:0">
                    <div class="empty"><i class="fas fa-check-circle"></i>Nenhuma atividade hoje</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        var API = window.location.origin;
        function H(){return{'Authorization':'Bearer '+localStorage.getItem('token'),'Content-Type':'application/json'}}
        function fmtMoney(v){return(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
        function fmtNum(v){return(v||0).toLocaleString('pt-BR')}

        function logout(e){
            if(e)e.stopPropagation();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href='/login.html';
        }

        // Date
        (function(){
            var d=new Date();var dias=['Domingo','Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado'];
            var meses=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            document.getElementById('pageDate').textContent=dias[d.getDay()]+', '+d.getDate()+' de '+meses[d.getMonth()]+' de '+d.getFullYear();
        })();

        async function checkAuth(){
            var token=localStorage.getItem('token');
            if(!token){window.location.href='/login.html';return false}
            try{
                var r=await fetch(API+'/api/auth/me',{headers:H()});
                var d=await r.json();
                if(!d.success&&!d.user){localStorage.removeItem('token');window.location.href='/login.html';return false}
                var u=d.user||d;
                document.getElementById('userName').textContent=u.nome||'Usuário';
                document.getElementById('userRole').textContent=u.perfil||'admin';
                document.getElementById('userAvatar').textContent=(u.nome||'U').charAt(0).toUpperCase();
                return true;
            }catch(e){return true}
        }

        // ═══════════════════════════════════════
        // MÉTRICAS PRINCIPAIS (via /api/cobrancas/stats + /api/acordos/stats)
        // ═══════════════════════════════════════
        async function carregarMetricas(){
            try{
                // 1. Stats de cobranças
                var rCob=await fetch(API+'/api/cobrancas/stats',{headers:H()});
                if(rCob.ok){
                    var dCob=await rCob.json();
                    var s=dCob.data||dCob;
                    document.getElementById('totalCarteira').textContent=fmtMoney(s.totalPendente||s.total_pendente||0);
                    document.getElementById('totalRecuperado').textContent=fmtMoney(s.recebidoMes||s.recebido_mes||0);
                    document.getElementById('totalTitulos').textContent=fmtNum(s.vencidas||s.total_vencidas||0);
                    document.getElementById('prodRecuperado').textContent=fmtMoney(s.recebidoMes||s.recebido_mes||0);
                }
            }catch(e){
                console.log('Stats cobranças fallback...');
                // Fallback: usar fila stats
                try{
                    var rF=await fetch(API+'/api/acionamentos/fila/stats',{headers:H()});
                    var dF=await rF.json();
                    if(dF.data&&dF.data.valor_total){
                        document.getElementById('totalCarteira').textContent=fmtMoney(dF.data.valor_total);
                    }
                }catch(e2){}
            }

            try{
                // 2. Stats de acordos
                var rAc=await fetch(API+'/api/acordos/stats',{headers:H()});
                if(rAc.ok){
                    var dAc=await rAc.json();
                    var a=dAc.data||dAc;
                    document.getElementById('totalAcordos').textContent=fmtNum(a.acordosAtivos||a.acordos_ativos||0);
                }
            }catch(e){
                // Fallback: buscar lista de acordos
                try{
                    var rList=await fetch(API+'/api/acordos?limit=500',{headers:H()});
                    var dList=await rList.json();
                    var acordos=dList.data||[];
                    var ativos=acordos.filter(function(x){return x.status==='ativo'}).length;
                    document.getElementById('totalAcordos').textContent=fmtNum(ativos);
                }catch(e2){}
            }
        }

        // ═══════════════════════════════════════
        // AGING DA CARTEIRA
        // ═══════════════════════════════════════
        async function carregarAging(){
            try{
                var r=await fetch(API+'/api/cobrancas?limit=50000',{headers:H()});
                if(!r.ok)return;
                var d=await r.json();
                var cobs=(d.data||d||[]).filter(function(c){return c.status==='pendente'||c.status==='vencido'});
                
                var hoje=new Date();hoje.setHours(0,0,0,0);
                var aVencer={qtd:0,val:0};
                var d30={qtd:0,val:0};
                var d60={qtd:0,val:0};
                var d60plus={qtd:0,val:0};

                for(var i=0;i<cobs.length;i++){
                    var c=cobs[i];
                    var venc=new Date(c.data_vencimento);venc.setHours(0,0,0,0);
                    var diff=Math.floor((hoje-venc)/(1000*60*60*24));
                    var val=parseFloat(c.valor)||0;

                    if(diff<0){aVencer.qtd++;aVencer.val+=val}
                    else if(diff<=30){d30.qtd++;d30.val+=val}
                    else if(diff<=60){d60.qtd++;d60.val+=val}
                    else{d60plus.qtd++;d60plus.val+=val}
                }

                document.getElementById('agingVencer').textContent=fmtNum(aVencer.qtd);
                document.getElementById('agingVencerVal').textContent=fmtMoney(aVencer.val);
                document.getElementById('aging30').textContent=fmtNum(d30.qtd);
                document.getElementById('aging30Val').textContent=fmtMoney(d30.val);
                document.getElementById('aging60').textContent=fmtNum(d60.qtd);
                document.getElementById('aging60Val').textContent=fmtMoney(d60.val);
                document.getElementById('aging60plus').textContent=fmtNum(d60plus.qtd);
                document.getElementById('aging60plusVal').textContent=fmtMoney(d60plus.val);

                // Update total titulos vencidos (fallback)
                var totalV=d30.qtd+d60.qtd+d60plus.qtd;
                if(document.getElementById('totalTitulos').textContent==='0'){
                    document.getElementById('totalTitulos').textContent=fmtNum(totalV);
                }
                // Update fila badge
                document.getElementById('filaBadge').textContent=totalV>999?'999+':totalV;
            }catch(e){console.error('Aging erro:',e)}
        }

        // ═══════════════════════════════════════
        // CREDORES
        // ═══════════════════════════════════════
        async function carregarCredores(){
            try{
                var r=await fetch(API+'/api/credores',{headers:H()});
                var d=await r.json();
                var creds=d.data||d||[];
                var container=document.getElementById('credoresLista');

                if(creds.length===0){
                    container.innerHTML='<div class="empty"><i class="fas fa-building"></i>Nenhum credor cadastrado</div>';
                    return;
                }

                // Tentar usar total_cobrancas/valor_carteira direto da API
                var temDados=creds[0].total_cobrancas!==undefined||creds[0].valor_carteira!==undefined;

                if(temDados){
                    creds.sort(function(a,b){return(parseFloat(b.valor_carteira)||0)-(parseFloat(a.valor_carteira)||0)});
                    var html='';
                    for(var i=0;i<Math.min(creds.length,6);i++){
                        var cr=creds[i];
                        html+='<div class="credor-item"><div class="credor-icon"><i class="fas fa-building"></i></div><div class="credor-info"><div class="credor-name">'+cr.nome+'</div><div class="credor-sub">'+(cr.total_cobrancas||0)+' cobranças</div></div><div class="credor-valor">'+fmtMoney(cr.valor_carteira||0)+'</div></div>';
                    }
                    container.innerHTML=html;
                }else{
                    // Fallback: calcular manualmente
                    var rCob=await fetch(API+'/api/cobrancas?limit=50000',{headers:H()});
                    var dCob=await rCob.json();
                    var cobs=dCob.data||dCob||[];
                    var credorMap={};
                    for(var j=0;j<cobs.length;j++){
                        var c=cobs[j];
                        if(c.status==='pendente'||c.status==='vencido'){
                            var cid=c.credor_id;
                            if(!credorMap[cid])credorMap[cid]={count:0,valor:0};
                            credorMap[cid].count++;
                            credorMap[cid].valor+=parseFloat(c.valor)||0;
                        }
                    }
                    creds.sort(function(a,b){return((credorMap[b.id]||{}).valor||0)-((credorMap[a.id]||{}).valor||0)});
                    var html2='';
                    for(var k=0;k<Math.min(creds.length,6);k++){
                        var cr2=creds[k];
                        var info=credorMap[cr2.id]||{count:0,valor:0};
                        html2+='<div class="credor-item"><div class="credor-icon"><i class="fas fa-building"></i></div><div class="credor-info"><div class="credor-name">'+cr2.nome+'</div><div class="credor-sub">'+fmtNum(info.count)+' cobranças</div></div><div class="credor-valor">'+fmtMoney(info.valor)+'</div></div>';
                    }
                    container.innerHTML=html2;
                }
            }catch(e){
                document.getElementById('credoresLista').innerHTML='<div class="empty"><i class="fas fa-exclamation-triangle"></i>Erro ao carregar</div>';
            }
        }

        // ═══════════════════════════════════════
        // FILA PREVIEW (via /api/acionamentos/fila/devedores)
        // ═══════════════════════════════════════
        async function carregarFila(){
            try{
                var r=await fetch(API+'/api/acionamentos/fila/devedores?limit=5',{headers:H()});
                var d=await r.json();
                var devs=d.data||[];

                if(devs.length===0){
                    document.getElementById('filaLista').innerHTML='<div class="empty"><i class="fas fa-check-circle"></i>Fila vazia — parabéns!</div>';
                    return;
                }

                var html='';
                for(var i=0;i<devs.length;i++){
                    var dev=devs[i];
                    html+='<div class="fila-item" onclick="window.location.href=\'fila.html\'" style="cursor:pointer"><div class="fila-pos">'+(i+1)+'</div><div class="fila-info"><div class="fila-name">'+dev.nome+'</div><div class="fila-credor">'+(dev.credor_nome||'-')+'</div></div><div class="fila-right"><div class="fila-valor">'+fmtMoney(dev.valor_total)+'</div><div class="fila-atraso">'+(dev.maior_atraso||0)+' dias atraso</div></div></div>';
                }
                document.getElementById('filaLista').innerHTML=html;
            }catch(e){
                document.getElementById('filaLista').innerHTML='<div class="empty"><i class="fas fa-exclamation-triangle"></i>Erro ao carregar</div>';
            }
        }

        // ═══════════════════════════════════════
        // PRODUTIVIDADE
        // ═══════════════════════════════════════
        async function carregarProdutividade(){
            try{
                var r=await fetch(API+'/api/acionamentos/fila/stats',{headers:H()});
                if(r.ok){
                    var d=await r.json();
                    if(d.data){
                        document.getElementById('prodAcionamentos').textContent=d.data.acionamentos_hoje||0;
                        document.getElementById('prodAcordos').textContent=d.data.acordos_hoje||0;
                    }
                }
            }catch(e){console.log('Produtividade não disponível')}
        }

        // ═══════════════════════════════════════
        // ATIVIDADE RECENTE
        // ═══════════════════════════════════════
        async function carregarAtividade(){
            try{
                var r=await fetch(API+'/api/acionamentos/historico?limit=5',{headers:H()});
                var d=await r.json();
                var items=d.data||[];

                if(items.length===0){
                    document.getElementById('atividadeLista').innerHTML='<div class="empty"><i class="fas fa-clock-rotate-left"></i>Nenhuma atividade recente</div>';
                    return;
                }

                var html='';
                for(var i=0;i<Math.min(items.length,4);i++){
                    var item=items[i];
                    var color='gold';
                    if(item.acao&&item.acao.indexOf('ACORDO')!==-1)color='green';
                    if(item.acao&&item.acao.indexOf('STATUS')!==-1)color='blue';
                    html+='<div class="activity-item"><div class="activity-dot '+color+'"></div><div><div class="activity-text"><strong>'+(item.usuario_nome||'Sistema')+'</strong> '+formatAcao(item.acao)+'</div><div class="activity-time">'+timeAgo(item.created_at)+'</div></div></div>';
                }
                document.getElementById('atividadeLista').innerHTML=html;
            }catch(e){}
        }

        function timeAgo(date){
            if(!date)return'';
            var now=new Date();var d=new Date(date);
            var diff=Math.floor((now-d)/1000);
            if(diff<60)return'Agora';
            if(diff<3600)return Math.floor(diff/60)+'min atrás';
            if(diff<86400)return Math.floor(diff/3600)+'h atrás';
            return Math.floor(diff/86400)+'d atrás';
        }

        function formatAcao(acao){
            if(!acao)return'realizou uma ação';
            var map={'ACIONAMENTO_CRIADO':'registrou um acionamento','ACORDO_CRIADO':'criou um acordo','STATUS_ALTERADO':'alterou status do cliente','REGUA_EXECUTADA':'executou régua de cobrança','AGENDAMENTO_CRIADO':'criou um agendamento','AGENDAMENTO_CONCLUIDO':'concluiu agendamento','CLIENTE_IMPORTADO':'importou clientes','COBRANCA_IMPORTADA':'importou cobranças'};
            return map[acao]||acao.toLowerCase().replace(/_/g,' ');
        }

        // ═══════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════
        document.addEventListener('DOMContentLoaded',async function(){
            var auth=await checkAuth();
            if(!auth)return;
            // Carregar tudo em paralelo
            carregarMetricas();
            carregarAging();
            carregarCredores();
            carregarFila();
            carregarProdutividade();
            carregarAtividade();
        });
    </script>
</body>
</html>