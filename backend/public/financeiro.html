<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financeiro - ACERTIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #09090b;
      --card: rgba(17,17,21,0.95);
      --text: #fafafa;
      --muted: #71717a;
      --gold: #ca9b3c;
      --gold-glow: rgba(202,155,60,0.12);
      --border: rgba(255,255,255,0.08);
      --green: #22c55e;
      --green-bg: rgba(34,197,94,0.15);
      --red: #ef4444;
      --red-bg: rgba(239,68,68,0.15);
      --blue: #3b82f6;
      --blue-bg: rgba(59,130,246,0.15);
      --orange: #f59e0b;
      --orange-bg: rgba(245,158,11,0.15);
      --purple: #a855f7;
      --purple-bg: rgba(168,85,247,0.15);
      --sidebar: 240px;
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar);
      height: 100vh;
      background: var(--bg);
      border-right: 1px solid var(--border);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 24px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--gold);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
      color: var(--bg);
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
    }

    .logo-text span {
      color: var(--gold);
    }

    .sidebar-nav {
      flex: 1;
      padding: 8px 12px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 10px;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
      transition: all 0.15s;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(255,255,255,0.05);
    }

    .nav-link.active {
      color: var(--gold);
      background: var(--gold-glow);
    }

    .nav-link i {
      width: 20px;
      text-align: center;
    }

    .nav-divider {
      height: 1px;
      background: var(--border);
      margin: 16px 12px;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--gold-glow);
      border: 1px solid var(--gold);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--gold);
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 13px;
    }

    .user-role {
      font-size: 11px;
      color: var(--muted);
    }

    .btn-logout {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
    }

    .btn-logout:hover {
      background: var(--red-bg);
      color: var(--red);
    }

    /* MAIN */
    .main {
      margin-left: var(--sidebar);
      padding: 24px 32px;
      min-height: 100vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-title i {
      color: var(--gold);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* PERÍODO */
    .periodo-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 16px;
    }

    .periodo-box select {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .periodo-box select:focus {
      outline: none;
    }

    /* BUTTONS */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--gold);
      color: var(--bg);
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 12px;
    }

    /* MAIN TABS */
    .main-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 4px;
      border: 1px solid var(--border);
      overflow-x: auto;
    }

    .main-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      transition: all 0.15s;
    }

    .main-tab:hover {
      color: var(--gold);
    }

    .main-tab.active {
      background: var(--gold);
      color: var(--bg);
    }

    /* SECTIONS */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .stat-card.highlight {
      border-color: var(--gold);
      background: linear-gradient(135deg, var(--gold-glow), transparent);
    }

    .stat-card.success {
      border-color: var(--green);
      background: linear-gradient(135deg, var(--green-bg), transparent);
    }

    .stat-card.alert {
      border-color: var(--red);
      background: linear-gradient(135deg, var(--red-bg), transparent);
    }

    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-bottom: 12px;
    }

    .stat-icon.gold {
      background: var(--gold-glow);
      color: var(--gold);
    }

    .stat-icon.green {
      background: var(--green-bg);
      color: var(--green);
    }

    .stat-icon.red {
      background: var(--red-bg);
      color: var(--red);
    }

    .stat-icon.blue {
      background: var(--blue-bg);
      color: var(--blue);
    }

    .stat-icon.purple {
      background: var(--purple-bg);
      color: var(--purple);
    }

    .stat-icon.orange {
      background: var(--orange-bg);
      color: var(--orange);
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
    }

    /* CARD/TABLE */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: var(--gold);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: rgba(0,0,0,0.2);
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: rgba(255,255,255,0.02);
    }

    .credor-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .credor-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--blue-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--blue);
      font-size: 14px;
    }

    .credor-nome {
      font-weight: 600;
    }

    .credor-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .valor {
      font-weight: 700;
    }

    .valor.gold {
      color: var(--gold);
    }

    .valor.green {
      color: var(--green);
    }

    .valor.red {
      color: var(--red);
    }

    .comissao-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .comissao-valor {
      font-weight: 700;
      color: var(--green);
    }

    .comissao-percent {
      font-size: 11px;
      color: var(--muted);
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .meta-badge.atingida {
      background: var(--green-bg);
      color: var(--green);
    }

    .meta-badge.pendente {
      background: var(--orange-bg);
      color: var(--orange);
    }

    .meta-badge.sem {
      background: rgba(255,255,255,0.05);
      color: var(--muted);
    }

    .progress-bar {
      width: 100%;
      height: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
    }

    .progress-fill.green {
      background: var(--green);
    }

    .progress-fill.orange {
      background: var(--orange);
    }

    .progress-fill.red {
      background: var(--red);
    }

    .progress-text {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    .status-badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.pendente {
      background: var(--orange-bg);
      color: var(--orange);
    }

    .status-badge.pago {
      background: var(--green-bg);
      color: var(--green);
    }

    .btn-repassar {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .btn-repassar.pendente {
      background: var(--gold-glow);
      color: var(--gold);
      border: 1px solid rgba(202,155,60,0.3);
    }

    .btn-repassar.pendente:hover {
      background: var(--gold);
      color: var(--bg);
    }

    .btn-repassar.ok {
      background: var(--green-bg);
      color: var(--green);
      cursor: default;
    }

    .empty {
      text-align: center;
      padding: 50px 20px;
      color: var(--muted);
    }

    .empty i {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .loading {
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* CHARTS */
    .charts-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .chart-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-title i {
      color: var(--gold);
    }

    .chart-container {
      position: relative;
      height: 280px;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-header h3 i {
      color: var(--gold);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
    }

    .modal-close:hover {
      color: var(--red);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .resumo-box {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .resumo-box h4 {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .resumo-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed var(--border);
    }

    .resumo-item:last-child {
      border-bottom: none;
      padding-top: 12px;
      margin-top: 4px;
      border-top: 1px solid var(--border);
    }

    .resumo-item span:first-child {
      color: var(--muted);
      font-size: 13px;
    }

    .resumo-item span:last-child {
      font-weight: 600;
    }

    .resumo-item.destaque span:last-child {
      color: var(--gold);
      font-size: 18px;
    }

    .dados-banco {
      background: var(--blue-bg);
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 20px;
    }

    .dados-banco h4 {
      font-size: 12px;
      color: var(--blue);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dados-banco p {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 4px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--gold);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .filters-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 10px 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .main {
        margin-left: 0;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">A</div>
      <div class="logo-text">ACERT<span>IVE</span></div>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
      <a href="cobrancas.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a>
      <a href="acordos.html" class="nav-link"><i class="fas fa-handshake"></i> Acordos</a>
      <a href="financeiro.html" class="nav-link active"><i class="fas fa-wallet"></i> Financeiro</a>
      <div class="nav-divider"></div>
      <a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-info">
          <div class="user-name" id="userName">Usuário</div>
          <div class="user-role" id="userRole">-</div>
        </div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- HEADER -->
    <div class="page-header">
      <h1 class="page-title"><i class="fas fa-wallet"></i> Financeiro</h1>
      <div class="header-actions">
        <div class="periodo-box">
          <i class="fas fa-calendar-alt" style="color:var(--muted)"></i>
          <select id="selectMes"></select>
          <select id="selectAno"></select>
          <button class="btn btn-sm btn-primary" onclick="carregar()" style="margin-left:8px">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <button class="btn btn-secondary" onclick="exportar()">
          <i class="fas fa-download"></i> Exportar
        </button>
      </div>
    </div>

    <!-- MAIN TABS -->
    <div class="main-tabs">
      <button class="main-tab active" onclick="switchTab('resumo')">
        <i class="fas fa-building"></i> Por Credor
      </button>
      <button class="main-tab" onclick="switchTab('comissoes')">
        <i class="fas fa-coins"></i> Comissões
      </button>
      <button class="main-tab" onclick="switchTab('repasses')">
        <i class="fas fa-paper-plane"></i> Repasses
      </button>
      <button class="main-tab" onclick="switchTab('relatorios')">
        <i class="fas fa-chart-bar"></i> Relatórios
      </button>
    </div>

    <!-- SECTION: RESUMO POR CREDOR -->
    <div class="section active" id="sectionResumo">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue"><i class="fas fa-hand-holding-dollar"></i></div>
          <div class="stat-label">Total Recuperado</div>
          <div class="stat-value" id="statRecuperado">R$ 0</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-icon gold"><i class="fas fa-coins"></i></div>
          <div class="stat-label">Sua Comissão</div>
          <div class="stat-value" id="statComissao">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple"><i class="fas fa-paper-plane"></i></div>
          <div class="stat-label">A Repassar</div>
          <div class="stat-value" id="statRepassar">R$ 0</div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
          <div class="stat-label">Já Repassado</div>
          <div class="stat-value" id="statRepassado">R$ 0</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-building"></i> Resumo por Credor</h2>
        </div>
        <table>
          <thead>
            <tr>
              <th>Credor</th>
              <th>Recuperado</th>
              <th>Meta</th>
              <th>Comissão</th>
              <th>A Repassar</th>
              <th>Status</th>
              <th style="width:120px">Ação</th>
            </tr>
          </thead>
          <tbody id="tbodyCredores">
            <tr>
              <td colspan="7">
                <div class="loading"><div class="spinner"></div></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-history"></i> Histórico de Repasses</h2>
        </div>
        <table>
          <thead>
            <tr>
              <th>Credor</th>
              <th>Valor</th>
              <th>Forma</th>
              <th>Data</th>
              <th>Comprovante</th>
            </tr>
          </thead>
          <tbody id="tbodyHistorico">
            <tr>
              <td colspan="5">
                <div class="empty">
                  <i class="fas fa-inbox"></i>
                  <p>Nenhum repasse</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECTION: COMISSÕES -->
    <div class="section" id="sectionComissoes">
      <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr)">
        <div class="stat-card highlight">
          <div class="stat-icon gold"><i class="fas fa-coins"></i></div>
          <div class="stat-label">Total Comissões</div>
          <div class="stat-value" id="statComTotal">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
          <div class="stat-label">Pagas</div>
          <div class="stat-value" id="statComPagas">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
          <div class="stat-label">Pendentes</div>
          <div class="stat-value" id="statComPendentes">R$ 0</div>
        </div>
      </div>

      <div class="filters-row">
        <select class="filter-select" id="filterComCredor" onchange="filtrarComissoes()">
          <option value="">Todos Credores</option>
        </select>
        <select class="filter-select" id="filterComStatus" onchange="filtrarComissoes()">
          <option value="">Todos Status</option>
          <option value="pendente">Pendente</option>
          <option value="pago">Pago</option>
        </select>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-coins"></i> Lista de Comissões</h2>
          <span id="comissoesCount" style="color:var(--muted);font-size:13px">0</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Credor</th>
              <th>Acordo</th>
              <th>Valor Base</th>
              <th>Taxa</th>
              <th>Comissão</th>
              <th>Status</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody id="tbodyComissoes">
            <tr>
              <td colspan="7">
                <div class="loading"><div class="spinner"></div></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECTION: REPASSES -->
    <div class="section" id="sectionRepasses">
      <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr)">
        <div class="stat-card alert">
          <div class="stat-icon red"><i class="fas fa-exclamation-circle"></i></div>
          <div class="stat-label">Pendente</div>
          <div class="stat-value" id="statRepPendente">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
          <div class="stat-label">Repassado (Mês)</div>
          <div class="stat-value" id="statRepRepassado">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue"><i class="fas fa-building"></i></div>
          <div class="stat-label">Credores c/ Saldo</div>
          <div class="stat-value" id="statRepCredores">0</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-list"></i> Pendentes por Credor</h2>
          <button class="btn btn-sm btn-primary" onclick="abrirNovoRepasse()">
            <i class="fas fa-plus"></i> Novo
          </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Credor</th>
              <th>Recuperado</th>
              <th>Comissão</th>
              <th>A Repassar</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyRepassesPend">
            <tr>
              <td colspan="5">
                <div class="loading"><div class="spinner"></div></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title" style="color:var(--muted)">
            <i class="fas fa-history" style="color:var(--muted)"></i> Histórico
          </h2>
        </div>
        <table>
          <thead>
            <tr>
              <th>Credor</th>
              <th>Valor</th>
              <th>Forma</th>
              <th>Data</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodyRepassesHist">
            <tr>
              <td colspan="5">
                <div class="empty" style="padding:30px">
                  <i class="fas fa-inbox"></i>
                  <p>Nenhum</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECTION: RELATÓRIOS -->
    <div class="section" id="sectionRelatorios">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon red"><i class="fas fa-exclamation-circle"></i></div>
          <div class="stat-label">Inadimplentes</div>
          <div class="stat-value" id="statRelInadimplentes">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange"><i class="fas fa-money-bill-wave"></i></div>
          <div class="stat-label">Valor em Atraso</div>
          <div class="stat-value" id="statRelValorAtraso">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
          <div class="stat-label">Recebido (Mês)</div>
          <div class="stat-value" id="statRelRecebido">R$ 0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple"><i class="fas fa-percent"></i></div>
          <div class="stat-label">Taxa Conversão</div>
          <div class="stat-value" id="statRelConversao">0%</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title"><i class="fas fa-chart-line"></i> Evolução Mensal</div>
          <div class="chart-container">
            <canvas id="chartEvolucao"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title"><i class="fas fa-chart-pie"></i> Por Status</div>
          <div class="chart-container">
            <canvas id="chartStatus"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-ranking-star"></i> Top Devedores</h2>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Devedor</th>
              <th>Cobranças</th>
              <th>Valor</th>
              <th>Atraso</th>
              <th>Situação</th>
            </tr>
          </thead>
          <tbody id="tbodyDevedores">
            <tr>
              <td colspan="6">
                <div class="loading"><div class="spinner"></div></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODAL REPASSE -->
  <div class="modal-overlay" id="modalRepasse">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-paper-plane"></i> Registrar Repasse</h3>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="resumo-box">
          <h4><i class="fas fa-calculator"></i> Resumo</h4>
          <div class="resumo-item">
            <span>Valor Recuperado</span>
            <span id="modalRecuperado">R$ 0</span>
          </div>
          <div class="resumo-item">
            <span>Comissão (<span id="modalPercent">0</span>%)</span>
            <span id="modalComissao">- R$ 0</span>
          </div>
          <div class="resumo-item">
            <span>Já Repassado</span>
            <span id="modalJaRepassado">- R$ 0</span>
          </div>
          <div class="resumo-item destaque">
            <span>Saldo a Repassar</span>
            <span id="modalSaldo">R$ 0</span>
          </div>
        </div>

        <div class="dados-banco" id="dadosBanco" style="display:none">
          <h4><i class="fas fa-university"></i> Dados Bancários</h4>
          <div id="dadosBancoContent"></div>
        </div>

        <input type="hidden" id="repasseCredorId">

        <div class="form-group">
          <label>Credor</label>
          <select class="form-control" id="repasseCredorSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Valor *</label>
            <input type="text" class="form-control" id="repasseValor" placeholder="0,00" oninput="formatarMoeda(this)">
          </div>
          <div class="form-group">
            <label>Data *</label>
            <input type="date" class="form-control" id="repasseData">
          </div>
        </div>

        <div class="form-group">
          <label>Forma de Pagamento</label>
          <select class="form-control" id="repasseForma">
            <option value="pix">PIX</option>
            <option value="transferencia">Transferência</option>
            <option value="boleto">Boleto</option>
            <option value="dinheiro">Dinheiro</option>
          </select>
        </div>

        <div class="form-group">
          <label>Comprovante</label>
          <input type="text" class="form-control" id="repasseObs" placeholder="Nº do comprovante...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="salvarRepasse()">
          <i class="fas fa-check"></i> Confirmar
        </button>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // CONFIGURAÇÃO E VARIÁVEIS GLOBAIS
    // =============================================
    const API = window.location.origin;
    let token = localStorage.getItem('token');
    if (!token) window.location.href = 'login.html';

    let currentTab = 'resumo';
    let credoresData = [];
    let comissoes = [];
    let chartEvolucao, chartStatus;

    // =============================================
    // FUNÇÕES UTILITÁRIAS
    // =============================================
    const H = () => ({
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    });

    const logout = () => {
      localStorage.clear();
      window.location.href = 'login.html';
    };

    const fmtMoney = v => new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(v || 0);

    const parseMoney = s => s ? parseFloat(s.replace(/[^\d,]/g, '').replace(',', '.')) || 0 : 0;

    const fmtDate = d => d ? new Date(d).toLocaleDateString('pt-BR') : '—';

    const initials = n => {
      if (!n) return '?';
      const parts = n.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return n.substring(0, 2).toUpperCase();
    };

    const toast = m => alert(m);

    const fecharModal = () => document.getElementById('modalRepasse').classList.remove('show');

    function formatarMoeda(input) {
      let value = input.value.replace(/\D/g, '');
      value = (parseInt(value || 0) / 100).toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      input.value = value;
    }

    // =============================================
    // INICIALIZAÇÃO
    // =============================================
    function initPeriodo() {
      const selMes = document.getElementById('selectMes');
      const selAno = document.getElementById('selectAno');
      const meses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      const hoje = new Date();
      const mesAtual = hoje.getMonth() + 1;
      const anoAtual = hoje.getFullYear();

      meses.forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = i + 1;
        opt.textContent = m;
        if (i + 1 === mesAtual) opt.selected = true;
        selMes.appendChild(opt);
      });

      for (let a = anoAtual; a >= anoAtual - 3; a--) {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        selAno.appendChild(opt);
      }

      document.getElementById('repasseData').value = hoje.toISOString().split('T')[0];
    }

    // =============================================
    // NAVEGAÇÃO POR ABAS
    // =============================================
    function switchTab(tab) {
      currentTab = tab;

      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      event.currentTarget.classList.add('active');

      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

      const sectionMap = {
        resumo: 'sectionResumo',
        comissoes: 'sectionComissoes',
        repasses: 'sectionRepasses',
        relatorios: 'sectionRelatorios'
      };

      document.getElementById(sectionMap[tab]).classList.add('active');

      // Carregar dados da aba
      if (tab === 'comissoes') carregarComissoes();
      else if (tab === 'repasses') carregarRepasses();
      else if (tab === 'relatorios') carregarRelatorios();
    }

    // =============================================
    // CARREGAR USUÁRIO
    // =============================================
    async function carregarUsuario() {
      try {
        const u = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = u.nome || 'Usuário';
        document.getElementById('userRole').textContent = u.nivel === 'admin' ? 'Admin' : 'Operador';
        document.getElementById('userAvatar').textContent = initials(u.nome || 'U');
      } catch (e) {
        console.error('Erro ao carregar usuário:', e);
      }
    }

    // =============================================
    // CARREGAR DADOS PRINCIPAIS (RESUMO)
    // =============================================
    async function carregar() {
      const mes = document.getElementById('selectMes').value;
      const ano = document.getElementById('selectAno').value;

      try {
        // Carregar resumo por credores
        const r = await fetch(API + `/api/financeiro/resumo-credores?mes=${mes}&ano=${ano}`, { headers: H() });
        const d = await r.json();

        if (d.success && d.data) {
          credoresData = d.data.credores || [];
          const t = d.data.totais || {};

          document.getElementById('statRecuperado').textContent = fmtMoney(t.recuperado);
          document.getElementById('statComissao').textContent = fmtMoney(t.comissao);
          document.getElementById('statRepassar').textContent = fmtMoney(t.aRepassar);
          document.getElementById('statRepassado').textContent = fmtMoney(t.jaRepassado);

          renderCredores(credoresData);
        } else {
          renderCredores([]);
        }

        // Carregar histórico de repasses
        const rh = await fetch(API + `/api/financeiro/repasses?mes=${mes}&ano=${ano}`, { headers: H() });
        const dh = await rh.json();
        if (dh.success) renderHistorico(dh.data || []);

        // Carregar dropdown de credores
        carregarCredoresDropdown();

      } catch (e) {
        console.error('Erro ao carregar:', e);
        renderCredores([]);
      }
    }

    // =============================================
    // RENDERIZAR TABELA DE CREDORES
    // =============================================
    function renderCredores(dados) {
      const tbody = document.getElementById('tbodyCredores');

      if (!dados || !dados.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty">
                <i class="fas fa-inbox"></i>
                <p>Nenhum dado</p>
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = dados.map(c => {
        const temMeta = c.comissao_meta && parseFloat(c.comissao_meta) > 0;
        const recuperado = parseFloat(c.valor_recuperado) || 0;
        const meta = parseFloat(c.comissao_meta) || 0;
        const atingiuMeta = temMeta && recuperado >= meta;
        const progresso = temMeta ? Math.min((recuperado / meta) * 100, 100) : 0;
        const corProg = progresso >= 100 ? 'green' : progresso >= 70 ? 'orange' : 'red';

        const comBase = parseFloat(c.comissao_percentual) || 0;
        const bonus = atingiuMeta ? (parseFloat(c.comissao_bonus) || 0) : 0;
        const comTotal = comBase + bonus;
        const valorCom = parseFloat(c.valor_comissao) || 0;
        const aRepassar = parseFloat(c.valor_a_repassar) || 0;

        let metaBadge = temMeta
          ? (atingiuMeta
            ? `<span class="meta-badge atingida"><i class="fas fa-trophy"></i> Atingida!</span>`
            : `<span class="meta-badge pendente"><i class="fas fa-bullseye"></i> ${progresso.toFixed(0)}%</span>`)
          : `<span class="meta-badge sem">Sem meta</span>`;

        const status = aRepassar <= 0
          ? `<span style="color:var(--green)"><i class="fas fa-check-circle"></i> Em dia</span>`
          : `<span style="color:var(--orange)"><i class="fas fa-clock"></i> Pendente</span>`;

        const btnAcao = aRepassar > 0
          ? `<button class="btn-repassar pendente" onclick="abrirModal('${c.id}')"><i class="fas fa-paper-plane"></i> Repassar</button>`
          : `<button class="btn-repassar ok" disabled><i class="fas fa-check"></i> OK</button>`;

        return `
          <tr>
            <td>
              <div class="credor-info">
                <div class="credor-avatar">${initials(c.nome)}</div>
                <div>
                  <div class="credor-nome">${c.nome}</div>
                  <div class="credor-meta">${c.cnpj || ''}</div>
                </div>
              </div>
            </td>
            <td><span class="valor">${fmtMoney(recuperado)}</span></td>
            <td>
              ${metaBadge}
              ${temMeta ? `
                <div class="progress-bar">
                  <div class="progress-fill ${corProg}" style="width:${progresso}%"></div>
                </div>
                <div class="progress-text">${fmtMoney(recuperado)} / ${fmtMoney(meta)}</div>
              ` : ''}
            </td>
            <td>
              <div class="comissao-info">
                <span class="comissao-valor">${fmtMoney(valorCom)}</span>
                <span class="comissao-percent">${comTotal}%${bonus > 0 ? ` (${comBase}+${bonus}%)` : ''}</span>
              </div>
            </td>
            <td><span class="valor gold">${fmtMoney(aRepassar)}</span></td>
            <td>${status}</td>
            <td>${btnAcao}</td>
          </tr>`;
      }).join('');
    }

    // =============================================
    // RENDERIZAR HISTÓRICO DE REPASSES
    // =============================================
    function renderHistorico(dados) {
      const tbody = document.getElementById('tbodyHistorico');

      if (!dados || !dados.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty" style="padding:30px">
                <i class="fas fa-inbox"></i>
                <p>Nenhum repasse</p>
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = dados.map(r => `
        <tr>
          <td>
            <div class="credor-info">
              <div class="credor-avatar" style="width:32px;height:32px;font-size:12px">${initials(r.credor_nome)}</div>
              <span style="font-weight:600">${r.credor_nome || 'Credor'}</span>
            </div>
          </td>
          <td><span class="valor green">${fmtMoney(r.valor_repasse || r.valor)}</span></td>
          <td>${(r.forma_pagamento || 'PIX').toUpperCase()}</td>
          <td>${fmtDate(r.data_repasse)}</td>
          <td>${r.comprovante || '—'}</td>
        </tr>`).join('');
    }

    // =============================================
    // CARREGAR DROPDOWN DE CREDORES
    // =============================================
    async function carregarCredoresDropdown() {
      try {
        const r = await fetch(API + '/api/credores', { headers: H() });
        const d = await r.json();
        const credores = d.success ? d.data : (Array.isArray(d) ? d : []);

        const sel = document.getElementById('repasseCredorSelect');
        const selCom = document.getElementById('filterComCredor');

        sel.innerHTML = '<option value="">Selecione...</option>';
        selCom.innerHTML = '<option value="">Todos Credores</option>';

        credores.forEach(c => {
          sel.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
          selCom.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        });
      } catch (e) {
        console.error('Erro ao carregar credores:', e);
      }
    }

    // =============================================
    // COMISSÕES
    // =============================================
    async function carregarComissoes() {
      const mes = document.getElementById('selectMes').value;
      const ano = document.getElementById('selectAno').value;

      try {
        const r = await fetch(API + `/api/financeiro/comissoes?mes=${mes}&ano=${ano}`, { headers: H() });
        const d = await r.json();
        comissoes = d.success ? (d.data || []) : [];

        let total = 0, pagas = 0, pendentes = 0;
        comissoes.forEach(c => {
          total += parseFloat(c.valor_comissao || 0);
          if (c.status === 'pago') pagas += parseFloat(c.valor_comissao || 0);
          else pendentes += parseFloat(c.valor_comissao || 0);
        });

        document.getElementById('statComTotal').textContent = fmtMoney(total);
        document.getElementById('statComPagas').textContent = fmtMoney(pagas);
        document.getElementById('statComPendentes').textContent = fmtMoney(pendentes);

        renderComissoes(comissoes);
      } catch (e) {
        console.error('Erro ao carregar comissões:', e);
        renderComissoes([]);
      }
    }

    function filtrarComissoes() {
      const credor = document.getElementById('filterComCredor').value;
      const status = document.getElementById('filterComStatus').value;

      let filtradas = comissoes;
      if (credor) filtradas = filtradas.filter(c => c.credor_id == credor);
      if (status) filtradas = filtradas.filter(c => c.status === status);

      renderComissoes(filtradas);
    }

    function renderComissoes(dados) {
      const tbody = document.getElementById('tbodyComissoes');
      document.getElementById('comissoesCount').textContent = dados.length + ' comissões';

      if (!dados || !dados.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty">
                <i class="fas fa-coins"></i>
                <p>Nenhuma comissão</p>
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = dados.map(c => `
        <tr>
          <td>
            <div class="credor-info">
              <div class="credor-avatar">${initials(c.credor_nome || 'CR')}</div>
              <div>
                <div class="credor-nome">${c.credor_nome || 'Credor'}</div>
                <div class="credor-meta">${c.percentual || 0}%</div>
              </div>
            </div>
          </td>
          <td>${c.acordo_id ? String(c.acordo_id).substring(0, 8) : '—'}</td>
          <td>${fmtMoney(c.valor_base)}</td>
          <td>${c.percentual || 0}%</td>
          <td class="valor gold">${fmtMoney(c.valor_comissao)}</td>
          <td><span class="status-badge ${c.status}">${c.status === 'pago' ? 'Pago' : 'Pendente'}</span></td>
          <td>${fmtDate(c.created_at)}</td>
        </tr>`).join('');
    }

    // =============================================
    // REPASSES
    // =============================================
    async function carregarRepasses() {
      try {
        // Carregar pendentes
        const r = await fetch(API + '/api/financeiro/repasses/calcular', { headers: H() });
        const d = await r.json();

        if (d.success && d.data) {
          let totalPend = 0;
          d.data.forEach(x => totalPend += parseFloat(x.valor_repassar || 0));

          document.getElementById('statRepPendente').textContent = fmtMoney(totalPend);
          document.getElementById('statRepCredores').textContent = d.data.length;

          renderRepassesPendentes(d.data);
        } else {
          renderRepassesPendentes([]);
        }

        // Carregar histórico
        const rh = await fetch(API + '/api/financeiro/repasses', { headers: H() });
        const dh = await rh.json();

        if (dh.success && dh.data) {
          let repassado = 0;
          dh.data.forEach(x => {
            if (x.status === 'pago') repassado += parseFloat(x.valor || 0);
          });

          document.getElementById('statRepRepassado').textContent = fmtMoney(repassado);
          renderRepassesHist(dh.data);
        }
      } catch (e) {
        console.error('Erro ao carregar repasses:', e);
        renderRepassesPendentes([]);
      }
    }

    function renderRepassesPendentes(dados) {
      const tbody = document.getElementById('tbodyRepassesPend');

      if (!dados || !dados.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty">
                <i class="fas fa-check-circle" style="color:var(--green)"></i>
                <p style="color:var(--green)">Nenhum pendente!</p>
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = dados.map(d => `
        <tr>
          <td>
            <div class="credor-info">
              <div class="credor-avatar">${initials(d.credor_nome)}</div>
              <div>
                <div class="credor-nome">${d.credor_nome || 'Credor'}</div>
              </div>
            </div>
          </td>
          <td>${fmtMoney(d.valor_recuperado)}</td>
          <td class="valor green">- ${fmtMoney(d.valor_comissao)}</td>
          <td class="valor gold">${fmtMoney(d.valor_repassar)}</td>
          <td>
            <button class="btn-repassar pendente" onclick="abrirModalRepasse('${d.credor_id}','${(d.credor_nome || '').replace(/'/g, "\\'")}',${d.valor_repassar})">
              <i class="fas fa-paper-plane"></i> Repassar
            </button>
          </td>
        </tr>`).join('');
    }

    function renderRepassesHist(dados) {
      const tbody = document.getElementById('tbodyRepassesHist');
      if (!dados || !dados.length) return;

      tbody.innerHTML = dados.slice(0, 10).map(r => `
        <tr>
          <td>
            <div class="credor-info">
              <div class="credor-avatar">${initials(r.credor_nome)}</div>
              <div class="credor-nome">${r.credor_nome || 'Credor'}</div>
            </div>
          </td>
          <td class="valor">${fmtMoney(r.valor)}</td>
          <td>${r.forma_pagamento || '—'}</td>
          <td>${fmtDate(r.data_repasse || r.created_at)}</td>
          <td><span class="status-badge ${r.status}">${r.status === 'pago' ? 'Pago' : 'Pendente'}</span></td>
        </tr>`).join('');
    }

    // =============================================
    // RELATÓRIOS (COM DADOS DA API)
    // =============================================
    async function carregarRelatorios() {
      try {
        // Carregar resumo geral
        const resResumo = await fetch(API + '/api/financeiro/relatorios/resumo-geral', { headers: H() });
        const dataResumo = await resResumo.json();
        
        if (dataResumo.success && dataResumo.data) {
          document.getElementById('statRelInadimplentes').textContent = dataResumo.data.inadimplentes || '0';
          document.getElementById('statRelValorAtraso').textContent = fmtMoney(dataResumo.data.valor_atraso);
          document.getElementById('statRelRecebido').textContent = fmtMoney(dataResumo.data.recebido_mes);
          document.getElementById('statRelConversao').textContent = (dataResumo.data.taxa_conversao || 0).toFixed(0) + '%';
        } else {
          document.getElementById('statRelInadimplentes').textContent = '0';
          document.getElementById('statRelValorAtraso').textContent = fmtMoney(0);
          document.getElementById('statRelRecebido').textContent = fmtMoney(0);
          document.getElementById('statRelConversao').textContent = '0%';
        }

        // Carregar evolução mensal
        const resEvolucao = await fetch(API + '/api/financeiro/relatorios/evolucao-mensal', { headers: H() });
        const dataEvolucao = await resEvolucao.json();
        
        let labelsEvolucao = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
        let dadosRecuperado = [0, 0, 0, 0, 0, 0];
        let dadosAtraso = [0, 0, 0, 0, 0, 0];
        
        if (dataEvolucao.success && dataEvolucao.data && dataEvolucao.data.length) {
          labelsEvolucao = dataEvolucao.data.map(d => d.mes);
          dadosRecuperado = dataEvolucao.data.map(d => parseFloat(d.recuperado) || 0);
          dadosAtraso = dataEvolucao.data.map(d => parseFloat(d.em_atraso) || 0);
        }

        // Gráfico de Evolução
        const ctx1 = document.getElementById('chartEvolucao').getContext('2d');
        if (chartEvolucao) chartEvolucao.destroy();

        chartEvolucao = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: labelsEvolucao,
            datasets: [
              {
                label: 'Recuperado',
                data: dadosRecuperado,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34,197,94,0.1)',
                fill: true,
                tension: 0.4
              },
              {
                label: 'Em Atraso',
                data: dadosAtraso,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239,68,68,0.1)',
                fill: true,
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: '#a1a1aa' }
              }
            },
            scales: {
              y: {
                ticks: {
                  callback: v => 'R$ ' + (v / 1000) + 'k',
                  color: '#71717a'
                },
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              x: {
                ticks: { color: '#71717a' },
                grid: { display: false }
              }
            }
          }
        });

        // Carregar distribuição por status
        const resStatus = await fetch(API + '/api/financeiro/relatorios/distribuicao-status', { headers: H() });
        const dataStatus = await resStatus.json();
        
        let dadosStatus = [0, 0, 0];
        if (dataStatus.success && dataStatus.data) {
          dadosStatus = [
            dataStatus.data.pago || 0,
            dataStatus.data.pendente || 0,
            dataStatus.data.vencido || 0
          ];
        }

        // Gráfico de Status
        const ctx2 = document.getElementById('chartStatus').getContext('2d');
        if (chartStatus) chartStatus.destroy();

        chartStatus = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Pago', 'Pendente', 'Vencido'],
            datasets: [{
              data: dadosStatus,
              backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#a1a1aa' }
              }
            }
          }
        });

        // Carregar top devedores
        const resDevedores = await fetch(API + '/api/financeiro/relatorios/top-devedores', { headers: H() });
        const dataDevedores = await resDevedores.json();
        
        const tbody = document.getElementById('tbodyDevedores');
        
        if (dataDevedores.success && dataDevedores.data && dataDevedores.data.length) {
          tbody.innerHTML = dataDevedores.data.map((d, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>
                <div class="credor-info">
                  <div class="credor-avatar" style="background:var(--gold-glow);color:var(--gold)">${initials(d.nome)}</div>
                  <div>
                    <div class="credor-nome">${d.nome}</div>
                    <div class="credor-meta">${d.cpf_cnpj || ''}</div>
                  </div>
                </div>
              </td>
              <td>${d.total_cobrancas}</td>
              <td class="valor ${d.situacao === 'inadimplente' ? 'red' : 'gold'}">${fmtMoney(d.valor_total)}</td>
              <td>${d.dias_atraso} dias</td>
              <td>
                <span class="status-badge" style="background:${d.situacao === 'inadimplente' ? 'var(--red-bg)' : 'var(--orange-bg)'};color:${d.situacao === 'inadimplente' ? 'var(--red)' : 'var(--orange)'}">
                  ${d.situacao === 'inadimplente' ? 'Inadimplente' : 'Pendente'}
                </span>
              </td>
            </tr>`).join('');
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">
                <div class="empty">
                  <i class="fas fa-check-circle" style="color:var(--green)"></i>
                  <p>Nenhum devedor em atraso</p>
                </div>
              </td>
            </tr>`;
        }

      } catch (e) {
        console.error('Erro ao carregar relatórios:', e);
        
        // Fallback para dados vazios
        document.getElementById('statRelInadimplentes').textContent = '0';
        document.getElementById('statRelValorAtraso').textContent = fmtMoney(0);
        document.getElementById('statRelRecebido').textContent = fmtMoney(0);
        document.getElementById('statRelConversao').textContent = '0%';
        
        document.getElementById('tbodyDevedores').innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erro ao carregar dados</p>
              </div>
            </td>
          </tr>`;
      }
    }

    // =============================================
    // MODAL DE REPASSE
    // =============================================
    function abrirModal(credorId) {
      const c = credoresData.find(x => x.id === credorId);
      if (!c) return;

      document.getElementById('repasseCredorId').value = credorId;
      document.getElementById('repasseCredorSelect').value = credorId;

      const recuperado = parseFloat(c.valor_recuperado) || 0;
      const comissao = parseFloat(c.valor_comissao) || 0;
      const jaRepassado = parseFloat(c.valor_ja_repassado) || 0;
      const saldo = parseFloat(c.valor_a_repassar) || 0;
      const percent = (parseFloat(c.comissao_percentual) || 0) + (c.atingiu_meta ? (parseFloat(c.comissao_bonus) || 0) : 0);

      document.getElementById('modalRecuperado').textContent = fmtMoney(recuperado);
      document.getElementById('modalPercent').textContent = percent;
      document.getElementById('modalComissao').textContent = '- ' + fmtMoney(comissao);
      document.getElementById('modalJaRepassado').textContent = '- ' + fmtMoney(jaRepassado);
      document.getElementById('modalSaldo').textContent = fmtMoney(saldo);
      document.getElementById('repasseValor').value = saldo.toFixed(2).replace('.', ',');

      const dadosDiv = document.getElementById('dadosBanco');
      const dadosContent = document.getElementById('dadosBancoContent');

      if (c.pix_chave) {
        dadosDiv.style.display = 'block';
        dadosContent.innerHTML = `
          <p><strong>PIX:</strong> ${c.pix_chave} (${c.pix_tipo || 'Chave'})</p>
          ${c.banco ? `<p><strong>Banco:</strong> ${c.banco} | Ag: ${c.agencia || '-'} | Conta: ${c.conta || '-'}</p>` : ''}
        `;
      } else if (c.banco) {
        dadosDiv.style.display = 'block';
        dadosContent.innerHTML = `<p><strong>Banco:</strong> ${c.banco} | Ag: ${c.agencia || '-'} | Conta: ${c.conta || '-'}</p>`;
      } else {
        dadosDiv.style.display = 'none';
      }

      document.getElementById('modalRepasse').classList.add('show');
    }

    function abrirModalRepasse(credorId, nome, valor) {
      document.getElementById('repasseCredorId').value = credorId;
      document.getElementById('repasseCredorSelect').value = credorId;
      document.getElementById('repasseValor').value = valor.toFixed(2).replace('.', ',');

      document.getElementById('modalRecuperado').textContent = '—';
      document.getElementById('modalPercent').textContent = '—';
      document.getElementById('modalComissao').textContent = '—';
      document.getElementById('modalJaRepassado').textContent = '—';
      document.getElementById('modalSaldo').textContent = fmtMoney(valor);
      document.getElementById('dadosBanco').style.display = 'none';

      document.getElementById('modalRepasse').classList.add('show');
    }

    function abrirNovoRepasse() {
      document.getElementById('repasseCredorId').value = '';
      document.getElementById('repasseCredorSelect').value = '';
      document.getElementById('repasseValor').value = '';

      document.getElementById('modalRecuperado').textContent = '—';
      document.getElementById('modalPercent').textContent = '—';
      document.getElementById('modalComissao').textContent = '—';
      document.getElementById('modalJaRepassado').textContent = '—';
      document.getElementById('modalSaldo').textContent = '—';
      document.getElementById('dadosBanco').style.display = 'none';

      document.getElementById('modalRepasse').classList.add('show');
    }

    async function salvarRepasse() {
      let credorId = document.getElementById('repasseCredorId').value || document.getElementById('repasseCredorSelect').value;
      const valor = parseMoney(document.getElementById('repasseValor').value);
      const data = document.getElementById('repasseData').value;
      const forma = document.getElementById('repasseForma').value;
      const obs = document.getElementById('repasseObs').value;

      if (!credorId || !valor || !data) {
        toast('Preencha todos os campos');
        return;
      }

      try {
        const r = await fetch(API + '/api/financeiro/repasses', {
          method: 'POST',
          headers: H(),
          body: JSON.stringify({
            credor_id: credorId,
            valor,
            data_repasse: data,
            forma_pagamento: forma,
            comprovante: obs,
            status: 'pago'
          })
        });

        const d = await r.json();

        if (d.success) {
          toast('Repasse registrado!');
          fecharModal();
          carregar();
          if (currentTab === 'repasses') carregarRepasses();
        } else {
          toast(d.message || 'Erro');
        }
      } catch (e) {
        console.error('Erro ao salvar repasse:', e);
        toast('Erro');
      }
    }

    // =============================================
    // EXPORTAR
    // =============================================
    function exportar() {
      const mes = document.getElementById('selectMes').value;
      const ano = document.getElementById('selectAno').value;
      window.open(API + `/api/financeiro/exportar?mes=${mes}&ano=${ano}&token=${token}`, '_blank');
    }

    // =============================================
    // EVENT LISTENERS
    // =============================================
    document.getElementById('modalRepasse').onclick = e => {
      if (e.target.id === 'modalRepasse') fecharModal();
    };

    // =============================================
    // INICIALIZAÇÃO
    // =============================================
    initPeriodo();
    carregarUsuario();
    carregar();
  </script>
</body>
</html>