<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devedores - ACERTIVE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--bg-primary:#07090d;--bg-secondary:#0d1117;--bg-card:#111820;--bg-elevated:#1a222d;--gold-primary:#d4a853;--gold-light:#e8c47c;--gold-dark:#b8923e;--gold-glow:rgba(212,168,83,0.15);--gold-subtle:rgba(212,168,83,0.08);--success:#22c55e;--success-bg:rgba(34,197,94,0.12);--warning:#f59e0b;--warning-bg:rgba(245,158,11,0.12);--danger:#ef4444;--danger-bg:rgba(239,68,68,0.12);--info:#3b82f6;--info-bg:rgba(59,130,246,0.12);--text-primary:#f5f5f5;--text-secondary:#9ca3af;--text-muted:#6b7280;--border-subtle:rgba(212,168,83,0.1);--border-default:rgba(212,168,83,0.15);--border-strong:rgba(212,168,83,0.25);--shadow-sm:0 2px 8px rgba(0,0,0,0.3);--shadow-gold:0 4px 30px rgba(212,168,83,0.2)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .sidebar{position:fixed;left:0;top:0;width:280px;height:100vh;background:var(--bg-secondary);border-right:1px solid var(--border-subtle);display:flex;flex-direction:column;z-index:100}
        .sidebar-header{padding:28px 24px;border-bottom:1px solid var(--border-subtle)}
        .sidebar-logo{display:flex;align-items:center;gap:14px}
        .sidebar-logo-icon{width:46px;height:46px;background:linear-gradient(135deg,var(--gold-primary),var(--gold-dark));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--bg-primary)}
        .sidebar-logo-text{font-family:'Playfair Display',serif;font-size:26px;font-weight:700}
        .sidebar-logo-text span{color:var(--gold-primary)}
        .sidebar-nav{flex:1;padding:24px 16px;overflow-y:auto}
        .nav-section{margin-bottom:28px}
        .nav-section-title{font-size:10px;font-weight:700;color:var(--gold-primary);text-transform:uppercase;letter-spacing:1.5px;padding:0 14px;margin-bottom:12px}
        .nav-item{display:flex;align-items:center;gap:14px;padding:14px 18px;color:var(--text-secondary);text-decoration:none;border-radius:10px;margin-bottom:4px;transition:all 0.25s;font-size:14px;font-weight:500;border:1px solid transparent}
        .nav-item:hover{background:var(--gold-subtle);color:var(--text-primary)}
        .nav-item.active{background:var(--gold-subtle);color:var(--gold-light);border-color:var(--border-default)}
        .nav-item i{width:20px;text-align:center}
        .nav-item .badge{margin-left:auto;background:var(--danger);color:white;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px}
        .sidebar-footer{padding:20px;border-top:1px solid var(--border-subtle)}
        .user-info{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:12px}
        .user-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--gold-primary),var(--gold-dark));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg-primary)}
        .user-details{flex:1}
        .user-name{font-size:14px;font-weight:600}
        .user-role{font-size:12px;color:var(--text-muted)}
        .user-logout{color:var(--text-muted);padding:8px;cursor:pointer;border-radius:8px}
        .user-logout:hover{background:var(--danger-bg);color:var(--danger)}
        .main-content{margin-left:280px;min-height:100vh;padding:36px 40px}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
        .page-header-left h1{font-family:'Playfair Display',serif;font-size:32px;font-weight:600;margin-bottom:6px}
        .page-header-left p{font-size:14px;color:var(--text-muted)}
        .btn{display:inline-flex;align-items:center;gap:10px;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;text-decoration:none;border:none;font-family:'DM Sans',sans-serif}
        .btn-primary{background:linear-gradient(135deg,var(--gold-primary),var(--gold-dark));color:var(--bg-primary)}
        .btn-primary:hover{transform:translateY(-2px)}
        .btn-secondary{background:var(--bg-card);border:1px solid var(--gold-primary);color:var(--gold-primary)}
        .btn-secondary:hover{background:var(--gold-subtle)}
        .filters-bar{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap}
        .search-box{flex:1;min-width:300px;position:relative}
        .search-box i{position:absolute;left:18px;top:50%;transform:translateY(-50%);color:var(--text-muted)}
        .search-box input{width:100%;padding:14px 18px 14px 48px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:12px;color:var(--text-primary);font-size:14px}
        .search-box input:focus{outline:none;border-color:var(--gold-primary)}
        .filter-select{padding:14px 18px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:12px;color:var(--text-primary);font-size:14px;min-width:180px}
        .filter-select option{background:var(--bg-card)}
        .status-tabs{display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap}
        .status-tab{display:flex;align-items:center;gap:10px;padding:12px 18px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:25px;color:var(--text-secondary);font-size:13px;cursor:pointer;transition:all 0.3s}
        .status-tab:hover{background:var(--gold-subtle);color:var(--text-primary)}
        .status-tab.active{border-color:var(--gold-primary);color:var(--gold-light)}
        .status-tab .count{background:var(--bg-secondary);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700}
        .status-tab.active .count{background:var(--gold-primary);color:var(--bg-primary)}
        .table-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:16px;overflow:hidden}
        table{width:100%;border-collapse:collapse}
        th{text-align:left;padding:18px 24px;font-size:10px;font-weight:700;color:var(--gold-primary);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border-subtle);background:var(--bg-secondary)}
        td{padding:18px 24px;border-bottom:1px solid var(--border-subtle);font-size:14px}
        tr:hover{background:var(--gold-subtle)}
        tr:last-child td{border-bottom:none}
        .devedor-info{display:flex;align-items:center;gap:14px}
        .devedor-avatar{width:44px;height:44px;background:var(--gold-subtle);border:1px solid var(--border-default);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--gold-primary)}
        .devedor-nome{font-weight:600;margin-bottom:3px}
        .devedor-doc{font-size:12px;color:var(--text-muted)}
        .status-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:10px;font-weight:700;text-transform:uppercase}
        .status-novo{background:var(--info-bg);color:#60a5fa}
        .status-negociando{background:var(--warning-bg);color:#fbbf24}
        .status-acordo{background:var(--success-bg);color:#34d399}
        .status-sem_contato{background:rgba(156,163,175,0.12);color:#9ca3af}
        .status-recusou{background:var(--danger-bg);color:#f87171}
        .valor-cell{font-family:'Playfair Display',serif;font-weight:600;color:var(--gold-primary)}
        .atraso-cell{color:var(--danger);font-weight:600}
        .atraso-cell.ok{color:var(--success)}
        .actions-cell{display:flex;gap:8px}
        .action-btn{width:38px;height:38px;border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
        .action-btn.view{background:var(--gold-subtle);color:var(--gold-primary)}
        .action-btn.work{background:var(--success-bg);color:var(--success)}
        .action-btn:hover{transform:scale(1.1)}
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 40px;text-align:center}
        .empty-state i{font-size:64px;color:var(--gold-primary);margin-bottom:20px;opacity:0.4}
        .empty-state h3{font-family:'Playfair Display',serif;font-size:20px;margin-bottom:8px}
        .empty-state p{color:var(--text-muted)}
        .loading{display:flex;justify-content:center;padding:80px}
        .spinner{width:44px;height:44px;border:3px solid var(--border-subtle);border-top-color:var(--gold-primary);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .pagination{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-top:1px solid var(--border-subtle);background:var(--bg-secondary)}
        .pagination-info{font-size:13px;color:var(--text-muted)}
        .pagination-buttons{display:flex;gap:8px}
        .pagination-btn{padding:10px 16px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:10px;color:var(--text-secondary);font-size:13px;cursor:pointer}
        .pagination-btn:hover:not(:disabled){background:var(--gold-subtle);color:var(--gold-primary)}
        .pagination-btn:disabled{opacity:0.4;cursor:not-allowed}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border:1px solid var(--border-default);border-radius:20px;width:100%;max-width:720px;max-height:90vh;overflow-y:auto}
        .modal-header{padding:24px 28px;border-bottom:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center}
        .modal-header h3{font-family:'Playfair Display',serif;font-size:20px;display:flex;align-items:center;gap:12px}
        .modal-header h3 i{color:var(--gold-primary)}
        .modal-close{background:none;border:none;color:var(--text-muted);font-size:24px;cursor:pointer;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center}
        .modal-close:hover{background:var(--danger-bg);color:var(--danger)}
        .modal-body{padding:28px}
        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px}
        .detail-item{background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:12px;padding:18px}
        .detail-label{font-size:10px;font-weight:700;color:var(--gold-primary);text-transform:uppercase;margin-bottom:8px}
        .detail-value{font-size:16px;font-weight:500}
        .detail-value.gold{color:var(--gold-primary)}
        .detail-value.red{color:var(--danger)}
        .cobrancas-list h4{font-family:'Playfair Display',serif;font-size:16px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
        .cobrancas-list h4 i{color:var(--gold-primary)}
        .cob-item{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:12px;margin-bottom:10px}
        .cob-desc{font-size:14px;font-weight:600;margin-bottom:4px}
        .cob-credor{font-size:12px;color:var(--text-muted)}
        .cob-valor{font-family:'Playfair Display',serif;font-weight:600;color:var(--gold-primary)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .form-row.three{grid-template-columns:1fr 1fr 1fr}
        .form-group{margin-bottom:20px}
        .form-group.full{grid-column:1/-1}
        .form-group label{display:block;font-size:11px;font-weight:700;color:var(--gold-primary);text-transform:uppercase;margin-bottom:8px}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:14px 16px;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:10px;color:var(--text-primary);font-size:14px}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold-primary)}
        .form-group select option{background:var(--bg-secondary)}
        .form-group textarea{resize:vertical;min-height:80px}
        .form-section{margin-bottom:28px;padding-bottom:24px;border-bottom:1px solid var(--border-subtle)}
        .form-section:last-child{border-bottom:none}
        .form-section-title{font-family:'Playfair Display',serif;font-size:16px;margin-bottom:20px;display:flex;align-items:center;gap:10px;color:var(--gold-light)}
        .form-section-title i{color:var(--gold-primary)}
        .modal-footer{padding:20px 28px;border-top:1px solid var(--border-subtle);display:flex;gap:14px;justify-content:flex-end}
        .btn-cancelar{padding:14px 24px;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:10px;color:var(--text-secondary);font-size:14px;font-weight:600;cursor:pointer}
        .btn-cancelar:hover{background:var(--bg-elevated);color:var(--text-primary)}
        .btn-salvar{padding:14px 28px;background:linear-gradient(135deg,var(--gold-primary),var(--gold-dark));border:none;border-radius:10px;color:var(--bg-primary);font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px}
        .btn-salvar:hover{transform:translateY(-2px)}
        .btn-salvar:disabled{opacity:0.6;cursor:not-allowed;transform:none}
        @media(max-width:768px){.sidebar{transform:translateX(-100%)}.main-content{margin-left:0;padding:24px 20px}}
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header"><div class="sidebar-logo"><div class="sidebar-logo-icon"><i class="fas fa-scale-balanced"></i></div><div class="sidebar-logo-text">ACERT<span>IVE</span></div></div></div>
        <nav class="sidebar-nav">
            <div class="nav-section"><div class="nav-section-title">Principal</div><a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a><a href="fila.html" class="nav-item"><i class="fas fa-headset"></i> Fila de Trabalho <span class="badge" id="filaBadge">0</span></a></div>
            <div class="nav-section"><div class="nav-section-title">Gestão</div><a href="devedores.html" class="nav-item active"><i class="fas fa-users"></i> Devedores</a><a href="acordos.html" class="nav-item"><i class="fas fa-handshake"></i> Acordos</a><a href="cobrancas.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a></div>
            <div class="nav-section"><div class="nav-section-title">Cadastros</div><a href="credores.html" class="nav-item"><i class="fas fa-building"></i> Credores</a></div>
            <div class="nav-section"><div class="nav-section-title">Sistema</div><a href="importacao.html" class="nav-item"><i class="fas fa-file-import"></i> Importação</a><a href="configuracoes.html" class="nav-item"><i class="fas fa-cog"></i> Configurações</a></div>
        </nav>
        <div class="sidebar-footer"><div class="user-info"><div class="user-avatar" id="userAvatar">U</div><div class="user-details"><div class="user-name" id="userName">Usuário</div><div class="user-role" id="userRole">Operador</div></div><div class="user-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></div></div></div>
    </aside>

    <main class="main-content">
        <header class="page-header"><div class="page-header-left"><h1>Devedores</h1><p>Gerencie todos os devedores e suas cobranças</p></div><div style="display:flex;gap:12px;"><button class="btn btn-secondary" onclick="abrirModalNovoDevedor()"><i class="fas fa-plus"></i> Novo Devedor</button><a href="fila.html" class="btn btn-primary"><i class="fas fa-headset"></i> Iniciar Trabalho</a></div></header>
        <div class="filters-bar"><div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Buscar por nome, CPF ou telefone..." onkeyup="filtrarComDebounce()"></div><select class="filter-select" id="filterCredor" onchange="filtrar()"><option value="">Todos os credores</option></select><select class="filter-select" id="filterAtraso" onchange="filtrar()"><option value="">Qualquer atraso</option><option value="0-30">Até 30 dias</option><option value="31-60">31 a 60 dias</option><option value="61-90">61 a 90 dias</option><option value="90+">Mais de 90 dias</option></select></div>
        <div class="status-tabs"><div class="status-tab active" data-status="" onclick="filtrarStatus('')"><i class="fas fa-users"></i> Todos <span class="count" id="countTodos">0</span></div><div class="status-tab" data-status="novo" onclick="filtrarStatus('novo')"><i class="fas fa-star"></i> Novos <span class="count" id="countNovo">0</span></div><div class="status-tab" data-status="negociando" onclick="filtrarStatus('negociando')"><i class="fas fa-comments"></i> Negociando <span class="count" id="countNegociando">0</span></div><div class="status-tab" data-status="acordo" onclick="filtrarStatus('acordo')"><i class="fas fa-handshake"></i> Acordo <span class="count" id="countAcordo">0</span></div><div class="status-tab" data-status="sem_contato" onclick="filtrarStatus('sem_contato')"><i class="fas fa-phone-slash"></i> Sem Contato <span class="count" id="countSemContato">0</span></div><div class="status-tab" data-status="recusou" onclick="filtrarStatus('recusou')"><i class="fas fa-times-circle"></i> Recusou <span class="count" id="countRecusou">0</span></div></div>
        <div class="table-card"><div class="table-wrapper"><table><thead><tr><th>Devedor</th><th>Credor</th><th>Status</th><th>Atraso</th><th>Valor Total</th><th>Ações</th></tr></thead><tbody id="tabelaBody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div><div class="pagination"><div class="pagination-info" id="paginationInfo">Mostrando 0 de 0</div><div class="pagination-buttons"><button class="pagination-btn" id="btnPrev" onclick="paginaAnterior()" disabled><i class="fas fa-chevron-left"></i> Anterior</button><button class="pagination-btn" id="btnNext" onclick="proximaPagina()">Próximo <i class="fas fa-chevron-right"></i></button></div></div></div>
    </main>

    <div class="modal-overlay" id="modalDetalhes"><div class="modal"><div class="modal-header"><h3><i class="fas fa-user"></i> <span id="modalNome">Detalhes</span></h3><button class="modal-close" onclick="fecharModal()">&times;</button></div><div class="modal-body"><div class="detail-grid"><div class="detail-item"><div class="detail-label">CPF/CNPJ</div><div class="detail-value" id="modalDoc">-</div></div><div class="detail-item"><div class="detail-label">Telefone</div><div class="detail-value" id="modalTel">-</div></div><div class="detail-item"><div class="detail-label">E-mail</div><div class="detail-value" id="modalEmail">-</div></div><div class="detail-item"><div class="detail-label">Status</div><div class="detail-value" id="modalStatus">-</div></div><div class="detail-item"><div class="detail-label">Valor Total</div><div class="detail-value gold" id="modalValor">R$ 0</div></div><div class="detail-item"><div class="detail-label">Maior Atraso</div><div class="detail-value red" id="modalAtraso">0 dias</div></div></div><div class="cobrancas-list"><h4><i class="fas fa-file-invoice"></i> Cobranças</h4><div id="modalCobrancas"></div></div></div></div></div>

    <div class="modal-overlay" id="modalNovoDevedor"><div class="modal" style="max-width:800px;"><div class="modal-header"><h3><i class="fas fa-user-plus"></i> Novo Devedor</h3><button class="modal-close" onclick="fecharModalNovo()">&times;</button></div><div class="modal-body"><form id="formNovoDevedor" onsubmit="salvarDevedor(event)"><div class="form-section"><div class="form-section-title"><i class="fas fa-user"></i> Dados Pessoais</div><div class="form-row"><div class="form-group full"><label>Nome *</label><input type="text" id="novoNome" required placeholder="Nome completo"></div></div><div class="form-row"><div class="form-group"><label>CPF/CNPJ *</label><input type="text" id="novoCpf" required placeholder="000.000.000-00" oninput="mascaraCpfCnpj(this)"></div><div class="form-group"><label>E-mail</label><input type="email" id="novoEmail" placeholder="email@exemplo.com"></div></div><div class="form-row"><div class="form-group"><label>Telefone</label><input type="text" id="novoTelefone" placeholder="(00) 00000-0000" oninput="mascaraTelefone(this)"></div><div class="form-group"><label>Telefone 2</label><input type="text" id="novoTelefone2" placeholder="(00) 00000-0000" oninput="mascaraTelefone(this)"></div></div></div><div class="form-section"><div class="form-section-title"><i class="fas fa-file-invoice-dollar"></i> Dados da Dívida</div><div class="form-row"><div class="form-group"><label>Credor *</label><select id="novoCredor" required><option value="">Selecione...</option></select></div><div class="form-group"><label>Nº Documento</label><input type="text" id="novoDocumento" placeholder="Número"></div></div><div class="form-row three"><div class="form-group"><label>Valor *</label><input type="text" id="novoValor" required placeholder="R$ 0,00" oninput="mascaraMoeda(this)"></div><div class="form-group"><label>Vencimento *</label><input type="date" id="novoVencimento" required></div><div class="form-group"><label>Status</label><select id="novoStatus"><option value="novo">Novo</option><option value="negociando">Negociando</option><option value="sem_contato">Sem Contato</option></select></div></div><div class="form-row"><div class="form-group full"><label>Descrição</label><textarea id="novoDescricao" placeholder="Detalhes..."></textarea></div></div></div></form></div><div class="modal-footer"><button type="button" class="btn-cancelar" onclick="fecharModalNovo()">Cancelar</button><button type="submit" form="formNovoDevedor" class="btn-salvar" id="btnSalvar"><i class="fas fa-save"></i> Salvar</button></div></div></div>

    <script>
        const API = window.location.origin;
        let todosDevedores = [];
        let devedoresFiltrados = [];
        let statusAtual = '';
        let paginaAtual = 1;
        const porPagina = 20;
        let debounceTimer;

        function H() { return { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' }; }
        function fmtMoney(v) { return (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return false; }
            try {
                const r = await fetch(API + '/api/auth/me', { headers: H() });
                const d = await r.json();
                if (!d.success && !d.user) { window.location.href = '/login.html'; return false; }
                const user = d.user || d;
                document.getElementById('userName').textContent = user.nome || 'Usuário';
                document.getElementById('userRole').textContent = user.perfil || 'Operador';
                document.getElementById('userAvatar').textContent = (user.nome || 'U').charAt(0).toUpperCase();
                return true;
            } catch (e) { return true; }
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

        async function carregarDevedores() {
            try {
                const r = await fetch(API + '/api/acionamentos/fila/devedores?limit=10000', { headers: H() });
                const d = await r.json();
                const devedores = d.data || [];

                todosDevedores = devedores.map(dev => ({
                    id: dev.cliente_id,
                    cliente_id: dev.cliente_id,
                    nome: dev.nome || 'Cliente',
                    cpf_cnpj: dev.cpf_cnpj || '-',
                    telefone: dev.telefone || dev.celular || '',
                    email: dev.email || '',
                    credor: dev.credor_nome || '-',
                    total: parseFloat(dev.valor_total) || 0,
                    maiorAtraso: parseInt(dev.maior_atraso) || 0,
                    total_cobrancas: parseInt(dev.total_cobrancas) || 0,
                    status: dev.status_cobranca || 'novo'
                }));

                await carregarCredores();
                atualizarContadores();
                filtrar();
            } catch (e) {
                console.error('Erro:', e);
                document.getElementById('tabelaBody').innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Erro ao carregar</h3></div></td></tr>';
            }
        }

        async function carregarCredores() {
            try {
                const r = await fetch(API + '/api/cadastros/credores', { headers: H() });
                const d = await r.json();
                const credores = d.data || d || [];
                const select = document.getElementById('filterCredor');
                select.innerHTML = '<option value="">Todos os credores</option>';
                credores.forEach(c => { const opt = document.createElement('option'); opt.value = c.nome; opt.textContent = c.nome; select.appendChild(opt); });
            } catch (e) {}
        }

        function atualizarContadores() {
            document.getElementById('countTodos').textContent = todosDevedores.length;
            document.getElementById('countNovo').textContent = todosDevedores.filter(d => d.status === 'novo').length;
            document.getElementById('countNegociando').textContent = todosDevedores.filter(d => d.status === 'negociando').length;
            document.getElementById('countAcordo').textContent = todosDevedores.filter(d => d.status === 'acordo').length;
            document.getElementById('countSemContato').textContent = todosDevedores.filter(d => d.status === 'sem_contato').length;
            document.getElementById('countRecusou').textContent = todosDevedores.filter(d => d.status === 'recusou').length;
            document.getElementById('filaBadge').textContent = todosDevedores.filter(d => d.maiorAtraso > 0).length;
        }

        function filtrarStatus(status) {
            statusAtual = status;
            document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.status-tab[data-status="'+status+'"]').classList.add('active');
            paginaAtual = 1;
            filtrar();
        }

        function filtrarComDebounce() { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => filtrar(), 300); }

        function filtrar() {
            const busca = document.getElementById('searchInput').value.toLowerCase().trim();
            const credor = document.getElementById('filterCredor').value;
            const atraso = document.getElementById('filterAtraso').value;

            devedoresFiltrados = todosDevedores.filter(d => {
                // Filtro por status
                if (statusAtual && d.status !== statusAtual) return false;
                
                // Filtro por busca - CORRIGIDO
                if (busca) {
                    const nomeOk = d.nome && d.nome.toLowerCase().includes(busca);
                    const cpfOk = d.cpf_cnpj && d.cpf_cnpj.replace(/\D/g,'').includes(busca.replace(/\D/g,''));
                    const telOk = d.telefone && d.telefone.replace(/\D/g,'').includes(busca.replace(/\D/g,''));
                    if (!nomeOk && !cpfOk && !telOk) return false;
                }
                
                // Filtro por credor
                if (credor && d.credor !== credor) return false;
                
                // Filtro por atraso
                if (atraso) {
                    if (atraso === '90+') { if (d.maiorAtraso <= 90) return false; }
                    else { const [min, max] = atraso.split('-').map(x => parseInt(x) || 0); if (d.maiorAtraso < min || d.maiorAtraso > max) return false; }
                }
                
                return true;
            });
            paginaAtual = 1;
            renderizar();
        }

        function renderizar() {
            const inicio = (paginaAtual - 1) * porPagina;
            const fim = inicio + porPagina;
            const pagina = devedoresFiltrados.slice(inicio, fim);

            if (pagina.length === 0) {
                document.getElementById('tabelaBody').innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-users"></i><h3>Nenhum devedor encontrado</h3><p>Tente ajustar os filtros</p></div></td></tr>';
            } else {
                document.getElementById('tabelaBody').innerHTML = pagina.map(d => `<tr><td><div class="devedor-info"><div class="devedor-avatar">${(d.nome||'D').charAt(0)}</div><div><div class="devedor-nome">${d.nome||'-'}</div><div class="devedor-doc">${d.cpf_cnpj||'-'}</div></div></div></td><td>${d.credor}</td><td><span class="status-badge status-${d.status}">${formatStatus(d.status)}</span></td><td><span class="atraso-cell${d.maiorAtraso===0?' ok':''}">${d.maiorAtraso>0?d.maiorAtraso+' dias':'Em dia'}</span></td><td><span class="valor-cell">${fmtMoney(d.total)}</span></td><td><div class="actions-cell"><button class="action-btn view" onclick="verDetalhes('${d.id}')"><i class="fas fa-eye"></i></button><button class="action-btn work" onclick="trabalhar('${d.id}')"><i class="fas fa-headset"></i></button></div></td></tr>`).join('');
            }

            const total = devedoresFiltrados.length;
            document.getElementById('paginationInfo').textContent = `Mostrando ${Math.min(inicio+1,total)}-${Math.min(fim,total)} de ${total}`;
            document.getElementById('btnPrev').disabled = paginaAtual === 1;
            document.getElementById('btnNext').disabled = paginaAtual >= Math.ceil(total / porPagina);
        }

        function formatStatus(s) { const map = {'novo':'Novo','negociando':'Negociando','acordo':'Acordo','sem_contato':'Sem Contato','recusou':'Recusou'}; return map[s]||'Novo'; }
        function paginaAnterior() { if (paginaAtual > 1) { paginaAtual--; renderizar(); } }
        function proximaPagina() { paginaAtual++; renderizar(); }

        async function verDetalhes(id) {
            const dev = todosDevedores.find(d => d.id === id || d.cliente_id === id);
            if (!dev) return;
            document.getElementById('modalNome').textContent = dev.nome;
            document.getElementById('modalDoc').textContent = dev.cpf_cnpj || '-';
            document.getElementById('modalTel').textContent = dev.telefone || '-';
            document.getElementById('modalEmail').textContent = dev.email || '-';
            document.getElementById('modalStatus').innerHTML = `<span class="status-badge status-${dev.status}">${formatStatus(dev.status)}</span>`;
            document.getElementById('modalValor').textContent = fmtMoney(dev.total);
            document.getElementById('modalAtraso').textContent = dev.maiorAtraso + ' dias';
            document.getElementById('modalCobrancas').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin"></i> Carregando...</p>';
            document.getElementById('modalDetalhes').classList.add('active');

            try {
                const r = await fetch(API + '/api/cobrancas?cliente_id=' + id + '&limit=20', { headers: H() });
                const d = await r.json();
                const cobrancas = d.data || [];
                if (cobrancas.length === 0) {
                    document.getElementById('modalCobrancas').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">Nenhuma cobrança</p>';
                } else {
                    document.getElementById('modalCobrancas').innerHTML = cobrancas.slice(0,10).map(c => `<div class="cob-item"><div><div class="cob-desc">${c.descricao||'Cobrança'}</div><div class="cob-credor">${c.credor_nome||'-'} | ${c.status}</div></div><div><div class="cob-valor">${fmtMoney(c.valor)}</div></div></div>`).join('');
                }
            } catch (e) {
                document.getElementById('modalCobrancas').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">Erro ao carregar</p>';
            }
        }

        function fecharModal() { document.getElementById('modalDetalhes').classList.remove('active'); }
        function trabalhar(id) { window.location.href = 'fila.html?id=' + id; }

        function abrirModalNovoDevedor() { document.getElementById('formNovoDevedor').reset(); carregarCredoresModal(); document.getElementById('modalNovoDevedor').classList.add('active'); }
        function fecharModalNovo() { document.getElementById('modalNovoDevedor').classList.remove('active'); }

        async function carregarCredoresModal() {
            try {
                const r = await fetch(API + '/api/cadastros/credores', { headers: H() });
                const d = await r.json();
                const credores = d.data || d || [];
                const select = document.getElementById('novoCredor');
                select.innerHTML = '<option value="">Selecione...</option>';
                credores.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.nome; select.appendChild(opt); });
            } catch (e) {}
        }

        async function salvarDevedor(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSalvar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                const clienteData = {
                    nome: document.getElementById('novoNome').value.toUpperCase(),
                    cpf_cnpj: document.getElementById('novoCpf').value.replace(/\D/g, ''),
                    email: document.getElementById('novoEmail').value || null,
                    telefone: document.getElementById('novoTelefone').value.replace(/\D/g, '') || null,
                    celular: document.getElementById('novoTelefone2').value.replace(/\D/g, '') || null,
                    status_cobranca: document.getElementById('novoStatus').value || 'novo',
                    ativo: true
                };

                const rCliente = await fetch(API + '/api/cadastros/clientes', { method: 'POST', headers: H(), body: JSON.stringify(clienteData) });
                const dCliente = await rCliente.json();
                if (!rCliente.ok || !dCliente.success) throw new Error(dCliente.error || 'Erro ao criar cliente');

                const clienteId = dCliente.data?.id || dCliente.id;
                const valorStr = document.getElementById('novoValor').value;
                const valor = parseFloat(valorStr.replace(/[^\d,]/g, '').replace(',', '.')) || 0;

                const cobrancaData = {
                    cliente_id: clienteId,
                    credor_id: document.getElementById('novoCredor').value,
                    numero_documento: document.getElementById('novoDocumento').value || null,
                    valor: valor,
                    valor_original: valor,
                    data_vencimento: document.getElementById('novoVencimento').value,
                    descricao: document.getElementById('novoDescricao').value || 'Cobrança manual',
                    status: new Date(document.getElementById('novoVencimento').value) < new Date() ? 'vencido' : 'pendente'
                };

                const rCob = await fetch(API + '/api/cobrancas', { method: 'POST', headers: H(), body: JSON.stringify(cobrancaData) });
                const dCob = await rCob.json();
                if (!rCob.ok) throw new Error(dCob.error || 'Erro ao criar cobrança');

                alert('✅ Devedor cadastrado!');
                fecharModalNovo();
                await carregarDevedores();
            } catch (error) {
                alert('❌ Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Salvar';
            }
        }

        function mascaraCpfCnpj(input) { let v = input.value.replace(/\D/g, ''); if (v.length <= 11) { v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2'); } else { v = v.replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2'); } input.value = v; }
        function mascaraTelefone(input) { let v = input.value.replace(/\D/g, ''); v = v.replace(/^(\d{2})(\d)/g, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2'); input.value = v.substring(0, 15); }
        function mascaraMoeda(input) { let v = input.value.replace(/\D/g, ''); if (v === '') v = '0'; v = (parseInt(v) / 100).toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); input.value = 'R$ ' + v; }

        document.addEventListener('DOMContentLoaded', async () => {
            const auth = await checkAuth();
            if (auth) await carregarDevedores();
            document.getElementById('modalDetalhes').addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) fecharModal(); });
            document.getElementById('modalNovoDevedor').addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) fecharModalNovo(); });
        });

        const urlParams = new URLSearchParams(window.location.search);
        const idParam = urlParams.get('id');
        if (idParam) setTimeout(() => verDetalhes(idParam), 1000);
    </script>
</body>
</html>