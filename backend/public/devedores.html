<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACERTIVE - Devedores</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #0a0a0b;
      --bg-card: #111113;
      --bg-card-hover: #161618;
      --border: #1e1e22;
      --border-light: #2a2a2e;
      --text: #fafafa;
      --text-muted: #71717a;
      --text-secondary: #a1a1aa;
      --gold: #d4a847;
      --gold-dark: #b8922e;
      --gold-glow: rgba(212,168,71,0.1);
      --green: #22c55e;
      --green-bg: rgba(34,197,94,0.1);
      --red: #ef4444;
      --red-bg: rgba(239,68,68,0.1);
      --blue: #3b82f6;
      --blue-bg: rgba(59,130,246,0.1);
      --orange: #f97316;
      --orange-bg: rgba(249,115,22,0.1);
      --purple: #a855f7;
      --purple-bg: rgba(168,85,247,0.1);
      --cyan: #06b6d4;
      --cyan-bg: rgba(6,182,212,0.1);
      --sidebar: 260px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* SIDEBAR */
    .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar); height: 100vh; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; color: var(--bg); }
    .logo-text { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
    .logo-text span { color: var(--gold); }
    .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); padding: 8px 16px; letter-spacing: 0.5px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; font-weight: 500; font-size: 14px; transition: all 0.15s; margin-bottom: 2px; }
    .nav-link:hover { background: var(--bg-card-hover); color: var(--text); }
    .nav-link.active { background: var(--gold-glow); color: var(--gold); }
    .nav-link i { width: 20px; text-align: center; font-size: 15px; }
    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    .user-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 10px; }
    .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--gold-glow) 0%, transparent 100%); border: 2px solid var(--gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--gold); }
    .user-info { flex: 1; }
    .user-name { font-weight: 600; font-size: 13px; }
    .user-role { font-size: 11px; color: var(--text-muted); }
    .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.15s; }
    .btn-logout:hover { background: var(--red-bg); color: var(--red); }

    /* MAIN */
    .main { margin-left: var(--sidebar); min-height: 100vh; padding: 24px 32px; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .page-title { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 4px; }
    .page-subtitle { color: var(--text-muted); font-size: 14px; }
    .header-actions { display: flex; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; transition: all 0.15s; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: var(--bg); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212,168,71,0.3); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--gold); color: var(--gold); }
    .btn-sm { padding: 8px 14px; font-size: 12px; }
    .btn-success { background: var(--green); color: white; }

    /* FILTERS */
    .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .search-box { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; min-width: 300px; }
    .search-box:focus-within { border-color: var(--gold); }
    .search-box i { color: var(--text-muted); }
    .search-box input { flex: 1; background: none; border: none; outline: none; color: var(--text); font-size: 14px; }
    .filter-select { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; cursor: pointer; }
    .filter-select:focus { outline: none; border-color: var(--gold); }
    .filter-select option { background: var(--bg); }

    /* STATUS TABS */
    .status-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .status-tab { padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px; }
    .status-tab:hover { border-color: var(--gold); color: var(--text); }
    .status-tab.active { background: var(--gold-glow); border-color: var(--gold); color: var(--gold); }
    .status-tab .count { padding: 2px 8px; border-radius: 10px; font-size: 11px; background: rgba(255,255,255,0.1); }
    .status-tab.active .count { background: var(--gold); color: var(--bg); }

    /* TABLE */
    .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--bg); }
    th { text-align: left; padding: 14px 20px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; border-bottom: 1px solid var(--border); }
    td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: var(--bg-card-hover); }
    tr { cursor: pointer; transition: background 0.15s; }
    .devedor-cell { display: flex; align-items: center; gap: 14px; }
    .devedor-avatar { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; background: var(--bg); color: var(--text-muted); }
    .devedor-name { font-weight: 600; margin-bottom: 2px; }
    .devedor-doc { font-size: 12px; color: var(--text-muted); }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .status-badge.novo { background: var(--blue-bg); color: var(--blue); }
    .status-badge.negociando { background: var(--orange-bg); color: var(--orange); }
    .status-badge.acordo { background: var(--green-bg); color: var(--green); }
    .status-badge.quitado { background: var(--green-bg); color: var(--green); }
    .status-badge.sem_contato { background: var(--purple-bg); color: var(--purple); }
    .status-badge.recusou { background: var(--red-bg); color: var(--red); }
    .status-badge.juridico { background: var(--cyan-bg); color: var(--cyan); }
    .status-badge.incobravel { background: rgba(0,0,0,0.3); color: var(--text-muted); }
    .valor-cell { text-align: right; }
    .valor-total { font-weight: 700; font-size: 15px; color: var(--gold); }
    .valor-qtd { font-size: 11px; color: var(--text-muted); }
    .atraso-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .atraso-badge.grave { background: var(--red-bg); color: var(--red); }
    .atraso-badge.moderado { background: var(--orange-bg); color: var(--orange); }
    .atraso-badge.leve { background: var(--blue-bg); color: var(--blue); }
    .atraso-badge.ok { background: var(--green-bg); color: var(--green); }
    .empty { text-align: center; padding: 60px 24px; color: var(--text-muted); }
    .empty i { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: flex-start; justify-content: center; padding: 40px 20px; overflow-y: auto; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 900px; }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
    .modal-header h2 i { color: var(--gold); }
    .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
    .modal-close:hover { color: var(--red); }
    .modal-body { padding: 24px; }

    /* DEVEDOR DETAIL */
    .devedor-header { display: flex; gap: 24px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
    .devedor-header-avatar { width: 80px; height: 80px; border-radius: 16px; background: var(--gold-glow); border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 800; color: var(--gold); }
    .devedor-header-info { flex: 1; }
    .devedor-header-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .devedor-header-doc { color: var(--text-muted); font-size: 14px; margin-bottom: 12px; }
    .devedor-header-contacts { display: flex; gap: 16px; flex-wrap: wrap; }
    .devedor-contact { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
    .devedor-contact i { color: var(--gold); }
    .devedor-contact a { color: var(--green); text-decoration: none; }
    .devedor-contact a:hover { text-decoration: underline; }
    .devedor-header-status { text-align: right; }
    .devedor-status-select { padding: 10px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 8px; }
    .devedor-total-label { font-size: 12px; color: var(--text-muted); }
    .devedor-total-value { font-size: 28px; font-weight: 800; color: var(--gold); }

    /* TABS */
    .detail-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg); border-radius: 10px; padding: 4px; }
    .detail-tab { padding: 10px 20px; background: transparent; border: none; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; border-radius: 8px; transition: all 0.15s; }
    .detail-tab:hover { color: var(--text); }
    .detail-tab.active { background: var(--gold); color: var(--bg); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* COBRANCAS LIST */
    .cobranca-card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .cobranca-card:hover { border-color: var(--gold); }
    .cobranca-info h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .cobranca-info p { font-size: 12px; color: var(--text-muted); }
    .cobranca-valor { text-align: right; }
    .cobranca-valor-num { font-size: 18px; font-weight: 700; color: var(--gold); }
    .cobranca-venc { font-size: 11px; color: var(--text-muted); }

    /* HISTORICO */
    .historico-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--border); }
    .historico-item:last-child { border-bottom: none; }
    .historico-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .historico-icon.ligacao { background: var(--blue-bg); color: var(--blue); }
    .historico-icon.whatsapp { background: var(--green-bg); color: var(--green); }
    .historico-icon.email { background: var(--purple-bg); color: var(--purple); }
    .historico-icon.acordo { background: var(--gold-glow); color: var(--gold); }
    .historico-content { flex: 1; }
    .historico-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .historico-desc { font-size: 13px; color: var(--text-muted); }
    .historico-time { font-size: 11px; color: var(--text-muted); }

    /* ACIONAMENTO FORM */
    .acionamento-form { background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
    .acionamento-form h4 { font-size: 14px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .acionamento-form h4 i { color: var(--gold); }
    .acionamento-tipos { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .tipo-btn { padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.15s; }
    .tipo-btn:hover { border-color: var(--gold); color: var(--gold); }
    .tipo-btn.active { background: var(--gold-glow); border-color: var(--gold); color: var(--gold); }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
    .form-control { width: 100%; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; }
    .form-control:focus { outline: none; border-color: var(--gold); }
    textarea.form-control { min-height: 80px; resize: vertical; }

    @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .main { margin-left: 0; } }
    @media (max-width: 768px) { .filters { flex-direction: column; } .search-box { min-width: 100%; } .devedor-header { flex-direction: column; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo"><div class="logo-icon">A</div><div class="logo-text">ACERT<span>IVE</span></div></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="fila.html" class="nav-link"><i class="fas fa-headset"></i> Fila de Trabalho</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Gest√£o</div>
        <a href="devedores.html" class="nav-link active"><i class="fas fa-users"></i> Devedores</a>
        <a href="acordos.html" class="nav-link"><i class="fas fa-handshake"></i> Acordos</a>
        <a href="cobrancas.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Cobran√ßas</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Carteiras</div>
        <a href="credores.html" class="nav-link"><i class="fas fa-building"></i> Credores</a>
        <a href="importar.html" class="nav-link"><i class="fas fa-file-import"></i> Importar</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Sistema</div>
        <a href="relatorios.html" class="nav-link"><i class="fas fa-chart-bar"></i> Relat√≥rios</a>
        <a href="configuracoes.html" class="nav-link"><i class="fas fa-cog"></i> Configura√ß√µes</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-info"><div class="user-name" id="userName">Admin</div><div class="user-role" id="userRole">Administrador</div></div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="page-header">
      <div>
        <h1 class="page-title">Devedores</h1>
        <p class="page-subtitle">Gerencie todos os devedores e suas cobran√ßas</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="location.href='fila.html'"><i class="fas fa-headset"></i> Iniciar Trabalho</button>
      </div>
    </div>

    <div class="filters">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="busca" placeholder="Buscar por nome, CPF ou telefone..." oninput="filtrar()">
      </div>
      <select class="filter-select" id="filtroCredor" onchange="filtrar()"><option value="">Todos os credores</option></select>
      <select class="filter-select" id="filtroAtraso" onchange="filtrar()">
        <option value="">Qualquer atraso</option>
        <option value="0">Em dia</option>
        <option value="30">1-30 dias</option>
        <option value="60">31-60 dias</option>
        <option value="90">60+ dias</option>
      </select>
    </div>

    <div class="status-tabs">
      <button class="status-tab active" data-status="" onclick="filtrarStatus('')"><i class="fas fa-users"></i> Todos <span class="count" id="countTodos">0</span></button>
      <button class="status-tab" data-status="novo" onclick="filtrarStatus('novo')"><i class="fas fa-star"></i> Novos <span class="count" id="countNovo">0</span></button>
      <button class="status-tab" data-status="negociando" onclick="filtrarStatus('negociando')"><i class="fas fa-comments"></i> Negociando <span class="count" id="countNegociando">0</span></button>
      <button class="status-tab" data-status="acordo" onclick="filtrarStatus('acordo')"><i class="fas fa-handshake"></i> Acordo <span class="count" id="countAcordo">0</span></button>
      <button class="status-tab" data-status="sem_contato" onclick="filtrarStatus('sem_contato')"><i class="fas fa-phone-slash"></i> Sem Contato <span class="count" id="countSemContato">0</span></button>
      <button class="status-tab" data-status="recusou" onclick="filtrarStatus('recusou')"><i class="fas fa-times-circle"></i> Recusou <span class="count" id="countRecusou">0</span></button>
    </div>

    <div class="table-container">
      <table>
        <thead><tr><th>Devedor</th><th>Credor</th><th>Status</th><th>Atraso</th><th style="text-align:right">Valor Total</th></tr></thead>
        <tbody id="listaDevedores"><tr><td colspan="5"><div class="empty"><i class="fas fa-users"></i><p>Carregando devedores...</p></div></td></tr></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Detalhes -->
  <div class="modal-overlay" id="modalDetalhes">
    <div class="modal">
      <div class="modal-header">
        <h2><i class="fas fa-user"></i> <span id="modalNome">Devedor</span></h2>
        <button class="modal-close" onclick="fecharModal('modalDetalhes')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="devedor-header">
          <div class="devedor-header-avatar" id="modalAvatar">AB</div>
          <div class="devedor-header-info">
            <div class="devedor-header-name" id="modalNomeCompleto">Nome Completo</div>
            <div class="devedor-header-doc" id="modalDoc">CPF: 000.000.000-00</div>
            <div class="devedor-header-contacts">
              <div class="devedor-contact"><i class="fas fa-phone"></i><a href="#" id="modalTelefone">Ligar</a></div>
              <div class="devedor-contact"><i class="fab fa-whatsapp"></i><a href="#" id="modalWhatsapp" target="_blank">WhatsApp</a></div>
              <div class="devedor-contact"><i class="fas fa-envelope"></i><span id="modalEmail">email@email.com</span></div>
            </div>
          </div>
          <div class="devedor-header-status">
            <select class="devedor-status-select" id="modalStatus" onchange="alterarStatus()">
              <option value="novo">üÜï Novo</option>
              <option value="negociando">üìû Negociando</option>
              <option value="acordo">‚úÖ Acordo</option>
              <option value="quitado">üí∞ Quitado</option>
              <option value="sem_contato">üìµ Sem Contato</option>
              <option value="recusou">‚ùå Recusou</option>
              <option value="juridico">‚öñÔ∏è Jur√≠dico</option>
              <option value="incobravel">üíÄ Incobr√°vel</option>
            </select>
            <div class="devedor-total-label">D√≠vida Total</div>
            <div class="devedor-total-value" id="modalTotal">R$ 0,00</div>
          </div>
        </div>

        <div class="detail-tabs">
          <button class="detail-tab active" onclick="trocarTab('cobrancas')">Cobran√ßas</button>
          <button class="detail-tab" onclick="trocarTab('historico')">Hist√≥rico</button>
          <button class="detail-tab" onclick="trocarTab('acordo')">Novo Acordo</button>
        </div>

        <div class="tab-content active" id="tabCobrancas"><div id="listaCobrancasDevedor"></div></div>

        <div class="tab-content" id="tabHistorico">
          <div class="acionamento-form">
            <h4><i class="fas fa-plus-circle"></i> Registrar Acionamento</h4>
            <div class="acionamento-tipos">
              <button class="tipo-btn active" data-tipo="ligacao" onclick="selecionarTipo('ligacao')"><i class="fas fa-phone"></i> Liga√ß√£o</button>
              <button class="tipo-btn" data-tipo="whatsapp" onclick="selecionarTipo('whatsapp')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
              <button class="tipo-btn" data-tipo="email" onclick="selecionarTipo('email')"><i class="fas fa-envelope"></i> E-mail</button>
            </div>
            <div class="form-group">
              <label>Resultado</label>
              <select class="form-control" id="acionamentoResultado">
                <option value="atendeu">Atendeu</option>
                <option value="nao_atendeu">N√£o atendeu</option>
                <option value="ocupado">Ocupado</option>
                <option value="caixa_postal">Caixa postal</option>
                <option value="numero_errado">N√∫mero errado</option>
                <option value="promessa">Promessa de pagamento</option>
                <option value="negociando">Em negocia√ß√£o</option>
              </select>
            </div>
            <div class="form-group">
              <label>Observa√ß√£o</label>
              <textarea class="form-control" id="acionamentoObs" placeholder="Descreva o que foi conversado..."></textarea>
            </div>
            <button class="btn btn-primary btn-sm" onclick="registrarAcionamento()"><i class="fas fa-save"></i> Salvar Acionamento</button>
          </div>
          <div id="listaHistorico"></div>
        </div>

        <div class="tab-content" id="tabAcordo">
          <div class="acionamento-form">
            <h4><i class="fas fa-calculator"></i> Simular Acordo</h4>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
              <div class="form-group"><label>Valor Original</label><input type="text" class="form-control" id="acordoOriginal" readonly></div>
              <div class="form-group"><label>Multa (R$)</label><input type="text" class="form-control" id="acordoMulta" value="0,00" oninput="calcularAcordo()"></div>
              <div class="form-group"><label>Juros (R$)</label><input type="text" class="form-control" id="acordoJuros" value="0,00" oninput="calcularAcordo()"></div>
              <div class="form-group"><label>Honor√°rios (R$)</label><input type="text" class="form-control" id="acordoHonorarios" value="0,00" oninput="calcularAcordo()"></div>
              <div class="form-group"><label>Desconto (R$)</label><input type="text" class="form-control" id="acordoDesconto" value="0,00" oninput="calcularAcordo()"></div>
              <div class="form-group"><label>Parcelas</label>
                <select class="form-control" id="acordoParcelas" onchange="calcularAcordo()">
                  <option value="1">1x (√† vista)</option><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="10">10x</option><option value="12">12x</option><option value="24">24x</option>
                </select>
              </div>
            </div>
            <div style="background:var(--gold-glow);border:1px solid var(--gold);border-radius:12px;padding:20px;margin-top:16px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:var(--text-muted)">Valor Original:</span><span id="simOriginal">R$ 0,00</span></div>
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:var(--text-muted)">+ Multa/Juros/Honor√°rios:</span><span id="simAcrescimos">R$ 0,00</span></div>
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:var(--text-muted)">- Desconto:</span><span style="color:var(--green)" id="simDesconto">- R$ 0,00</span></div>
              <div style="display:flex;justify-content:space-between;padding-top:12px;border-top:1px dashed var(--border);"><span style="font-weight:700;">VALOR DO ACORDO:</span><span style="font-size:24px;font-weight:800;color:var(--gold)" id="simTotal">R$ 0,00</span></div>
              <div style="display:flex;justify-content:space-between;margin-top:8px;"><span style="color:var(--text-muted)">Parcelas:</span><span id="simParcelas">1x de R$ 0,00</span></div>
            </div>
            <div class="form-group" style="margin-top:16px;"><label>Primeiro Vencimento</label><input type="date" class="form-control" id="acordoVencimento"></div>
            <button class="btn btn-success" onclick="criarAcordo()" style="margin-top:16px;width:100%;"><i class="fas fa-handshake"></i> Criar Acordo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    let token = localStorage.getItem('token');
    if (!token) window.location.href = 'login.html';

    const H = () => ({ 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token });
    const fmtMoney = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
    const parseMoney = s => parseFloat((s || '0').replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const initials = n => (n || 'U').split(' ').map(p => p[0]).slice(0, 2).join('').toUpperCase();
    const formatarData = d => { if (!d) return '-'; const p = d.split('T')[0].split('-'); return `${p[2]}/${p[1]}/${p[0]}`; };
    const fecharModal = id => document.getElementById(id).classList.remove('show');
    const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };

    let devedores = [];
    let devedorAtual = null;
    let statusFiltro = '';
    let tipoAcionamento = 'ligacao';

    async function carregarCredores() {
      try {
        const r = await fetch(API + '/api/credores', { headers: H() });
        const d = await r.json();
        const credores = d.success ? d.data : (Array.isArray(d) ? d : []);
        document.getElementById('filtroCredor').innerHTML = '<option value="">Todos os credores</option>' + credores.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
      } catch (e) {}
    }

    async function carregarDevedores() {
      try {
        const r = await fetch(API + '/api/clientes?limit=500', { headers: H() });
        const d = await r.json();
        const clientes = d.success ? d.data : (Array.isArray(d) ? d : []);
        const rCob = await fetch(API + '/api/cobrancas?limit=1000', { headers: H() });
        const dCob = await rCob.json();
        const cobrancas = dCob.data || [];
        const cobPorCliente = {};
        cobrancas.forEach(c => { if (!cobPorCliente[c.cliente_id]) cobPorCliente[c.cliente_id] = []; cobPorCliente[c.cliente_id].push(c); });

        const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
        devedores = clientes.map(c => {
          const cobs = cobPorCliente[c.id] || [];
          const pendentes = cobs.filter(x => x.status !== 'pago' && x.status !== 'acordo');
          const total = pendentes.reduce((s, x) => s + (parseFloat(x.valor || x.valor_original) || 0), 0);
          let maiorAtraso = 0;
          pendentes.forEach(x => {
            const venc = new Date((x.vencimento || x.data_vencimento || '').split('T')[0] + 'T12:00:00');
            const diff = Math.floor((hoje - venc) / (1000 * 60 * 60 * 24));
            if (diff > maiorAtraso) maiorAtraso = diff;
          });
          return { ...c, cobrancas: cobs, pendentes, total, maiorAtraso, status: c.status_cobranca || 'novo' };
        }).filter(d => d.cobrancas.length > 0);

        atualizarContadores();
        renderizar();
      } catch (e) {
        console.error('Erro:', e);
        document.getElementById('listaDevedores').innerHTML = `<tr><td colspan="5"><div class="empty"><i class="fas fa-exclamation-circle"></i><p>Erro ao carregar</p></div></td></tr>`;
      }
    }

    function atualizarContadores() {
      document.getElementById('countTodos').textContent = devedores.length;
      document.getElementById('countNovo').textContent = devedores.filter(d => d.status === 'novo').length;
      document.getElementById('countNegociando').textContent = devedores.filter(d => d.status === 'negociando').length;
      document.getElementById('countAcordo').textContent = devedores.filter(d => d.status === 'acordo').length;
      document.getElementById('countSemContato').textContent = devedores.filter(d => d.status === 'sem_contato').length;
      document.getElementById('countRecusou').textContent = devedores.filter(d => d.status === 'recusou').length;
    }

    function filtrarStatus(status) {
      statusFiltro = status;
      document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.status-tab[data-status="${status}"]`).classList.add('active');
      renderizar();
    }

    function filtrar() { renderizar(); }

    function renderizar() {
      const busca = document.getElementById('busca').value.toLowerCase();
      const credor = document.getElementById('filtroCredor').value;
      const atraso = document.getElementById('filtroAtraso').value;
      let filtrados = devedores.filter(d => {
        if (statusFiltro && d.status !== statusFiltro) return false;
        if (busca && !d.nome?.toLowerCase().includes(busca) && !d.cpf_cnpj?.includes(busca) && !d.telefone?.includes(busca)) return false;
        if (credor && !d.cobrancas.some(c => c.credor_id === credor)) return false;
        if (atraso === '0' && d.maiorAtraso > 0) return false;
        if (atraso === '30' && (d.maiorAtraso <= 0 || d.maiorAtraso > 30)) return false;
        if (atraso === '60' && (d.maiorAtraso <= 30 || d.maiorAtraso > 60)) return false;
        if (atraso === '90' && d.maiorAtraso <= 60) return false;
        return true;
      });

      const container = document.getElementById('listaDevedores');
      if (!filtrados.length) { container.innerHTML = `<tr><td colspan="5"><div class="empty"><i class="fas fa-users"></i><p>Nenhum devedor encontrado</p></div></td></tr>`; return; }

      container.innerHTML = filtrados.map(d => {
        let atrasoClass = 'ok', atrasoText = 'Em dia';
        if (d.maiorAtraso > 60) { atrasoClass = 'grave'; atrasoText = d.maiorAtraso + 'd'; }
        else if (d.maiorAtraso > 30) { atrasoClass = 'moderado'; atrasoText = d.maiorAtraso + 'd'; }
        else if (d.maiorAtraso > 0) { atrasoClass = 'leve'; atrasoText = d.maiorAtraso + 'd'; }
        const credorNome = d.cobrancas[0]?.credor_nome || '-';
        const statusMap = { 'novo': 'Novo', 'negociando': 'Negociando', 'acordo': 'Acordo', 'quitado': 'Quitado', 'sem_contato': 'Sem Contato', 'recusou': 'Recusou', 'juridico': 'Jur√≠dico', 'incobravel': 'Incobr√°vel' };
        return `<tr onclick="abrirDetalhes('${d.id}')">
          <td><div class="devedor-cell"><div class="devedor-avatar">${initials(d.nome)}</div><div><div class="devedor-name">${d.nome || 'Sem nome'}</div><div class="devedor-doc">${d.cpf_cnpj || 'Sem documento'}</div></div></div></td>
          <td>${credorNome}</td>
          <td><span class="status-badge ${d.status}">${statusMap[d.status] || d.status}</span></td>
          <td><span class="atraso-badge ${atrasoClass}">${atrasoText}</span></td>
          <td class="valor-cell"><div class="valor-total">${fmtMoney(d.total)}</div><div class="valor-qtd">${d.pendentes.length} cobran√ßa(s)</div></td>
        </tr>`;
      }).join('');
    }

    function abrirDetalhes(id) {
      devedorAtual = devedores.find(d => d.id === id);
      if (!devedorAtual) return;
      document.getElementById('modalNome').textContent = devedorAtual.nome;
      document.getElementById('modalAvatar').textContent = initials(devedorAtual.nome);
      document.getElementById('modalNomeCompleto').textContent = devedorAtual.nome;
      document.getElementById('modalDoc').textContent = devedorAtual.cpf_cnpj ? `CPF/CNPJ: ${devedorAtual.cpf_cnpj}` : 'Sem documento';
      document.getElementById('modalTelefone').textContent = devedorAtual.telefone || 'Sem telefone';
      document.getElementById('modalWhatsapp').href = devedorAtual.telefone ? `https://wa.me/55${devedorAtual.telefone.replace(/\D/g, '')}` : '#';
      document.getElementById('modalEmail').textContent = devedorAtual.email || 'Sem e-mail';
      document.getElementById('modalStatus').value = devedorAtual.status;
      document.getElementById('modalTotal').textContent = fmtMoney(devedorAtual.total);
      document.getElementById('listaCobrancasDevedor').innerHTML = devedorAtual.cobrancas.map(c => {
        const status = c.status === 'pago' ? 'Pago' : (c.status === 'acordo' ? 'Em Acordo' : 'Pendente');
        return `<div class="cobranca-card"><div class="cobranca-info"><h4>${c.descricao || 'Cobran√ßa'}</h4><p>${c.credor_nome || 'Sem credor'} ‚Ä¢ ${status}</p></div><div class="cobranca-valor"><div class="cobranca-valor-num">${fmtMoney(c.valor || c.valor_original)}</div><div class="cobranca-venc">Venc: ${formatarData(c.vencimento || c.data_vencimento)}</div></div></div>`;
      }).join('') || '<p style="color:var(--text-muted);text-align:center;padding:20px;">Nenhuma cobran√ßa</p>';
      document.getElementById('acordoOriginal').value = fmtMoney(devedorAtual.total);
      document.getElementById('simOriginal').textContent = fmtMoney(devedorAtual.total);
      const dataVenc = new Date(); dataVenc.setDate(dataVenc.getDate() + 7);
      document.getElementById('acordoVencimento').value = dataVenc.toISOString().split('T')[0];
      calcularAcordo();
      carregarHistorico();
      trocarTab('cobrancas');
      document.getElementById('modalDetalhes').classList.add('show');
    }

    function trocarTab(tab) {
      document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.detail-tab[onclick="trocarTab('${tab}')"]`).classList.add('active');
      document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    }

    function selecionarTipo(tipo) {
      tipoAcionamento = tipo;
      document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tipo-btn[data-tipo="${tipo}"]`).classList.add('active');
    }

    async function registrarAcionamento() {
      if (!devedorAtual) return;
      const historico = JSON.parse(localStorage.getItem('historico_' + devedorAtual.id) || '[]');
      historico.unshift({ tipo: tipoAcionamento, resultado: document.getElementById('acionamentoResultado').value, obs: document.getElementById('acionamentoObs').value, data: new Date().toISOString(), usuario: JSON.parse(localStorage.getItem('user') || '{}').nome || 'Usu√°rio' });
      localStorage.setItem('historico_' + devedorAtual.id, JSON.stringify(historico));
      document.getElementById('acionamentoObs').value = '';
      alert('Acionamento registrado!');
      carregarHistorico();
    }

    function carregarHistorico() {
      if (!devedorAtual) return;
      const historico = JSON.parse(localStorage.getItem('historico_' + devedorAtual.id) || '[]');
      const container = document.getElementById('listaHistorico');
      if (!historico.length) { container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">Nenhum hist√≥rico</p>'; return; }
      const iconMap = { 'ligacao': { icon: 'fas fa-phone', class: 'ligacao' }, 'whatsapp': { icon: 'fab fa-whatsapp', class: 'whatsapp' }, 'email': { icon: 'fas fa-envelope', class: 'email' } };
      container.innerHTML = historico.map(h => {
        const i = iconMap[h.tipo] || iconMap['ligacao'];
        const data = new Date(h.data);
        return `<div class="historico-item"><div class="historico-icon ${i.class}"><i class="${i.icon}"></i></div><div class="historico-content"><div class="historico-title">${h.tipo === 'ligacao' ? 'Liga√ß√£o' : h.tipo === 'whatsapp' ? 'WhatsApp' : 'E-mail'}</div><div class="historico-desc">${h.resultado}${h.obs ? ' - ' + h.obs : ''}</div></div><div class="historico-time">${data.toLocaleDateString('pt-BR')} ${data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div></div>`;
      }).join('');
    }

    async function alterarStatus() {
      if (!devedorAtual) return;
      const novoStatus = document.getElementById('modalStatus').value;
      try {
        await fetch(API + '/api/clientes/' + devedorAtual.id, { method: 'PUT', headers: H(), body: JSON.stringify({ status_cobranca: novoStatus }) });
        devedorAtual.status = novoStatus;
        const idx = devedores.findIndex(d => d.id === devedorAtual.id);
        if (idx >= 0) devedores[idx].status = novoStatus;
        atualizarContadores();
        renderizar();
      } catch (e) { console.error('Erro:', e); }
    }

    function calcularAcordo() {
      const original = devedorAtual ? devedorAtual.total : 0;
      const multa = parseMoney(document.getElementById('acordoMulta').value);
      const juros = parseMoney(document.getElementById('acordoJuros').value);
      const honorarios = parseMoney(document.getElementById('acordoHonorarios').value);
      const desconto = parseMoney(document.getElementById('acordoDesconto').value);
      const parcelas = parseInt(document.getElementById('acordoParcelas').value) || 1;
      const acrescimos = multa + juros + honorarios;
      const total = original + acrescimos - desconto;
      const valorParcela = total / parcelas;
      document.getElementById('simOriginal').textContent = fmtMoney(original);
      document.getElementById('simAcrescimos').textContent = fmtMoney(acrescimos);
      document.getElementById('simDesconto').textContent = '- ' + fmtMoney(desconto);
      document.getElementById('simTotal').textContent = fmtMoney(total);
      document.getElementById('simParcelas').textContent = `${parcelas}x de ${fmtMoney(valorParcela)}`;
    }

    async function criarAcordo() {
      if (!devedorAtual) return;
      const original = devedorAtual.total;
      const multa = parseMoney(document.getElementById('acordoMulta').value);
      const juros = parseMoney(document.getElementById('acordoJuros').value);
      const honorarios = parseMoney(document.getElementById('acordoHonorarios').value);
      const desconto = parseMoney(document.getElementById('acordoDesconto').value);
      const parcelas = parseInt(document.getElementById('acordoParcelas').value) || 1;
      const vencimento = document.getElementById('acordoVencimento').value;
      const total = original + multa + juros + honorarios - desconto;
      try {
        const r = await fetch(API + '/api/acordos', { method: 'POST', headers: H(), body: JSON.stringify({ cliente_id: devedorAtual.id, cobrancas_ids: devedorAtual.pendentes.map(c => c.id), valor_original: original, multa, juros, honorarios, desconto, valor_acordo: total, parcelas, primeiro_vencimento: vencimento }) });
        const d = await r.json();
        if (d.success) { alert('Acordo criado com sucesso!'); document.getElementById('modalStatus').value = 'acordo'; await alterarStatus(); fecharModal('modalDetalhes'); carregarDevedores(); }
        else { alert('Erro: ' + (d.message || 'Erro ao criar acordo')); }
      } catch (e) { console.error('Erro:', e); alert('Erro ao criar acordo'); }
    }

    async function carregarUsuario() {
      try {
        const u = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = u.nome || 'Usu√°rio';
        document.getElementById('userRole').textContent = u.nivel === 'admin' ? 'Administrador' : 'Operador';
        document.getElementById('userAvatar').textContent = initials(u.nome);
      } catch (e) {}
    }

    document.querySelectorAll('.modal-overlay').forEach(m => { m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); }); });
    carregarUsuario();
    carregarCredores();
    carregarDevedores();
  </script>
</body>
</html>